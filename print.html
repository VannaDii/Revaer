<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Revaer Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "rust";
            const default_dark_theme = "coal";
            window.path_to_searchindex_js = "searchindex-7ff0cd5f.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-1374a622.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Revaer Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/VannaDii/revaer" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="revaer"><a class="header" href="#revaer">Revaer</a></h1>
<blockquote>
<p>Centralized torrent orchestration with hot-reloadable configuration, consistent CLI/API surfaces, and observability-first defaults.</p>
</blockquote>
<p>Revaer is a Rust workspace that coordinates torrent ingestion, filesystem operations, and operational guardrails from a PostgreSQL-backed control plane. The <code>revaer-app</code> binary composes focused crates covering the API, CLI, filesystem pipeline, telemetry, and libtorrent adapter.</p>
<h2 id="what-youll-find-here"><a class="header" href="#what-youll-find-here">What You’ll Find Here</a></h2>
<ul>
<li><strong>Roadmap &amp; Specs</strong> – Track the current Phase One scope and remaining delivery deltas.</li>
<li><strong>Platform Interfaces</strong> – Configuration schema, HTTP API endpoints, and CLI command reference that match the current codebase.</li>
<li><strong>Operational Guides</strong> – Runbook, release checklist, and setup flows for operators.</li>
<li><strong>Architecture Decisions</strong> – ADRs documenting trade-offs across configuration, security, and engine integration.</li>
<li><strong>API Reference</strong> – Generated OpenAPI description and usage guidance for the control plane surface.</li>
</ul>
<p>Use the sidebar navigation (or <code>[</code> and <code>]</code> shortcuts) to explore individual topics. Most pages include headings that double as tags for machine-readable manifests generated by the docs indexer.</p>
<h2 id="contributing-updates"><a class="header" href="#contributing-updates">Contributing Updates</a></h2>
<p>Documentation lives next to the code. Add or edit Markdown files under <code>docs/</code>, then run:</p>
<pre><code class="language-bash">just docs
</code></pre>
<p>This builds the mdBook site and refreshes the LLM manifests that power the documentation search experience.</p>
<h2 id="llm-manifests"><a class="header" href="#llm-manifests">LLM Manifests</a></h2>
<p>For ChatGPT and other LLM-based tooling, fetch <a href="/llms.txt"><code>/llms.txt</code></a> and the JSON manifests under <code>/llm/</code> (<a href="/llm/schema.json"><code>schema.json</code></a>, <a href="/llm/manifest.json"><code>manifest.json</code></a>, <a href="/llm/summaries.json"><code>summaries.json</code></a>) used by the documentation search experience.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="phase-one-roadmap"><a class="header" href="#phase-one-roadmap">Phase One Roadmap</a></h1>
<p><em>Last updated: 2025-11-27</em></p>
<p>This document captures the current delta between the Phase One objective and the existing codebase. It should be kept in sync as work progresses across the eight workstreams.</p>
<h2 id="snapshot"><a class="header" href="#snapshot">Snapshot</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Workstream</th><th>Current State</th><th>Key Gaps</th><th>Immediate Actions</th></tr>
</thead>
<tbody>
<tr><td>Control Plane &amp; Setup</td><td>Postgres schema, ConfigService watcher, setup CLI/API, immutable-key guard, history logging; loopback enforcement + RFC7807 pointers live</td><td>Engine hot-reload not yet exercising throttles; setup token lifecycle/error telemetry still thin</td><td>Add watcher-driven throttle tests, expand setup diagnostics and rate-limit guardrails</td></tr>
<tr><td>Torrent Domain &amp; Adapter</td><td>Native libtorrent FFI (cxx) restored and default-enabled; session worker with alert pump/resume store, throttles, selection, and degraded health surfaced via event bus; stub path retained only when the feature is disabled</td><td>Native integration suite still opt-in and not exercised in CI; alert/rate-limit regression coverage is thin; need broader validation of resume reconciliation and failure handling</td><td>Add REVAER_NATIVE_IT matrix in CI (with Docker host) to run native tests; deepen alert/rate-limit/resume validation and harden failure handling</td></tr>
<tr><td>File Selection &amp; FsOps</td><td>Idempotent FsOps pipeline extracts zip payloads, flattens single directories, enforces allow lists, records <code>.revaer.meta</code>, and applies move/copy/hardlink transfers with chmod/chown/umask handling</td><td>Extraction currently limited to zip archives, PAR2 stage still absent, cleanup rules lack checksum awareness, pipeline assumes Unix tooling for ownership changes</td><td>Expand extractor matrix (7z/tar), add PAR2 verification, surface non-Unix fallbacks, and extend cleanup/telemetry coverage</td></tr>
<tr><td>Public HTTP API &amp; SSE</td><td>Admin setup/settings/torrent CRUD, SSE stream, metrics stub, OpenAPI generator, <code>/api/v2/*</code> qB façade (auth stub, version, torrents info/add/pause/resume/delete, transfer limits, incremental <code>rid</code> sync, basic removal tracking)</td><td><code>/v1/torrents/*</code> pagination/filter matrix still partial, qB façade lacks authenticated sessions, differential removal events, rename/category endpoints; SSE replay still missing Last-Event-ID coverage</td><td>Finish pagination/filter story, tighten façade auth/session handling, surface removals/categories in incremental sync, and expand SSE regression tests</td></tr>
<tr><td>CLI Parity</td><td>Supports setup start/complete, settings patch, admin torrent add/remove (magnet-aware), status</td><td>Missing <code>select</code>, <code>action</code>, <code>ls</code>, <code>status</code> detail view, <code>tail</code> SSE client, richer validation</td><td>Extend CLI command surface to mirror API, add reconnecting SSE tailer, flesh out filtering and exit-code contract</td></tr>
<tr><td>Security &amp; Observability</td><td>API key storage hashed, tracing initialized, metrics registry struct</td><td>No per-key rate limits, no X-RateLimit headers, magnet/body bounds missing, tracing not propagated to engine/fsops, metrics unused</td><td>Introduce token-bucket middleware, enforce payload bounds, propagate spans through orchestrator/fsops, export Prometheus counters</td></tr>
<tr><td>CI &amp; Packaging</td><td>GitHub Actions cover fmt/lint/deny/audit/tests/cov via <code>just ci</code>; libtorrent deps installed on runners; Dockerfile builds non-root image with bundled libtorrent and HEALTHCHECK; docs workflow publishes mdBook</td><td>Native libtorrent tests not in default matrix; provenance/signing absent; rootfs not read-only; no cross-arch artifacts or enforced image scan in CI</td><td>Add matrix job with REVAER_NATIVE_IT=1 + Docker host, wire provenance/signing and image scan, harden container runtime (read-only root, drop caps), and add cross-arch build artifacts</td></tr>
<tr><td>Operational End-to-End</td><td>Bootstrap skeleton and event bus exist</td><td>Torrent download, fs pipeline, restart resume, throttling, degraded health scenarios unimplemented</td><td>Sequence implementation/testing to satisfy runbook once engine/fsops/API parity are in place</td></tr>
</tbody>
</table>
</div>
<h2 id="remaining-scope-specification"><a class="header" href="#remaining-scope-specification">Remaining Scope Specification</a></h2>
<h3 id="1-torrent-engine-integration"><a class="header" href="#1-torrent-engine-integration">1. Torrent Engine Integration</a></h3>
<ul>
<li>Harden the native libtorrent session: keep the stub only for feature-off builds while ensuring the default path drives the real adapter for add/pause/resume/remove, sequential toggles, rate limits, selection updates, reannounce, and force-recheck.</li>
<li>Validate persisted fast-resume payloads, priorities, target directories, and sequential flags against the live session on startup; continue emitting reconciliation events when divergence is detected.</li>
<li>Translate libtorrent alerts into EventBus messages (<code>FilesDiscovered</code>, <code>Progress</code>, <code>StateChanged</code>, <code>Completed</code>, <code>Failure</code>) while respecting the ≤10 Hz per-torrent coalescing rule; recover from alert polling failures by degrading health and attempting bounded restarts.</li>
<li>Ensure global and per-torrent rate caps driven by <code>engine_profile</code> updates are enforced by libtorrent within two seconds, with audit logs surfaced when caps change.</li>
<li>Extend the feature-gated integration suite to execute against the native libtorrent build (resume restore, rate-limit enforcement, alert mapping) in addition to the in-process stub.</li>
</ul>
<h3 id="2-file-selection--fsops-pipeline"><a class="header" href="#2-file-selection--fsops-pipeline">2. File Selection &amp; FsOps Pipeline</a></h3>
<ul>
<li>Keep include/exclude glob logic aligned with torrent selection so priority updates continue to reflect operator intent, including the <code>@skip_fluff</code> preset.</li>
<li>Extend the FsOps pipeline to additional archive formats (7z/tar), introduce the PAR2 verification/repair stage, and surface checksum metadata alongside the recorded <code>.revaer.meta</code> entries.</li>
<li>Add non-Unix fallbacks or clear operator guidance when ownership/umask directives cannot be honoured, and surface the condition via events and <code>/health/full</code>.</li>
<li>Harden dependency detection so missing extractor binaries trigger guarded degradation with actionable telemetry, then clear automatically once remediation succeeds.</li>
<li>Broaden integration coverage to include error paths (permission denied, unsupported archive) and restart scenarios that reuse persisted metadata, capturing metrics snapshots for each stage.</li>
</ul>
<h3 id="3-public-http-api--sse"><a class="header" href="#3-public-http-api--sse">3. Public HTTP API &amp; SSE</a></h3>
<ul>
<li>Round out <code>/v1/torrents</code> with cursor pagination, rich filtering (state, tracker, extension), and stabilise reannounce/recheck/sequential toggles with regression tests.</li>
<li>Keep Problem+JSON responses consistent (including JSON Pointer metadata) and mirror them in CLI/user-facing tooling.</li>
<li>Enhance SSE with Last-Event-ID replay, duplicate suppression, and resiliency tests covering torrent + FsOps event fan-out.</li>
<li>Evolve the qB façade: tighten the cookie/session model, surface removals/categories/tags in incremental sync, and expose rename/reannounce operations.</li>
<li>Expand health reporting to <code>/health/full</code>, document façade coverage in OpenAPI/mdBook, and add integration tests that exercise pagination, SSE replay, and façade flows end-to-end.</li>
</ul>
<h3 id="4-cli-parity"><a class="header" href="#4-cli-parity">4. CLI Parity</a></h3>
<ul>
<li>Add commands <code>revaer ls</code>, <code>status</code>, <code>select</code>, <code>action</code>, and <code>tail</code>, mirroring API filters, selection arguments (include/exclude/skip-fluff), sequential toggles, and data deletion flags.</li>
<li>Implement an SSE tailer that reconnects on failure, honors Last-Event-ID, and avoids duplicate terminal output.</li>
<li>Standardize exit codes (0 success, 2 validation, &gt;2 runtime failures) and surface RFC7807 payloads, including pointer metadata, in human-readable CLI output.</li>
<li>Provide CLI integration tests that run against the API fixture stack, covering filter combinations, sequential toggles, and tail reconnection behaviour.</li>
</ul>
<h3 id="5-security--observability"><a class="header" href="#5-security--observability">5. Security &amp; Observability</a></h3>
<ul>
<li>Introduce API key lifecycle endpoints (issue, rotate, revoke) with hashed-at-rest storage, returning secrets only once; enforce per-key token-bucket rate limiting and include <code>X-RateLimit-*</code> headers.</li>
<li>Harden inputs by bounding magnet length, multipart size, filter glob counts, and header values; return Problem+JSON validation errors without panics for malformed requests.</li>
<li>Propagate tracing spans (request IDs) through the API, engine, and FsOps layers; ensure metrics cover HTTP status, event flow, queue depth, libtorrent transfer, and FsOps step durations, exposed via <code>/metrics</code>.</li>
<li>Reflect degraded health when tools are missing, engine sessions fault, or queue depth exceeds thresholds; emit corresponding <code>SettingsChanged</code> and <code>HealthChanged</code> events.</li>
<li>Document operational expectations for rate limiting, key rotation, and observability dashboards.</li>
</ul>
<h3 id="6-ci--packaging"><a class="header" href="#6-ci--packaging">6. CI &amp; Packaging</a></h3>
<ul>
<li>Keep GitHub Actions green across fmt/lint/deny/audit/tests/cov and add a matrix leg that runs the native libtorrent suite (REVAER_NATIVE_IT=1 with Docker host wiring).</li>
<li>Enforce an environment-access lint that fails CI if <code>std::env</code> reads occur outside the composition root (excluding <code>DATABASE_URL</code>).</li>
<li>Harden the container: retain non-root user, switch to read-only rootfs with explicit writable mounts, and gate builds with image scans and provenance/signing.</li>
<li>Produce cross-arch artifacts (x86_64/aarch64) and publish digests alongside build outputs and release notes.</li>
</ul>
<h3 id="7-operational-runbook-automation"><a class="header" href="#7-operational-runbook-automation">7. Operational Runbook Automation</a></h3>
<ul>
<li>Author a script to execute the full phase objective on both x86_64 and aarch64: bootstrap using <code>DATABASE_URL</code>, complete setup token flow, add a magnet, monitor <code>FilesDiscovered</code>/<code>Progress</code>/<code>Completed</code>, run FsOps, simulate crash/restart with fast-resume recovery, adjust throttles, and validate degraded health when extractors are absent.</li>
<li>Capture assertions and logs for each phase, producing artifacts suitable for runbook review and CI retention; ensure failures mark the engine or pipeline health accordingly.</li>
<li>Include cleanup routines to return environments to a reusable state while retaining diagnostic logs.</li>
</ul>
<h3 id="8-documentation--final-polish"><a class="header" href="#8-documentation--final-polish">8. Documentation &amp; Final Polish</a></h3>
<ul>
<li>Update <code>docs/phase-one-roadmap.md</code> continuously and add ADRs covering engine architecture, FsOps design, API/CLI contracts, and security posture.</li>
<li>Regenerate <code>docs/api/openapi.json</code> alongside illustrative request/response examples for new endpoints.</li>
<li>Extend user-facing guides for CLI usage, health/metrics references, and operational setup covering API keys, rate limits, and degraded-mode recovery.</li>
<li>Provide a final Phase One release checklist that ties documentation, runbook, and CI artifacts together.</li>
</ul>
<h2 id="next-steps-tracking"><a class="header" href="#next-steps-tracking">Next Steps Tracking</a></h2>
<ol>
<li>Land setup/network hardening and control-plane polish.</li>
<li>Keep the native libtorrent session as the default, expand coverage (native CI leg, alert/rate-limit/resume validation), and preserve the stub only for feature-off builds.</li>
<li>Implement FsOps pipeline with allow-listed execution and metadata.</li>
<li>Expose <code>/v1/*</code> APIs + CLI parity and reinforce security/observability.</li>
<li>Stand up CI, packaging, and full runbook validation.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="phase-one-remaining-engineering-specification"><a class="header" href="#phase-one-remaining-engineering-specification">Phase One Remaining Engineering Specification</a></h1>
<h2 id="objectives"><a class="header" href="#objectives">Objectives</a></h2>
<ul>
<li>Deliver a production-ready public interface (HTTP API, SSE, CLI) for torrent orchestration.</li>
<li>Ship FsOps-backed artefacts through API, CLI, telemetry, and documentation with demonstrable reliability.</li>
<li>Produce release artefacts (containers, binaries, documentation) that satisfy existing security, observability, and quality gates.</li>
</ul>
<h2 id="scope-overview"><a class="header" href="#scope-overview">Scope Overview</a></h2>
<ol>
<li>
<p><strong>Public HTTP API &amp; SSE Enhancements</strong></p>
<ul>
<li><code>/v1/torrents</code> CRUD-style endpoints with cursor pagination, filtering, torrent actions, file selection updates, rate adjustments, and Problem+JSON responses.</li>
<li>SSE stream upgrades: Last-Event-ID replay, subscription filters, duplicate suppression, jitter-tolerant reconnect logic.</li>
<li><code>/health/full</code> exposing engine/FsOps/config readiness, dependency metrics, and revision metadata.</li>
<li>Regenerated OpenAPI (JSON + examples) reflecting the full public surface.</li>
</ul>
</li>
<li>
<p><strong>CLI Parity</strong></p>
<ul>
<li>Commands covering list/status/select/action/tail flows with shared filtering + pagination options.</li>
<li>SSE-backed <code>tail</code> command with Last-Event-ID resume, dedupe, and retry semantics aligned with the API.</li>
<li>Problem+JSON error output, structured exit codes (<code>0</code> success, <code>2</code> validation, <code>&gt;2</code> runtime failures).</li>
</ul>
</li>
<li>
<p><strong>Packaging &amp; Documentation</strong></p>
<ul>
<li>Release-ready Docker image (non-root, readonly FS, volumes, healthcheck) bundling API server + docs.</li>
<li>Provenance-signed binaries for supported architectures, plus GitHub Actions workflows for build, docker, msrv, and coverage gates.</li>
<li>Updated ADRs, runbook, user guides, OpenAPI artefacts, and release checklist referencing the telemetry and security posture.</li>
<li>Documentation of new metrics/traces/guardrails (config watcher latency, FsOps events, API counters).</li>
</ul>
</li>
</ol>
<h2 id="security--observability-requirements-cross-cutting"><a class="header" href="#security--observability-requirements-cross-cutting">Security &amp; Observability Requirements (Cross-Cutting)</a></h2>
<ul>
<li>All new API routes enforce API-key authentication with per-key rate limiting and guard-rail metrics.</li>
<li>Problem+JSON responses are mandatory; eliminate <code>unwrap</code>/panic paths and include <code>invalid_params</code> pointers on validation failure.</li>
<li>Trace propagation from API → engine → FsOps; CLI should emit/propagate TraceId when available.</li>
<li>Metrics: extend existing Prometheus registry with route labels, FsOps step counters, config watcher latency/failure gauges, and rate-limiter guardrails.</li>
<li>Health degradation events (<code>Event::HealthChanged</code>) must accompany any new guard-rail/latency breach or pipeline failure.</li>
<li>CLI commands should mask secrets in logs and optionally emit telemetry when configured (<code>REVAER_TELEMETRY_ENDPOINT</code>).</li>
</ul>
<h2 id="detailed-work-breakdown"><a class="header" href="#detailed-work-breakdown">Detailed Work Breakdown</a></h2>
<h3 id="1-public-api--sse"><a class="header" href="#1-public-api--sse">1. Public API &amp; SSE</a></h3>
<p><strong>Design Considerations</strong></p>
<ul>
<li>Introduce DTO module (<code>api::models</code>) for request/response structs to share with the CLI.</li>
<li>Cursor pagination: encode UUID/timestamp as opaque cursor in <code>next</code> token; align Last-Event-ID semantics with event stream IDs.</li>
<li>Filtering: support state, tracker, extension, tags, and name substring; guard invalid combinations with Problem+JSON.</li>
<li>SSE filtering: permit query parameters for torrent subset, replays based on event type/state.</li>
</ul>
<p><strong>Implementation Tasks</strong></p>
<ul>
<li>Routes:
<ul>
<li><code>POST /v1/torrents</code> – magnet or .torrent upload (streamed, payload size guard).</li>
<li><code>GET /v1/torrents</code> – cursor pagination + filters.</li>
<li><code>GET /v1/torrents/{id}</code> – detail view with FsOps metadata.</li>
<li><code>POST /v1/torrents/{id}/select</code> – file selection update with validation.</li>
<li><code>POST /v1/torrents/{id}/action</code> – pause/resume/remove (with data), reannounce, recheck, sequential toggle, rate limits.</li>
</ul>
</li>
<li>SSE:
<ul>
<li>Accept <code>Last-Event-ID</code> header, deduplicate by event ID, filter streams by torrent ID/state.</li>
<li>Simulate jitter/disconnects in tests (<code>tokio::time::pause</code>, <code>transport::Stream</code>).</li>
</ul>
</li>
<li>Health endpoint:
<ul>
<li>Aggregate config watcher metrics (latency, failures), FsOps status, engine guardrails, revision hash.</li>
</ul>
</li>
<li>Problem+JSON mapping for all new errors with <code>invalid_params</code> pointer data.</li>
<li>OpenAPI:
<ul>
<li>Regenerate spec covering new endpoints, Problem responses, SSE details, and sample payloads.</li>
</ul>
</li>
<li>Testing:
<ul>
<li>Unit tests for filter parsing, DTO validation, Problem+JSON outputs.</li>
<li>Integration tests using <code>tower::Service</code> harness for each route.</li>
<li>SSE reconnection tests with simulated delays and Last-Event-ID resume.</li>
<li><code>/health/full</code> integration test verifying new fields and degraded scenarios.</li>
</ul>
</li>
</ul>
<h3 id="2-cli-parity"><a class="header" href="#2-cli-parity">2. CLI Parity</a></h3>
<p><strong>Design Considerations</strong></p>
<ul>
<li>Reuse DTOs from API models; consider shared crate/module for request structs and Problem+JSON parsing.</li>
<li>Introduce output formatting with optional JSON/pretty table modes.</li>
<li>Provide configuration via env vars and CLI flags; align defaults with API (e.g., <code>REVAER_API_URL</code>, <code>REVAER_API_KEY</code>).</li>
</ul>
<p><strong>Implementation Tasks</strong></p>
<ul>
<li>Commands:
<ul>
<li><code>revaer ls</code> – list torrents, support pagination (<code>--cursor</code>, <code>--limit</code>), filters (state/tracker/extension/tags).</li>
<li><code>revaer status &lt;id&gt;</code> – torrent detail view, optional follow mode.</li>
<li><code>revaer select &lt;id&gt;</code> – send selection rules from file/JSON (validate before submit).</li>
<li><code>revaer action &lt;id&gt;</code> – actions (<code>pause</code>, <code>resume</code>, <code>remove</code>, <code>remove-data</code>, <code>reannounce</code>, <code>recheck</code>, <code>sequential</code>, <code>rate</code>).</li>
<li><code>revaer tail</code> – SSE tail with Last-Event-ID persist (local file) and dedupe.</li>
</ul>
</li>
<li>Problem+JSON handling:
<ul>
<li>Standardised pretty printer summarising <code>title</code>, <code>detail</code>, <code>invalid_params</code>; respect exit codes.</li>
</ul>
</li>
<li>Telemetry:
<ul>
<li>Optional metrics emission (success/failure counters) when telemetry endpoint configured.</li>
</ul>
</li>
<li>Testing:
<ul>
<li>Integration tests using <code>httpmock</code> to assert HTTP interactions and exit codes.</li>
<li>SSE tail tests with mocked stream delivering duplicates/disconnects.</li>
<li>Snapshot tests for JSON outputs (ensuring deterministic fields).</li>
</ul>
</li>
</ul>
<h3 id="3-packaging--documentation"><a class="header" href="#3-packaging--documentation">3. Packaging &amp; Documentation</a></h3>
<p><strong>Design Considerations</strong></p>
<ul>
<li>Multi-stage Docker build: compile with Rust image, run on minimal base (distroless/alpine/ubi) with non-root user.</li>
<li>Healthcheck script hitting <code>/health/full</code> with timeout.</li>
<li>Release workflows should run on GitHub Actions with provenance metadata (supply-chain compliance).</li>
</ul>
<p><strong>Implementation Tasks</strong></p>
<ul>
<li>Dockerfile + <code>Makefile</code>/<code>just</code> target:
<ul>
<li>Build release binary, copy <code>docs/api/openapi.json</code>, set <code>/app</code> as workdir.</li>
<li>Define volumes for data/config, create user <code>revaer</code>, configure entrypoint.</li>
</ul>
</li>
<li>GitHub Actions (update <code>.github/workflows</code>):
<ul>
<li><code>build-release</code>: run <code>just build-release</code>, <code>just api-export</code>, attach binaries/docs.</li>
<li><code>docker</code>: build image, run <code>docker scan</code> (<code>trivy</code>/<code>grype</code>), and push on release tags.</li>
<li><code>msrv</code>: run <code>just fmt lint test</code> with pinned toolchain (documented in workflow).</li>
<li><code>cov</code>: ensure <code>just cov</code> gate passes (≥80% lines/functions).</li>
</ul>
</li>
<li>Documentation:
<ul>
<li>ADRs: update <code>003-libtorrent-session-runner</code>, add FsOps design ADR, API/CLI contract ADR, security posture update (API keys, rate limits).</li>
<li>Runbook: scripted scenario covering bootstrap → torrent add → FsOps pipeline → restart resume → rate throttle adjustments → degraded health simulation → recovery.</li>
<li>User guides: CLI usage, metrics/telemetry reference, operational setup (keys, rate limits, config watcher health).</li>
<li>OpenAPI: regenerate JSON, include sample Problem+JSON payloads and SSE description.</li>
<li>Release checklist: steps to run <code>just ci</code>, verify coverage, run docker scan, execute runbook, and tag release.</li>
</ul>
</li>
<li>Testing:
<ul>
<li>Validate Docker container runtime (healthcheck, volume mounts, non-root permissions).</li>
<li>Perform coverage review ensuring new tests bring line/function coverage ≥80%.</li>
<li>Execute runbook; capture logs/metrics and link in docs.</li>
</ul>
</li>
</ul>
<h2 id="cross-cutting-deliverables"><a class="header" href="#cross-cutting-deliverables">Cross-Cutting Deliverables</a></h2>
<ul>
<li>API key lifecycle (issue/rotate/revoke) extended with per-key rate limiting, recorded in telemetry and docs.</li>
<li>Config watcher telemetry integrated into <code>/health/full</code> and metrics registry.</li>
<li>CLI and API emit guard-rail telemetry on violations (loopback enforcement, FsOps errors, rate-limit breaches).</li>
<li>All new code paths covered by unit/integration tests; follow-up to update <code>just cov</code> gating.</li>
<li>Documentation kept up-to-date with implementation details and tested flows.</li>
</ul>
<h2 id="sequencing-suggested"><a class="header" href="#sequencing-suggested">Sequencing (Suggested)</a></h2>
<ol>
<li>Build API models and endpoints (foundation for CLI).</li>
<li>Implement SSE enhancements while adding API integration tests.</li>
<li>Extend CLI commands leveraging shared DTOs.</li>
<li>Embed telemetry (metrics/traces) throughout API/CLI/FsOps changes.</li>
<li>Stand up Docker build + CI workflows.</li>
<li>Update ADRs, runbook, user guides, OpenAPI, and release checklist.</li>
<li>Execute full QA cycle (coverage, docker scan, runbook, manual verification) and prepare for release tagging.</li>
</ol>
<h2 id="acceptance-criteria"><a class="header" href="#acceptance-criteria">Acceptance Criteria</a></h2>
<ul>
<li><code>just lint</code>, <code>just test</code>, <code>just cov</code> and full <code>just ci</code> pass locally and in CI.</li>
<li>Coverage (lines + functions) ≥ 80% across workspace.</li>
<li>Docker image passes security scan with zero unwaived high severity findings.</li>
<li>Runbook executed end-to-end; results referenced in documentation.</li>
<li>OpenAPI specification and CLI docs match implemented behaviour.</li>
<li>Release checklist completed with artefacts attached (binaries, Docker image, OpenAPI, docs).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="phase-one-runbook"><a class="header" href="#phase-one-runbook">Phase One Runbook</a></h1>
<p>This runbook exercises the end-to-end control plane, validating FsOps, telemetry, and guard rails.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li>Docker image <code>revaer:ci</code> (built via <code>just docker-build</code>) or a local <code>revaer-app</code> binary (<code>just build-release</code>).</li>
<li>PostgreSQL instance accessible to the application.</li>
<li>API key with a conservative rate limit (e.g., burst <code>5</code>, period <code>60s</code>).</li>
<li>CLI configured with <code>REVAER_API_URL</code>, <code>REVAER_API_KEY</code>, and optional <code>REVAER_TELEMETRY_ENDPOINT</code>.</li>
</ul>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<ol>
<li>
<p><strong>Bootstrap</strong></p>
<ul>
<li>Issue a setup token: <code>revaer setup start --issued-by runbook</code>.</li>
<li>Complete configuration with CLI secrets and directories: <code>revaer setup complete --instance runbook --bind 127.0.0.1 --resume-dir .server_root/resume --download-root .server_root/downloads --library-root .server_root/library --api-key-label runbook --passphrase &lt;pass&gt;</code>.</li>
<li>Capture the committed snapshot via <code>revaer config get --output table</code> and confirm <code>/health/full</code> returns <code>status=ok</code> with <code>guardrail_violations_total=0</code>.</li>
</ul>
</li>
<li>
<p><strong>Add Torrent &amp; Observe FsOps</strong></p>
<ul>
<li>Add a torrent: <code>revaer torrent add &lt;magnet&gt; --name runbook</code>.</li>
<li>Tail events: <code>revaer tail --event torrent_added,progress,state_changed --resume-file .server_root/revaer.tail</code>.</li>
<li>Verify FsOps emits <code>fsops_started</code>, <code>fsops_completed</code>, and Prometheus counters <code>fsops_steps_total</code> increase.</li>
</ul>
</li>
<li>
<p><strong>Restart &amp; Resume</strong></p>
<ul>
<li>Stop the application, restart it, and ensure the torrent catalog repopulates.</li>
<li>Confirm <code>SelectionReconciled</code> (if metadata diverges) and <code>HealthChanged</code> clears once resume succeeds.</li>
</ul>
</li>
<li>
<p><strong>Rate Limit Guard-Rail</strong></p>
<ul>
<li>Apply a tight API key limit (burst <code>1</code> / <code>per_seconds 60</code>) via <code>revaer config set --file rate-limit.json</code> (using a JSON patch that updates the relevant key).</li>
<li>Execute three rapid CLI calls (e.g., <code>revaer status &lt;id&gt;</code>). The third should exit with code <code>3</code>, displaying a <code>429</code> Problem+JSON response.</li>
<li>Inspect <code>/metrics</code> to verify <code>api_rate_limit_throttled_total</code> incremented and <code>/health/full</code> reflects <code>degraded=["api_rate_limit_guard"]</code>.</li>
</ul>
</li>
<li>
<p><strong>Recovery</strong></p>
<ul>
<li>Restore the API key limit to an acceptable value through another <code>revaer config set ...</code> invocation.</li>
<li>Re-run <code>revaer status &lt;id&gt;</code> to confirm success, <code>guardrail_violations_total</code> stops increasing, and <code>degraded</code> returns to <code>[]</code>.</li>
</ul>
</li>
<li>
<p><strong>FsOps Failure Simulation</strong></p>
<ul>
<li>Temporarily revoke write permissions on the library directory and re-run a completion.</li>
<li>Observe <code>fsops_failed</code> events, <code>HealthChanged</code> with <code>["fsops"]</code>, and guard-rail telemetry.</li>
<li>Restore permissions and confirm recovery events.</li>
</ul>
</li>
</ol>
<h2 id="verification-artifacts"><a class="header" href="#verification-artifacts">Verification Artifacts</a></h2>
<ul>
<li>Archive CLI telemetry emitted to <code>REVAER_TELEMETRY_ENDPOINT</code>.</li>
<li>Capture Prometheus scrapings (<code>/metrics</code>) before and after the run.</li>
<li>Record <code>/health/full</code> JSON snapshots for each phase.</li>
</ul>
<p>Successful completion of this runbook satisfies the operational validation gate defined in <code>AGENT.md</code>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="phase-one-release-checklist"><a class="header" href="#phase-one-release-checklist">Phase One Release Checklist</a></h1>
<ol>
<li>
<p><strong>Branch Hygiene</strong></p>
<ul>
<li>Ensure <code>main</code> is green (CI pipeline complete).</li>
<li>Review outstanding ADRs and docs for freshness.</li>
</ul>
</li>
<li>
<p><strong>Build &amp; Test</strong></p>
<ul>
<li><code>just ci</code></li>
<li><code>just build-release</code></li>
<li><code>just api-export</code></li>
</ul>
</li>
<li>
<p><strong>Artefact Verification</strong></p>
<ul>
<li>Binary: <code>target/release/revaer-app</code></li>
<li>Checksum: <code>sha256sum target/release/revaer-app</code></li>
<li>OpenAPI: <code>docs/api/openapi.json</code></li>
<li>Docker image: <code>just docker-build &amp;&amp; just docker-scan</code></li>
</ul>
</li>
<li>
<p><strong>Runbook Execution</strong></p>
<ul>
<li>Follow <code>docs/runbook.md</code></li>
<li>Archive CLI telemetry, <code>/metrics</code>, <code>/health/full</code> snapshots.</li>
</ul>
</li>
<li>
<p><strong>Documentation Refresh</strong></p>
<ul>
<li>Verify ADRs 005–007 reflect current design.</li>
<li>Update user guides (<code>docs/api/guides/*.md</code>) with any behavioural changes.</li>
</ul>
</li>
<li>
<p><strong>Tag &amp; Publish</strong></p>
<ul>
<li>Create annotated tag: <code>git tag -a vX.Y.Z -m "Phase One release"</code></li>
<li>Push tag: <code>git push origin vX.Y.Z</code></li>
<li>Attach artefacts generated by the <code>build-release</code> workflow.</li>
</ul>
</li>
<li>
<p><strong>Post-Release Monitoring</strong></p>
<ul>
<li>Watch rate-limit and guard-rail metrics.</li>
<li>Confirm <code>HealthChanged</code> events return to empty degraded set.</li>
<li>Validate automation telemetry for CLI success rates.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web-ui---phase-1"><a class="header" href="#web-ui---phase-1">Web UI - Phase 1</a></h1>
<p>Rust/Yew implementation plan for the Phase 1 torrent-only UI described in <code>REVAER_PHASE1_WEBUX_SPEC.md</code>. The goal is a responsive, touch-friendly surface that stays usable on 360px phones through 4K desktops while handling 50k+ torrents.</p>
<ul>
<li><strong>Pages:</strong> Dashboard, Torrents (list + detail), Search (shared list), Jobs/Post-processing, Settings, Logs. Indexers/Library stay hidden until Phase 2.</li>
<li><strong>Modes:</strong> Simple (default, trimmed controls) and Advanced (all filters, columns, bulk actions). Persisted in local storage without reload.</li>
<li><strong>Transport:</strong> REST for initial payloads; SSE for torrents, transfers, queue, jobs, and VPN state with backoff and jitter handling.</li>
</ul>
<h2 id="layout--breakpoints"><a class="header" href="#layout--breakpoints">Layout &amp; Breakpoints</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Name</th><th>Width</th><th>Default behaviors</th></tr>
</thead>
<tbody>
<tr><td>xs</td><td>0–479px</td><td>Card view for torrents, bottom sheet actions, stacked dashboard cards, hamburger navigation</td></tr>
<tr><td>sm</td><td>480–767px</td><td>Card view, two-column stats grid inside cards, slide-out navigation</td></tr>
<tr><td>md</td><td>768–1023px</td><td>Compact table (2–4 columns), tabbed detail view, 2-column dashboard grid</td></tr>
<tr><td>lg</td><td>1024–1439px</td><td>Full table, fixed sidebar with labels, 3-column dashboard grid</td></tr>
<tr><td>xl</td><td>1440–1919px</td><td>Adaptive column expansion, split-pane detail, 4-column dashboard grid</td></tr>
<tr><td>2xl</td><td>1920px+</td><td>Ultrawide-friendly table and split panes with max readable line lengths</td></tr>
</tbody>
</table>
</div>
<p>Table responsiveness: required columns (Name, Status, Progress, Speed up/down) stay pinned; ETA, Ratio, Size, Tags, Tracker, Path collapse into overflow or the detail drawer when space is constrained. Horizontal scroll must preserve keyboard navigation and roving tabindex.</p>
<p>Detail view: mobile renders tabs (<code>Files</code>, <code>Peers</code>, <code>Trackers</code>, <code>Log</code>, <code>Info</code>) with accordion file tree; desktop/laptop promotes a split grid showing file tree + metadata alongside peers/trackers/log simultaneously.</p>
<p>Virtualization: torrent list uses a windowed renderer (row-height aware with overscan) to keep 50k+ rows responsive; horizontal scroll remains keyboard-safe and selection stays highlighted for shortcut actions.</p>
<p>Auth: remote mode always requires an API key; prompt stores key in local storage, LAN anonymous mode is allowed only if backend advertises <code>allow_anonymous</code>. SSE currently appends the key via querystring (EventSource lacks header support); use TLS and avoid logging URLs in deployment. Live updates: SSE feeds torrent progress/rates plus dashboard rates/queue/VPN status; reconnect badge/overlay surfaces failures and retries.</p>
<p>Add flow: drop <code>.torrent</code> or paste magnet/URL with inline validation and error copy; invalid file types are rejected. Submissions post to <code>/v1/torrents</code>, surface toast feedback, and refresh the list.
Search &amp; filters: search box hits <code>/v1/torrents?search=</code> with optional <code>regex=true</code>; Regex toggle is inline in the toolbar and clears with Escape.
Live sync: SSE streams torrent progress/rates/state plus added/removed events to keep the list aligned without manual refresh.</p>
<h2 id="theming--tokens"><a class="header" href="#theming--tokens">Theming &amp; Tokens</a></h2>
<ul>
<li>Palette: Primary (<code>#265D81</code> base), Secondary (<code>#775A96</code>), Accent (<code>#258BD3</code>), Neutral 50–900, Success/Warning/Error scales; dark mode uses <code>background-dark #121417</code>, <code>surface-dark #1A1C20</code>, and text tokens.</li>
<li>Scale: Spacing 4/8/12/16/24/32; radius 4/8/12; elevation tiers flat/raised/floating; type scale xs–2xl.</li>
<li>States: focus ring 2px accent-500, hover/pressed darken by one tone; inputs/tables use border tokens.</li>
<li>Theme selection follows OS preference on first load and persists to local storage; user toggle is always available.</li>
</ul>
<h2 id="localization"><a class="header" href="#localization">Localization</a></h2>
<ul>
<li>Languages: ar, de, es, hi, it, jv, mr, pt, ta, tr, bn, en, fr, id, ja, ko, pa, ru, te, zh.</li>
<li>Bundles: JSON files at <code>crates/revaer-ui/i18n/*.json</code> with English fallback; dotted keys supported in <code>TranslationBundle</code>.</li>
<li>RTL: bidi layout, mirrored progress bars, reversed file tree, and RTL-aware table alignment. <code>meta.rtl</code> in bundles hints at direction and is applied on load.</li>
<li>Numbers/dates: browser locale by default with user override; binary units for rates/sizes.</li>
</ul>
<h2 id="accessibility--interaction"><a class="header" href="#accessibility--interaction">Accessibility &amp; Interaction</a></h2>
<ul>
<li>WCAG 2.1 AA: semantic markup, focus-visible rings, high-contrast dark mode, 40px touch targets on mobile, focus traps for drawers/modals.</li>
<li>Keyboard shortcuts (wired in demo UI): <code>/</code> search focus, <code>j/k</code> row move, <code>space</code> pause/resume, <code>delete</code> delete, <code>shift+delete</code> delete+data, <code>p</code> recheck. Selected row highlights; actions surface in a status banner.</li>
<li>Screen-reader flow follows DOM order (mobile collapse must not break navigation).</li>
<li>Confirmations: delete (“Remove torrent ‘&lt;name&gt;’? Files remain on disk”), delete+data (“Remove torrent and delete data? This cannot be undone.”), recheck prompt.</li>
<li>Mobile action bar: sticky bottom row for Pause/Resume/Delete/More on xs/sm; desktop retains row actions in-table.</li>
<li>SSE downtime overlay: shows last event timestamp, retry countdown (1s→30s with jitter), reason, and retry button; badge reflects reconnect state in top bar.</li>
</ul>
<h2 id="performance--resilience"><a class="header" href="#performance--resilience">Performance &amp; Resilience</a></h2>
<ul>
<li>Target: &lt;300ms initial UI load on modern mobile (cached assets), virtualization for all tables beyond 500 rows, main-thread budget aligned with 50k torrents.</li>
<li>SSE: event batching and reconnect backoff (1s→30s with jitter), Last-Event-ID awareness, overlay with retry countdown and last event timestamp on disconnect.</li>
<li>Offline/remote awareness: API key prompt stored locally; remote mode always enforces key even if backend advertises anonymous LAN support.</li>
</ul>
<h2 id="running-the-ui"><a class="header" href="#running-the-ui">Running the UI</a></h2>
<ul>
<li>Crate: <code>crates/revaer-ui</code> (Yew + wasm).</li>
<li>Commands: <code>rustup target add wasm32-unknown-unknown</code>, <code>cargo install trunk</code>, <code>trunk serve --open</code> to preview.</li>
<li>Assets: <code>static/style.css</code> holds palette/breakpoints; <code>index.html</code> + <code>Trunk.toml</code> bootstrap trunk.</li>
<li>Demo data lives in <code>components/dashboard.rs</code> and <code>components/torrents.rs</code>; swap in REST/SSE adapters to connect to the backend once available.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web-ui-flows--diagrams"><a class="header" href="#web-ui-flows--diagrams">Web UI Flows &amp; Diagrams</a></h1>
<p>Visual references for the Phase 1 UX: navigation, component wiring, SSE handling, and torrent lifecycle. Use these diagrams when extending the UI or adding tests.</p>
<h2 id="navigation-flow"><a class="header" href="#navigation-flow">Navigation Flow</a></h2>
<pre class="mermaid">flowchart LR
    Nav[Sidebar / Hamburger] --&gt; Dash[Dashboard]
    Nav --&gt; Torrents[Torrents]
    Nav --&gt; Search[Search]
    Nav --&gt; Jobs[Jobs / Post-processing]
    Nav --&gt; Settings[Settings]
    Nav --&gt; Logs[Logs]
    Torrents --&gt; Detail[Detail Drawer / Tabs]
    Detail --&gt; Files[Files]
    Detail --&gt; Peers[Peers]
    Detail --&gt; Trackers[Trackers]
    Detail --&gt; Events[Event Log]
    Detail --&gt; Info[Metadata]
</pre>

<h2 id="component-graph"><a class="header" href="#component-graph">Component Graph</a></h2>
<pre class="mermaid">flowchart TB
    app["App (RevaerApp)"]
    shell["AppShell: nav / theme / locale"]
    dash[DashboardPanel]
    table["TorrentView: virtualized list + filters"]
    add_panel[AddTorrentPanel]
    detail["Detail drawer / tabs"]
    api[API]

    app --&gt; shell
    shell --&gt; dash
    shell --&gt; table
    table --&gt; add_panel
    table --&gt; detail
    add_panel -- "POST /v1/torrents" --&gt; api
    detail -- "PATCH /v1/torrents/{id}" --&gt; api
</pre>

<h2 id="sse-event-flow"><a class="header" href="#sse-event-flow">SSE Event Flow</a></h2>
<pre class="mermaid">sequenceDiagram
    participant API as API/SSE
    participant Stream as EventStream
    participant State as UIState
    participant UI as Components

    API-&gt;&gt;Stream: SSE events (progress, state, queue, jobs, vpn)
    Stream-&gt;&gt;State: Batch apply with backoff + dedupe
    State-&gt;&gt;UI: Render updates (virtualized table, dashboard tiles, badges)
    UI-&gt;&gt;API: Last-Event-ID on reconnect with filters in SSE query
</pre>

<h2 id="torrent-lifecycle-ui-perspective"><a class="header" href="#torrent-lifecycle-ui-perspective">Torrent Lifecycle (UI Perspective)</a></h2>
<pre class="mermaid">stateDiagram-v2
    [*] --&gt; Added : magnet/upload
    Added --&gt; Queueing : server-side validation
    Queueing --&gt; Downloading
    Downloading --&gt; Checking : recheck or hash
    Downloading --&gt; Completed : 100% + seeding ready
    Checking --&gt; Downloading : if data matches
    Completed --&gt; FsOps : move/rename per policy
    FsOps --&gt; Seeding
    Seeding --&gt; Completed : ratio met / stop rules
    Completed --&gt; Removed : delete (+data optional)
</pre>

<h2 id="interaction-notes"><a class="header" href="#interaction-notes">Interaction Notes</a></h2>
<ul>
<li>SSE disconnect overlay shows last event timestamp, retry countdown (1s→30s exponential with jitter), and diagnostics (network mode, reason).</li>
<li>Table virtualization is mandatory beyond 500 rows; virtual scroll must preserve keyboard focus order and pinned columns.</li>
<li>Mobile detail view uses tabs (Files, Peers, Trackers, Log, Info); desktop uses split panes so file tree + metadata stay visible together at xl+.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configuration-surface"><a class="header" href="#configuration-surface">Configuration Surface</a></h1>
<blockquote>
<p>Canonical reference for the PostgreSQL-backed settings documents that drive Revaer’s runtime behaviour.</p>
</blockquote>
<p>Revaer persists all operator-facing configuration inside the <code>settings_*</code> tables. The API (<code>ConfigService</code>) exposes strongly-typed snapshots that are consumed by the API server, torrent engine, filesystem pipeline, and CLI. Every change flows through a <code>SettingsChangeset</code>, ensuring a single validation path whether commands originate from the setup flow or the admin API.</p>
<h2 id="snapshot-components"><a class="header" href="#snapshot-components">Snapshot Components</a></h2>
<p>The <code>/.well-known/revaer.json</code> endpoint, the authenticated <code>GET /v1/config</code> route, and the <code>revaer config get</code> CLI command all return the same structure:</p>
<pre><code class="language-json">{
    "revision": 42,
    "app_profile": {
        /* see below */
    },
    "engine_profile": {
        /*…*/
    },
    "fs_policy": {
        /*…*/
    },
    "api_keys": [
        {
            "key_id": "admin",
            "label": "bootstrap",
            "enabled": true,
            "rate_limit": null
        }
    ]
}
</code></pre>
<h3 id="app-profile-settings_app_profile"><a class="header" href="#app-profile-settings_app_profile">App Profile (<code>settings_app_profile</code>)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>id</code></td><td>UUID</td><td>Singleton identifier for the current document.</td></tr>
<tr><td><code>instance_name</code></td><td>string</td><td>Human readable label surfaced in the CLI after setup.</td></tr>
<tr><td><code>mode</code></td><td><code>"setup"</code> or <code>"active"</code></td><td>Gatekeeper for the authentication middleware. Setup requests are rejected once the system enters <code>active</code>.</td></tr>
<tr><td><code>version</code></td><td>integer</td><td>Optimistic locking counter maintained by <code>ConfigService</code>.</td></tr>
<tr><td><code>http_port</code></td><td>integer</td><td>Published TCP port for the API server.</td></tr>
<tr><td><code>bind_addr</code></td><td>string (IPv4/IPv6)</td><td>Listen address for the API server.</td></tr>
<tr><td><code>telemetry</code></td><td>object</td><td>Free-form map for logging + metrics toggles (e.g. <code>log_level</code>, <code>prometheus</code>).</td></tr>
<tr><td><code>features</code></td><td>object</td><td>Feature switches such as <code>fs_extract</code>, <code>par2</code>, <code>sse_backpressure</code>.</td></tr>
<tr><td><code>immutable_keys</code></td><td>array</td><td>List of fields that cannot be mutated via patches (<code>ConfigError::ImmutableField</code>).</td></tr>
</tbody>
</table>
</div>
<h3 id="engine-profile-settings_engine_profile"><a class="header" href="#engine-profile-settings_engine_profile">Engine Profile (<code>settings_engine_profile</code>)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>implementation</code></td><td>string</td><td>Currently <code>libtorrent</code>. Used to select the torrent workflow implementation.</td></tr>
<tr><td><code>listen_port</code></td><td>integer?</td><td>Optional external listen port override for the engine.</td></tr>
<tr><td><code>dht</code></td><td>bool</td><td>Enables/disables the DHT module.</td></tr>
<tr><td><code>encryption</code></td><td>string</td><td>Encryption requirement (<code>require</code>, <code>prefer</code>, etc.).</td></tr>
<tr><td><code>max_active</code></td><td>integer?</td><td>Cap on concurrently-active torrents; <code>null</code> means unlimited.</td></tr>
<tr><td><code>max_download_bps</code> / <code>max_upload_bps</code></td><td>integer?</td><td>Global rate limits applied by the engine.</td></tr>
<tr><td><code>sequential_default</code></td><td>bool</td><td>Default sequential downloading behaviour for new torrents.</td></tr>
<tr><td><code>resume_dir</code></td><td>string</td><td>Filesystem location where fast-resume artefacts are stored.</td></tr>
<tr><td><code>download_root</code></td><td>string</td><td>Directory used for in-progress torrent payloads.</td></tr>
<tr><td><code>tracker</code></td><td>object</td><td>Tracker configuration (user-agent, announce overrides).</td></tr>
</tbody>
</table>
</div>
<h3 id="filesystem-policy-settings_fs_policy"><a class="header" href="#filesystem-policy-settings_fs_policy">Filesystem Policy (<code>settings_fs_policy</code>)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>library_root</code></td><td>string</td><td>Destination directory for completed artefacts.</td></tr>
<tr><td><code>extract</code></td><td>bool</td><td>Whether completed payloads are extracted.</td></tr>
<tr><td><code>par2</code></td><td>string</td><td><code>off</code>, <code>verify</code>, or <code>repair</code> depending on PAR2 behaviour.</td></tr>
<tr><td><code>flatten</code></td><td>bool</td><td>Collapses single-file directories when moving into the library.</td></tr>
<tr><td><code>move_mode</code></td><td>string</td><td><code>copy</code>, <code>move</code>, or <code>hardlink</code> semantics for the FsOps pipeline.</td></tr>
<tr><td><code>cleanup_keep</code> / <code>cleanup_drop</code></td><td>array</td><td>Glob patterns retaining or removing files during cleanup.</td></tr>
<tr><td><code>chmod_file</code> / <code>chmod_dir</code></td><td>string?</td><td>Optional octal permissions applied to outputs; when omitted the pipeline derives modes from <code>umask</code> (defaults to <code>0o666/0o777</code>).</td></tr>
<tr><td><code>owner</code> / <code>group</code></td><td>string?</td><td>Optional ownership override resolved against system users/groups on Unix platforms; unsupported on non-Unix systems (FsOps emits a guarded failure).</td></tr>
<tr><td><code>umask</code></td><td>string?</td><td>Umask applied during FsOps and used to derive default file/directory modes when explicit chmod directives are absent.</td></tr>
<tr><td><code>allow_paths</code></td><td>array</td><td>Allowed staging/library paths the pipeline accepts.</td></tr>
</tbody>
</table>
</div>
<h3 id="api-keys--secrets"><a class="header" href="#api-keys--secrets">API Keys &amp; Secrets</a></h3>
<p>Patches can create, update, or revoke keys and named secrets. The request format mirrors <code>SettingsChangeset</code>:</p>
<pre><code class="language-jsonc">{
    "api_keys": [
        {
            "op": "upsert",
            "key_id": "admin",
            "label": "primary",
            "enabled": true,
            "secret": "optional-override",
            "rate_limit": { "burst": 10, "per_seconds": 1 }
        }
    ],
    "secrets": [
        { "op": "set", "name": "libtorrent.passphrase", "value": "..." }
    ]
}
</code></pre>
<p>The API server enforces bucketed rate limits if <code>rate_limit</code> is supplied (<code>burst</code> per <code>per_seconds</code>). Invalid field names or mutations against <code>immutable_keys</code> yield RFC9457 <code>ProblemDetails</code> responses with an <code>invalid_params</code> array matching the JSON pointer returned by <code>ConfigError</code>.</p>
<h2 id="telemetry-toggle"><a class="header" href="#telemetry-toggle">Telemetry Toggle</a></h2>
<p>Revaer boots with structured logging and Prometheus metrics by default. OpenTelemetry export remains opt-in for Phase One: set <code>REVAER_ENABLE_OTEL=true</code> alongside your <code>revaer-app</code> process (optionally overriding <code>REVAER_OTEL_SERVICE_NAME</code> and <code>REVAER_OTEL_EXPORTER</code>) to attach the stubbed tracing layer. When the flag is absent, no OpenTelemetry dependencies are activated.</p>
<h2 id="change-workflows"><a class="header" href="#change-workflows">Change Workflows</a></h2>
<ul>
<li><strong>Setup</strong> – <code>POST /admin/setup/start</code> issues a one-time token. <code>POST /admin/setup/complete</code> consumes that token, applies the provided <code>SettingsChangeset</code>, forces <code>app_profile.mode</code> to <code>active</code>, and returns the hydrated snapshot along with the generated API key (also echoed in the CLI output).</li>
<li><strong>Ongoing updates</strong> – <code>PATCH /v1/config</code> (CLI: <code>revaer config set --file changes.json</code>) requires an API key and supports partial documents. Any field omitted from the payload remains untouched. The legacy <code>/admin/settings</code> alias remains for compatibility.</li>
<li><strong>Snapshot access</strong> – <code>GET /.well-known/revaer.json</code> (no auth), <code>GET /v1/config</code> (API key), <code>GET /health/full</code>, and <code>revaer config get</code> return the current revision so automation and dashboards can verify configuration drift without shell access.</li>
</ul>
<p>Revaer publishes <code>SettingsChanged</code> events on every successful mutation, ensuring subscribers refresh in-memory caches without polling.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="http-api"><a class="header" href="#http-api">HTTP API</a></h1>
<blockquote>
<p>REST + SSE surface exposed by <code>revaer-api</code>. The OpenAPI document at <code>/docs/openapi.json</code> is generated by <code>just api-export</code>.</p>
</blockquote>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<ul>
<li><strong>Setup flow</strong> – Requests to <code>/admin/setup/start</code> are open. <code>/admin/setup/complete</code> requires the <code>x-revaer-setup-token</code> header with the one-time token returned by <code>setup_start</code>. The server refuses setup calls once the app profile switches to <code>active</code>.</li>
<li><strong>Operator actions</strong> – All <code>/admin/*</code> (after setup) and <code>/v1/*</code> endpoints require <code>x-revaer-api-key: {key_id}:{secret}</code>. The middleware validates the key via <code>ConfigService</code>, enforces per-key rate limiting, and rejects calls while the instance remains in setup mode.</li>
<li><strong>Request correlation</strong> – An optional <code>x-request-id</code> header is echoed into tracing spans and surfaced on SSE traffic. The CLI auto-populates this header per invocation.</li>
</ul>
<p>Error responses follow RFC9457 (<code>ProblemDetails</code>), populated with <code>invalid_params</code> entries whenever validation pinpoints a JSON pointer within the payload.</p>
<h2 id="endpoint-inventory"><a class="header" href="#endpoint-inventory">Endpoint Inventory</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Method</th><th>Path</th><th>Auth</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>GET</code></td><td><code>/health</code></td><td>none</td><td>Lightweight readiness probe returning mode + database status.</td></tr>
<tr><td><code>GET</code></td><td><code>/health/full</code></td><td>none</td><td>Extended health snapshot with build SHA, metrics counters, and torrent queue depth.</td></tr>
<tr><td><code>GET</code></td><td><code>/.well-known/revaer.json</code></td><td>none</td><td>Full configuration snapshot (<code>ConfigSnapshot</code>) including current revision.</td></tr>
<tr><td><code>GET</code></td><td><code>/v1/config</code></td><td>API key</td><td>Authenticated configuration snapshot (same payload as <code>/.well-known/revaer.json</code>).</td></tr>
<tr><td><code>PATCH</code></td><td><code>/v1/config</code></td><td>API key</td><td>Applies partial configuration updates (<code>SettingsChangeset</code>) and broadcasts <code>SettingsChanged</code>.</td></tr>
<tr><td><code>POST</code></td><td><code>/admin/setup/start</code></td><td>none</td><td>Issues a setup token; optionally accepts <code>issued_by</code> + <code>ttl_seconds</code>.</td></tr>
<tr><td><code>POST</code></td><td><code>/admin/setup/complete</code></td><td>setup token</td><td>Applies a <code>SettingsChangeset</code>, promotes the instance to <code>active</code>, consumes the token, and returns the hydrated snapshot.</td></tr>
<tr><td><code>PATCH</code></td><td><code>/admin/settings</code></td><td>API key</td><td>Alias for <code>PATCH /v1/config</code>; retained for admin tooling.</td></tr>
<tr><td><code>GET</code></td><td><code>/admin/torrents</code></td><td>API key</td><td>Same as <code>GET /v1/torrents</code>; retained for admin tooling.</td></tr>
<tr><td><code>POST</code></td><td><code>/admin/torrents</code></td><td>API key</td><td>Alias for <code>POST /v1/torrents</code>.</td></tr>
<tr><td><code>GET</code></td><td><code>/admin/torrents/{id}</code></td><td>API key</td><td>Alias for <code>GET /v1/torrents/{id}</code>.</td></tr>
<tr><td><code>DELETE</code></td><td><code>/admin/torrents/{id}</code></td><td>API key</td><td>Alias for invoking the <code>remove</code> action.</td></tr>
<tr><td><code>GET</code></td><td><code>/v1/torrents</code></td><td>API key</td><td>Cursor-paginated torrent summaries with filtering (state, tracker, extension, tags, name).</td></tr>
<tr><td><code>POST</code></td><td><code>/v1/torrents</code></td><td>API key</td><td>Submits a magnet URI or base64-encoded <code>.torrent</code>, optional tags/trackers, file rules, and per-torrent rate limits.</td></tr>
<tr><td><code>GET</code></td><td><code>/v1/torrents/{id}</code></td><td>API key</td><td>Detailed torrent view including file metadata when available.</td></tr>
<tr><td><code>POST</code></td><td><code>/v1/torrents/{id}/select</code></td><td>API key</td><td>Adjusts inclusion/exclusion globs, fluff skipping, and per-file priorities.</td></tr>
<tr><td><code>POST</code></td><td><code>/v1/torrents/{id}/action</code></td><td>API key</td><td>Lifecycle management (<code>pause</code>, <code>resume</code>, <code>remove</code>, <code>reannounce</code>, <code>recheck</code>, <code>sequential</code>, <code>rate</code>).</td></tr>
<tr><td><code>GET</code></td><td><code>/v1/events</code></td><td>API key</td><td>Server-sent events stream (aliases: <code>/v1/events/stream</code>, <code>/v1/torrents/events</code>). Supports filtering by torrent ID, state, and event kind.</td></tr>
<tr><td><code>GET</code></td><td><code>/metrics</code></td><td>none</td><td>Prometheus-formatted metrics from <code>revaer-telemetry</code>.</td></tr>
<tr><td><code>GET</code></td><td><code>/docs/openapi.json</code></td><td>none</td><td>Static OpenAPI document used by the docs site and clients.</td></tr>
</tbody>
</table>
</div>
<p>All torrent-managing endpoints ensure the torrent workflow is wired. If the engine is unavailable, the API returns <code>503 Service Unavailable</code>.</p>
<h3 id="torrent-submission-post-v1torrents"><a class="header" href="#torrent-submission-post-v1torrents">Torrent Submission (<code>POST /v1/torrents</code>)</a></h3>
<p>Required headers: <code>x-revaer-api-key</code>. Provide either <code>magnet</code> or <code>metainfo</code>; the server rejects payloads missing both. Optional fields:</p>
<ul>
<li><code>download_dir</code> – Overrides the engine profile’s staging directory.</li>
<li><code>sequential</code> – Enables sequential downloading for this torrent only.</li>
<li><code>tags</code> / <code>trackers</code> – Stored alongside the torrent for filtering and bookkeeping.</li>
<li><code>include</code> / <code>exclude</code> / <code>skip_fluff</code> – File selection bootstrap applied before metadata fetch completes.</li>
<li><code>max_download_bps</code> / <code>max_upload_bps</code> – Per-torrent rate limits (bps) passed to the workflow.</li>
</ul>
<p>On success the server returns <code>202 Accepted</code> after dispatching <code>TorrentWorkflow::add_torrent</code>. The torrent ID in the payload becomes the canonical identifier.</p>
<h3 id="listing--filtering-get-v1torrents"><a class="header" href="#listing--filtering-get-v1torrents">Listing &amp; Filtering (<code>GET /v1/torrents</code>)</a></h3>
<p>Query parameters:</p>
<ul>
<li><code>limit</code> (default 50, max 200)</li>
<li><code>cursor</code> – Base64 token returned in <code>next</code>.</li>
<li><code>state</code>, <code>tracker</code>, <code>extension</code>, <code>tags</code>, <code>name</code> – Comma-separated filters (case-insensitive).</li>
</ul>
<p>The response body is <code>TorrentListResponse</code> with an optional <code>next</code> cursor when additional pages exist.</p>
<h3 id="torrent-actions-post-v1torrentsidaction"><a class="header" href="#torrent-actions-post-v1torrentsidaction">Torrent Actions (<code>POST /v1/torrents/{id}/action</code>)</a></h3>
<p><code>type</code> determines the shape of the body:</p>
<pre><code class="language-json">{ "type": "remove", "delete_data": true }
{ "type": "sequential", "enable": false }
{ "type": "rate", "download_bps": 1048576, "upload_bps": null }
</code></pre>
<p>Failures propagate engine errors as <code>500 Internal Server Error</code> with a descriptive message in <code>detail</code>.</p>
<h3 id="sse-stream-get-v1events"><a class="header" href="#sse-stream-get-v1events">SSE Stream (<code>GET /v1/events</code>)</a></h3>
<p>Headers:</p>
<ul>
<li><code>x-revaer-api-key</code></li>
<li>Optional <code>Last-Event-ID</code> – resuming from a previously stored ID (the CLI stores this via <code>--resume-file</code>).</li>
</ul>
<p>Query parameters:</p>
<ul>
<li><code>torrent</code> – Comma-separated UUIDs.</li>
<li><code>event</code> – Comma-separated event kinds. Valid values: <code>torrent_added</code>, <code>files_discovered</code>, <code>progress</code>, <code>state_changed</code>, <code>completed</code>, <code>fsops_started</code>, <code>fsops_progress</code>, <code>fsops_completed</code>, <code>fsops_failed</code>, <code>settings_changed</code>, <code>health_changed</code>, <code>selection_reconciled</code>.</li>
<li><code>state</code> – Comma-separated torrent states (<code>downloading</code>, <code>completed</code>, etc.).</li>
</ul>
<p>The server maintains a 20-second keep-alive ping and enforces filtering before events hit the wire.</p>
<h3 id="health--metrics"><a class="header" href="#health--metrics">Health &amp; Metrics</a></h3>
<ul>
<li><code>GET /health</code> – Primary readiness probe used by orchestration systems. Adds <code>database</code> to the degraded list if PostgreSQL is unreachable.</li>
<li><code>GET /health/full</code> – Returns the deployment revision, build SHA (<code>build_sha()</code>), metrics snapshot (<code>config_watch_latency_ms</code>, <code>guardrail_violations_total</code>, <code>rate_limit_throttled_total</code>, etc.), and torrent queue depth.</li>
<li><code>GET /metrics</code> – Exposes the same counters for Prometheus scraping.</li>
</ul>
<p>For the complete schema definitions, consult the generated OpenAPI (<code>just api-export</code>).</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cli-reference"><a class="header" href="#cli-reference">CLI Reference</a></h1>
<blockquote>
<p><code>revaer-cli</code> provides parity with the API for setup, configuration management, torrent lifecycle, and observability.</p>
</blockquote>
<h2 id="global-flags--environment"><a class="header" href="#global-flags--environment">Global Flags &amp; Environment</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Flag</th><th>Environment</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>--api-url &lt;URL&gt;</code></td><td><code>REVAER_API_URL</code></td><td><code>http://127.0.0.1:7070</code></td><td>Base URL for API requests.</td></tr>
<tr><td><code>--api-key &lt;key_id:secret&gt;</code></td><td><code>REVAER_API_KEY</code></td><td><em>none</em></td><td>Required for all post-setup commands that mutate or read torrents.</td></tr>
<tr><td><code>--timeout &lt;secs&gt;</code></td><td><code>REVAER_HTTP_TIMEOUT_SECS</code></td><td><code>10</code></td><td>Per-request HTTP timeout.</td></tr>
<tr><td><code>--output &lt;table|json&gt;</code></td><td><em>none</em></td><td><code>table</code></td><td>Output format for structured responses (<code>json</code> is script-friendly).</td></tr>
</tbody>
</table>
</div>
<p>Each invocation bubbles a unique <code>x-request-id</code> through the API; the CLI also emits optional telemetry events when <code>REVAER_TELEMETRY_ENDPOINT</code> is set.</p>
<h2 id="setup-flow"><a class="header" href="#setup-flow">Setup Flow</a></h2>
<h3 id="revaer-setup-start---issued-by-label---ttl-seconds-secs"><a class="header" href="#revaer-setup-start---issued-by-label---ttl-seconds-secs"><code>revaer setup start [--issued-by &lt;label&gt;] [--ttl-seconds &lt;secs&gt;]</code></a></h3>
<ul>
<li>Calls <code>POST /admin/setup/start</code>.</li>
<li>Prints the plaintext token followed by its ISO8601 expiry.</li>
<li>Use <code>--issued-by</code> to tag the token source (defaults to <code>api</code>).</li>
</ul>
<h3 id="revaer-setup-complete---instance-name---bind-addr---port-port---resume-dir-path---download-root-path---library-root-path---api-key-label-label---api-key-id-id---passphrase-value---token-token"><a class="header" href="#revaer-setup-complete---instance-name---bind-addr---port-port---resume-dir-path---download-root-path---library-root-path---api-key-label-label---api-key-id-id---passphrase-value---token-token"><code>revaer setup complete --instance &lt;name&gt; --bind &lt;addr&gt; --port &lt;port&gt; --resume-dir &lt;path&gt; --download-root &lt;path&gt; --library-root &lt;path&gt; --api-key-label &lt;label&gt; [--api-key-id &lt;id&gt;] [--passphrase &lt;value&gt;] [--token &lt;token&gt;]</code></a></h3>
<ul>
<li>Loads the setup token either from <code>--token</code> or <code>REVAER_SETUP_TOKEN</code>.</li>
<li>Builds a <code>SettingsChangeset</code> containing the app profile, engine profile, filesystem policy, API key, and optional secret.</li>
<li>Forces <code>app_profile.mode = "active"</code>.</li>
<li>Echoes the generated API key (<code>key_id:secret</code>) on success; store it securely before continuing.</li>
</ul>
<h2 id="configuration-maintenance"><a class="header" href="#configuration-maintenance">Configuration Maintenance</a></h2>
<h3 id="revaer-settings-patch---file-path"><a class="header" href="#revaer-settings-patch---file-path"><code>revaer settings patch --file &lt;path&gt;</code></a></h3>
<ul>
<li>Reads a JSON file containing a partial <code>SettingsChangeset</code>.</li>
<li>Requires an API key.</li>
<li>Returns a formatted <code>ProblemDetails</code> message if validation fails (immutable fields, unknown keys, etc.).</li>
</ul>
<h2 id="torrent-lifecycle"><a class="header" href="#torrent-lifecycle">Torrent Lifecycle</a></h2>
<h3 id="revaer-torrent-add-magnettorrent---name-label---id-uuid"><a class="header" href="#revaer-torrent-add-magnettorrent---name-label---id-uuid"><code>revaer torrent add &lt;magnet|.torrent&gt; [--name &lt;label&gt;] [--id &lt;uuid&gt;]</code></a></h3>
<ul>
<li>Accepts a magnet URI or a filesystem path to a <code>.torrent</code>.</li>
<li>Automatically base64-encodes torrent files for the API.</li>
<li>Optional overrides: <code>--name</code> sets the human-friendly label; <code>--id</code> lets you supply a deterministic UUID instead of the auto-generated value.</li>
</ul>
<h3 id="revaer-torrent-remove-uuid"><a class="header" href="#revaer-torrent-remove-uuid"><code>revaer torrent remove &lt;uuid&gt;</code></a></h3>
<ul>
<li>Issues <code>POST /v1/torrents/{id}/action</code> with <code>{ "type": "remove" }</code>.</li>
<li>Use the more general <code>action</code> command for <code>delete_data</code> semantics.</li>
</ul>
<h3 id="revaer-ls---limit-n---cursor-token---state-state---tracker-url---extension-ext---tags-tag1tag2---name-fragment"><a class="header" href="#revaer-ls---limit-n---cursor-token---state-state---tracker-url---extension-ext---tags-tag1tag2---name-fragment"><code>revaer ls [--limit &lt;n&gt;] [--cursor &lt;token&gt;] [--state &lt;state&gt;] [--tracker &lt;url&gt;] [--extension &lt;ext&gt;] [--tags &lt;tag1,tag2&gt;] [--name &lt;fragment&gt;]</code></a></h3>
<ul>
<li>Lists torrents with the same filters supported by the REST API.</li>
<li>Default output is a table summarising id, name, state, and progress.</li>
<li>Add <code>--output json</code> to emit the raw <code>TorrentListResponse</code>.</li>
</ul>
<h3 id="revaer-status-uuid"><a class="header" href="#revaer-status-uuid"><code>revaer status &lt;uuid&gt;</code></a></h3>
<ul>
<li>Returns a detailed view of a single torrent.</li>
<li>Add <code>--output json</code> to view the full <code>TorrentDetail</code> (including file metadata when available).</li>
</ul>
<h3 id="revaer-select-uuid---include-globglob---exclude-globglob---skip-fluff---priority-indexpriority"><a class="header" href="#revaer-select-uuid---include-globglob---exclude-globglob---skip-fluff---priority-indexpriority"><code>revaer select &lt;uuid&gt; [--include &lt;glob,glob&gt;] [--exclude &lt;glob,glob&gt;] [--skip-fluff] [--priority index=priority,…]</code></a></h3>
<ul>
<li>Updates file-selection rules via <code>POST /v1/torrents/{id}/select</code>.</li>
<li><code>--priority</code> accepts repeated <code>index=priority</code> pairs (<code>skip|low|normal|high</code>) mapped onto the engine’s <code>FilePriority</code>.</li>
</ul>
<h3 id="revaer-action-uuid-pauseresumeremovereannouncerechecksequentialrate---delete-data---enable-bool---download-bps---upload-bps"><a class="header" href="#revaer-action-uuid-pauseresumeremovereannouncerechecksequentialrate---delete-data---enable-bool---download-bps---upload-bps"><code>revaer action &lt;uuid&gt; &lt;pause|resume|remove|reannounce|recheck|sequential|rate&gt; [--delete-data] [--enable &lt;bool&gt;] [--download &lt;bps&gt;] [--upload &lt;bps&gt;]</code></a></h3>
<ul>
<li>One-stop entry point for all torrent actions.</li>
<li><code>sequential</code> toggles sequential downloads via <code>--enable true|false</code>.</li>
<li><code>rate</code> updates per-torrent bandwidth caps (bps). Provide <code>--download</code> and/or <code>--upload</code>.</li>
<li><code>remove</code> honours <code>--delete-data</code>.</li>
</ul>
<h2 id="event-streaming"><a class="header" href="#event-streaming">Event Streaming</a></h2>
<h3 id="revaer-tail---torrent-idid---event-kindkind---state-statestate---resume-file-path---retry-secs-n"><a class="header" href="#revaer-tail---torrent-idid---event-kindkind---state-statestate---resume-file-path---retry-secs-n"><code>revaer tail [--torrent &lt;id,id&gt;] [--event &lt;kind,kind&gt;] [--state &lt;state,state&gt;] [--resume-file &lt;path&gt;] [--retry-secs &lt;n&gt;]</code></a></h3>
<ul>
<li>Connects to <code>/v1/events</code> using SSE.</li>
<li>Filters match the API query parameters and enforce UUID/event-kind validation before the request is made.</li>
<li>When <code>--resume-file</code> is supplied, the CLI persists the last event ID across reconnects so the stream can resume after transient failures.</li>
<li><code>--retry-secs</code> controls the backoff between reconnect attempts (default: 5 seconds).</li>
</ul>
<p>All torrent commands require an API key. The CLI surfaces API problems exactly as the server returns them, including RFC9457 validation errors and rate-limit responses (<code>429 Too Many Requests</code> with retry metadata in the body).</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-flows"><a class="header" href="#torrent-flows">Torrent Flows</a></h1>
<p>Operational views for the torrent lifecycle and the torrent authoring path. These diagrams are reference-only; wire changes must follow the stored-procedure, clamp-before-apply, and observability guardrails in <code>AGENT.md</code>.</p>
<h2 id="admission--runtime--fsops"><a class="header" href="#admission--runtime--fsops">Admission → Runtime → FsOps</a></h2>
<pre class="mermaid">flowchart TB
    subgraph API["API/CLI"]
        Req["POST /v1/torrents&lt;br/&gt;+ CLI add&lt;br/&gt;- validate payload&lt;br/&gt;- clamp per profile&lt;br/&gt;- hydrate metadata (tags/category/storage)&lt;br/&gt;- normalize selection + limits"]
    end

    subgraph Worker["Worker / Orchestrator"]
        Cmd["EngineCommand::Add&lt;br/&gt;- attach profile snapshot&lt;br/&gt;- derive AddTorrentOptions&lt;br/&gt;- stash selection + metadata for FsOps"]
        Persist["RuntimeStore&lt;br/&gt;- persist metadata/selection&lt;br/&gt;- checkpoint admission state"]
    end

    subgraph Bridge["Bridge / FFI"]
        Opts["EngineOptions/AddTorrentRequest&lt;br/&gt;- listen/download dirs&lt;br/&gt;- per-torrent rate caps&lt;br/&gt;- queue priority / paused&lt;br/&gt;- trackers (profile + request)&lt;br/&gt;- encryption, DHT, LSD flags&lt;br/&gt;- seed mode / add paused"]
        Session["libtorrent session&lt;br/&gt;- apply settings_pack&lt;br/&gt;- add_torrent_params&lt;br/&gt;- start/resume handles"]
    end

    subgraph Engine["Engine Loop"]
        Progress["Native events → EngineEvent&lt;br/&gt;- progress/state&lt;br/&gt;- alert mapping&lt;br/&gt;- tracker status&lt;br/&gt;- errors (listen/storage/peer)"]
        Cache["Per-torrent cache&lt;br/&gt;- rate caps&lt;br/&gt;- trackers&lt;br/&gt;- limits&lt;br/&gt;- tags/category"]
    end

    subgraph FsOps["FsOps Pipeline"]
        Select["Selection reconcile&lt;br/&gt;- honor request selection&lt;br/&gt;- drop unselected paths"]
        Extract["Extract archives (zip/rar/7z/tar.gz)&lt;br/&gt;- optional; skip when not configured&lt;br/&gt;- guardrail missing tools"]
        Flatten["Flatten/move per policy&lt;br/&gt;- copy/move/hardlink&lt;br/&gt;- partfile handling"]
        Perms["chmod/chown/umask&lt;br/&gt;- library root enforcement"]
        Cleanup["Cleanup&lt;br/&gt;- drop patterns&lt;br/&gt;- keep filters&lt;br/&gt;- metadata writeback (.revaer.meta)"]
    end

    Req --&gt; Cmd
    Cmd --&gt; Persist
    Cmd --&gt; Opts
    Opts --&gt; Session
    Session --&gt; Progress
    Progress --&gt; Cache
    Progress --&gt;|Completed event| FsOps
    FsOps --&gt;|Events + metrics| Worker
    Worker --&gt;|Health + SSE| API
</pre>

<h3 id="notes"><a class="header" href="#notes">Notes</a></h3>
<ul>
<li>Clamping and validation happen before persistence and before libtorrent sees the settings; unknown fields are ignored, unsafe values are clamped.</li>
<li>Per-torrent limits (rate caps, queue priority, paused, seed mode) are applied immediately on admission and cached for later verification.</li>
<li>FsOps runs on <code>Completed</code> with retries; every stage emits events/metrics and degrades health on guardrail breaches (tooling missing, permission errors, latency overruns).</li>
</ul>
<h2 id="torrent-creation-authoring-flow"><a class="header" href="#torrent-creation-authoring-flow">Torrent Creation (Authoring) Flow</a></h2>
<pre class="mermaid">flowchart LR
    Input["Input&lt;br/&gt;- file/dir path&lt;br/&gt;- trackers/web seeds&lt;br/&gt;- piece size (auto/manual)&lt;br/&gt;- private flag&lt;br/&gt;- comment/source&lt;br/&gt;- alignment rules"]
    Stage["Stage &amp; Hash&lt;br/&gt;- walk files with allowlist&lt;br/&gt;- apply size filters&lt;br/&gt;- align pieces&lt;br/&gt;- hash with deterministic order"]
    Meta["Build metainfo&lt;br/&gt;- info dictionary&lt;br/&gt;- tracker tiers&lt;br/&gt;- web seeds&lt;br/&gt;- creation date&lt;br/&gt;- optional dht nodes"]
    Validate["Validate&lt;br/&gt;- size/limit guards&lt;br/&gt;- path length&lt;br/&gt;- private flag vs trackers&lt;br/&gt;- duplicate file detection"]
    PersistMeta["Persist&lt;br/&gt;- .torrent file&lt;br/&gt;- magnet link&lt;br/&gt;- optional signed manifest"]
    Return["Return to caller&lt;br/&gt;- paths + hashes&lt;br/&gt;- effective options&lt;br/&gt;- warnings (skipped files, clamped piece size)"]

    Input --&gt; Stage --&gt; Meta --&gt; Validate --&gt; PersistMeta --&gt; Return
</pre>

<h3 id="notes-1"><a class="header" href="#notes-1">Notes</a></h3>
<ul>
<li>Creation respects the same glob filters and guardrails used by admission to avoid later FsOps surprises (e.g., exclude temporary/system files).</li>
<li>When trackers or web seeds are provided, they remain deduplicated and ordered; private torrents skip DHT/PEX automatically.</li>
<li>The flow is deterministic: file order, piece sizing, and hashing are reproducible given the same inputs and options.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="native-libtorrent-integration-tests"><a class="header" href="#native-libtorrent-integration-tests">Native Libtorrent Integration Tests</a></h1>
<p>These tests are opt-in (gated by <code>REVAER_NATIVE_IT</code>) to keep the default matrix deterministic; include them explicitly in feature-matrix runs.</p>
<p>To run the feature-gated native libtorrent integration suite locally:</p>
<pre><code class="language-bash"># Ensure Docker (or colima) is running and DOCKER_HOST is set if not using /var/run/docker.sock
export DOCKER_HOST=${DOCKER_HOST:-unix:///Users/vanna/.colima/default/docker.sock}

# Enable native integration tests
export REVAER_NATIVE_IT=1

# Run the full gate (preferred)
just ci

# Or target only the libtorrent native suite
just test-native
</code></pre>
<p>CI note: add a matrix job that sets <code>REVAER_NATIVE_IT=1</code> and points <code>DOCKER_HOST</code> at the runner’s daemon to ensure the native path stays covered.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="api-documentation"><a class="header" href="#api-documentation">API Documentation</a></h1>
<p>This directory hosts HTTP API specifications, generated OpenAPI documents, and usage guides for the Revaer control plane.</p>
<h2 id="contents"><a class="header" href="#contents">Contents</a></h2>
<ul>
<li><code>schema/</code> – Published OpenAPI payloads and supporting artefacts.</li>
<li><code>guides/</code> – Scenario-based walkthroughs (bootstrap, hot reload validation, torrent lifecycle).</li>
<li><code>examples/</code> – HTTP request/response samples captured from real workflows.</li>
</ul>
<h2 id="current-coverage"><a class="header" href="#current-coverage">Current Coverage</a></h2>
<ul>
<li><strong>Setup &amp; configuration</strong> – <code>/admin/setup/*</code> and <code>/admin/settings</code> flows with CLI parity.</li>
<li><strong>Orchestration</strong> – <code>/admin/torrents</code> (POST/DELETE/GET) for submitting or removing torrents, plus <code>/admin/torrents/{id}</code> for status inspection.</li>
<li><strong>Observability</strong> – <code>/v1/events</code> SSE stream (tested for replay/keep-alive) and <code>/metrics</code> Prometheus surface with torrent gauges.</li>
</ul>
<p>See <code>guides/bootstrap.md</code> for an end-to-end description of the bootstrap lifecycle, background workers, and error handling expectations.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li>Capture worked examples for torrent status reconciliation (list + selective GET).</li>
<li>Provide troubleshooting recipes for common workflow failures (engine unavailable, filesystem policy rejection).</li>
<li>Expand SSE consumer documentation with incremental backfill strategies.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="openapi-reference"><a class="header" href="#openapi-reference">OpenAPI Reference</a></h1>
<blockquote>
<p>Canonical machine-readable description of the Revaer control plane surface.</p>
</blockquote>
<p>The generated OpenAPI specification lives alongside the documentation at <a href="api/openapi.json"><code>docs/api/openapi.json</code></a>. Regenerate it with:</p>
<pre><code class="language-bash">just api-export
</code></pre>
<p>Once refreshed, rebuild the documentation (<code>just docs</code>) to publish the updated schema to the static site and LLM manifests. API consumers can download the JSON directly from the deployed documentation site or via the repository.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="adrs"><a class="header" href="#adrs">ADRs</a></h1>
<h2 id="suggested-use-workflow"><a class="header" href="#suggested-use-workflow">Suggested Use Workflow</a></h2>
<ol>
<li>Create a new ADR using the template in <code>docs/adr/template.md</code>.</li>
<li>Give it a sequential identifier (e.g., <code>001</code>, <code>002</code>) and a concise title.</li>
<li>Capture context, decision, consequences, and follow-up actions.</li>
<li>Append the new ADR entry to the end of the Catalogue list above.</li>
<li>Append the same entry under <code>ADRs</code> in <code>docs/SUMMARY.md</code>, keeping it nested so the sidebar stays collapsed.</li>
<li>Reference ADRs from code comments or docs where the decision applies.</li>
</ol>
<h2 id="catalogue"><a class="header" href="#catalogue">Catalogue</a></h2>
<ul>
<li><a href="#001--global-configuration-revisioning">001</a> – Configuration revisioning</li>
<li><a href="#002--setup-token-lifecycle--secrets-bootstrap">002</a> – Setup token lifecycle</li>
<li><a href="#003--libtorrent-session-runner-architecture">003</a> – Libtorrent session runner</li>
<li><a href="#004--phase-one-delivery-track">004</a> – Phase one delivery</li>
<li><a href="#005--fsops-pipeline-hardening">005</a> – FS operations pipeline</li>
<li><a href="#006--unified-api--cli-contract">006</a> – API/CLI contract</li>
<li><a href="#007--api-key-security--rate-limiting">007</a> – Security posture</li>
<li><a href="#008--phase-one-remaining-delivery-task-record">008</a> – Remaining phase-one tasks</li>
<li><a href="#009--fsops-permission-hardening">009</a> – FS ops permission hardening</li>
<li><a href="#agent-compliance-sweep">010</a> – Agent compliance sweep</li>
<li><a href="#coverage-hardening-phase-two">011</a> – Coverage hardening</li>
<li><a href="#agent-compliance-refresh">012</a> – Agent compliance refresh</li>
<li><a href="#013--runtime-persistence-for-torrents-and-fsops-jobs">013</a> – Runtime persistence</li>
<li><a href="#014--centralized-data-access-layer">014</a> – Data access layer</li>
<li><a href="#015-agent-compliance-hardening">015</a> – Agent compliance hardening</li>
<li><a href="#016-libtorrent-restoration">016</a> – Libtorrent restoration</li>
<li><a href="#avoid-sqlx-named-bind">017</a> – Avoid <code>sqlx-named-bind</code></li>
<li><a href="#retire-testcontainers">018</a> – Retire testcontainers</li>
<li><a href="#advisory-rustsec-2024-0370-temporary-ignore">019</a> – Advisory RUSTSEC-2024-0370 temporary ignore</li>
<li><a href="#torrent-engine-precursor-hardening">020</a> – Torrent engine precursor hardening</li>
<li><a href="#torrent-precursor-enforcement">021</a> – Torrent precursor enforcement</li>
<li><a href="#torrent-settings-parity-and-observability">022</a> – Torrent settings parity and observability</li>
<li><a href="#tracker-config-wiring">023</a> – Tracker config wiring and persistence</li>
<li><a href="#seeding-stop-criteria-and-per-torrent-overrides">024</a> – Seeding stop criteria and overrides</li>
<li><a href="#025-seed-mode-admission-with-optional-hash-sampling">025</a> – Seed mode admission with optional hash sampling</li>
<li><a href="#queue-auto-managed-defaults-and-pex-threading">026</a> – Queue auto-managed defaults and PEX threading</li>
<li><a href="#choking-strategy-and-super-seeding-configuration">027</a> – Choking strategy and super-seeding configuration</li>
<li><a href="#qbittorrent-parity-and-tracker-tls-wiring">028</a> – qBittorrent parity and tracker TLS wiring</li>
<li><a href="#torrent-authoring-labels-and-metadata-updates">029</a> – Torrent authoring, labels, and metadata updates</li>
<li><a href="#030--migration-consolidation-for-initial-setup">030</a> – Migration consolidation for initial setup</li>
<li><a href="#ui-nexus-asset-sync-tooling">031</a> – UI Nexus asset sync tooling</li>
<li><a href="#torrent-ffi-audit-closeout">032</a> – Torrent FFI audit closeout</li>
<li><a href="#ui-sse--authsetup-wiring">033</a> – UI SSE + auth/setup wiring</li>
<li><a href="#ui-sse-normalization-progress-coalescing-and-apiclient-singleton">034</a> – UI SSE normalization and ApiClient singleton</li>
<li><a href="#advisory-rustsec-2021-0065-temporary-ignore">035</a> – Advisory RUSTSEC-2021-0065 temporary ignore</li>
<li><a href="#asset-sync-test-stability-under-parallel-runs">036</a> – Asset sync test stability under parallel runs</li>
<li><a href="#ui-row-slices-and-system-rate-store-wiring">037</a> – UI row slices and system-rate store wiring</li>
<li><a href="#ui-shared-api-models-and-torrent-query-paging-state">038</a> – UI shared API models and torrent query paging state</li>
<li><a href="#ui-store-api-coverage-and-rate-limit-retries">039</a> – UI store, API coverage, and rate-limit retries</li>
<li><a href="#040--ui-label-policies-task-record">040</a> – UI label policy editor and API wiring</li>
<li><a href="#041--ui-health-view--label-shortcuts-task-record">041</a> – UI health view and label shortcuts</li>
<li><a href="#042---ui-metrics-copy-button-task-record">042</a> – UI metrics copy button</li>
<li><a href="#043---ui-settings-bypass-local-auth-toggle-task-record">043</a> – UI settings bypass local auth toggle</li>
<li><a href="#044---ui-apiclient-torrent-optionsselection-endpoints-task-record">044</a> – UI ApiClient torrent options/selection endpoints</li>
<li><a href="#ui-icon-system-and-icon-buttons">045</a> – UI icon components and icon button standardization</li>
<li><a href="#ui-torrent-filters-pagination-and-url-sync">046</a> – UI torrent filters, pagination, and URL sync</li>
<li><a href="#ui-torrent-list-updated-timestamp-column">047</a> – UI torrent list updated timestamp column</li>
<li><a href="#adr-048-ui-torrent-row-actions-bulk-controls-and-rateremove-dialogs">048</a> – UI torrent row actions, bulk controls, and rate/remove dialogs</li>
<li><a href="#ui-detail-drawer-overviewfilesoptions">049</a> – UI detail drawer overview/files/options</li>
<li><a href="#ui-torrent-fab--create-modals">050</a> – UI torrent FAB, add modal, and create-torrent authoring flow</li>
<li><a href="#ui-shared-api-models-and-ux-primitives">051</a> – UI shared API models and UX primitives</li>
<li><a href="#ui-dashboard-migration-to-nexus-vendor-layout">052</a> – UI dashboard migration to Nexus vendor layout</li>
<li><a href="#ui-hardline-nexus-dashboard-rebuild-and-settings-wiring">053</a> – UI dashboard hardline rebuild</li>
<li><a href="#ui-dashboard-nexus-parity-tweaks">054</a> – UI dashboard Nexus parity tweaks</li>
<li><a href="#factory-reset-and-bootstrap-api-key">055</a> – Factory reset and bootstrap API key</li>
<li><a href="#factory-reset-bootstrap-auth-fallback">056</a> – Factory reset auth fallback when no API keys exist</li>
<li><a href="#ui-settings-tabs-and-editor-controls">057</a> – UI settings tabs and editor controls</li>
<li><a href="#ui-settings-controls-logs-stream-and-filesystem-browser">058</a> – UI settings controls, logs stream, and filesystem browser</li>
<li><a href="#059--migration-rebaseline-and-json-backfill-guardrails">059</a> – Migration rebaseline and JSON backfill guardrails</li>
<li><a href="#auth-expiry--error-context-fields">060</a> – Auth expiry enforcement and structured error context</li>
<li><a href="#api-i18n-error-localization-and-openapi-assets">061</a> – API error i18n and OpenAPI asset constants</li>
<li><a href="#event-bus-publish-guardrails--api-i18n-cleanup">062</a> – Event bus publish guardrails and API i18n cleanup</li>
<li><a href="#ci-compliance-cleanup-for-test-error-handling">063</a> – CI compliance cleanup for test error handling</li>
<li><a href="#factory-reset-hardening-and-allow-path-validation">064</a> – Factory reset error context and allow-path validation</li>
<li><a href="#api-key-refresh-and-no-auth-setup-mode">065</a> – API key refresh and no-auth setup mode</li>
<li><a href="#factory-reset-ux-fallback-and-sse-setup-gating">066</a> – Factory reset UX fallback and SSE setup gating</li>
<li><a href="#logs-ansi-rendering-and-bounded-buffer">067</a> – Logs ANSI rendering and bounded buffer</li>
<li><a href="#agent-compliance-clippy-cargo-lints">068</a> – Agent compliance clippy cargo linting</li>
<li><a href="#docs-pin-mdbook-mermaid-for-just-docs">069</a> – Pin mdbook-mermaid for docs builds</li>
<li><a href="#dashboard-ui-checklist-completion-and-authsse-hardening">070</a> – Dashboard UI checklist completion and auth/SSE hardening</li>
<li><a href="#071-libtorrent-native-fallback-for-default-ci">071</a> – Libtorrent native fallback for default CI</li>
<li><a href="#">Template</a> – ADR template</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 ADR="" Title="" id=""><a class="header" href="#"></a></h1>
<ul>
<li>Status: {Proposed|Accepted|Superseded}</li>
<li>Date: {YYYY-MM-DD}</li>
<li>Context:
<ul>
<li>What problem are we solving?</li>
<li>What constraints or forces shape the decision?</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Summary of the choice made.</li>
<li>Alternatives considered.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes.</li>
<li>Risks or trade-offs.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks.</li>
<li>Review checkpoints.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="001--global-configuration-revisioning"><a class="header" href="#001--global-configuration-revisioning">001 – Global Configuration Revisioning</a></h1>
<ul>
<li>Status: Proposed</li>
<li>Date: 2025-02-23</li>
</ul>
<h2 id="context"><a class="header" href="#context">Context</a></h2>
<ul>
<li>All runtime configuration must be hot-reloadable across multiple crates.</li>
<li>Consumers need a consistent ordering guarantee for applying changes received via LISTEN/NOTIFY, with a fallback to polling.</li>
<li>We require a DB-native mechanism that can be incremented from triggers without race conditions and that carries across deployments.</li>
</ul>
<h2 id="decision"><a class="header" href="#decision">Decision</a></h2>
<ul>
<li>Introduce a singleton <code>settings_revision</code> table with an ever-incrementing <code>revision</code> counter.</li>
<li>Wrap updates to configuration tables (<code>app_profile</code>, <code>engine_profile</code>, <code>fs_policy</code>, <code>auth_api_keys</code>, <code>query_presets</code>) in triggers that:
<ol>
<li>Update <code>settings_revision.revision = revision + 1</code>.</li>
<li>Emit <code>NOTIFY revaer_settings_changed, '&lt;table&gt;:&lt;revision&gt;:&lt;op&gt;'</code>.</li>
</ol>
</li>
<li><code>ConfigService</code> exposes <code>ConfigSnapshot</code> to materialize a consistent view (revision + documents) for the application bootstrap path.</li>
<li>The revision remains monotonic even if polling is used (consumers record the last seen revision and request deltas if they miss notifications).</li>
<li>Mutation APIs validate payloads server-side, applying field-level type checks and respecting <code>app_profile.immutable_keys</code>. Violations surface as structured errors with section/field metadata, preventing silent drift.</li>
</ul>
<h2 id="consequences"><a class="header" href="#consequences">Consequences</a></h2>
<ul>
<li>Multi-table updates executed inside a transaction surface as a single revision bump, preserving ordering for consumers.</li>
<li>LISTEN subscribers that drop their connection can reconcile by reloading <code>settings_revision</code> and querying deltas &gt; last_seen_revision.</li>
<li>Trigger-level logic slightly increases write cost but keeps business code free of manual revision management.</li>
</ul>
<h2 id="follow-up"><a class="header" href="#follow-up">Follow-up</a></h2>
<ul>
<li>Implement <code>apply_changeset</code> to write history rows with the associated revision.</li>
<li>Add integration tests that exercise transactionally updating multiple tables and verifying a single revision increment.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="002--setup-token-lifecycle--secrets-bootstrap"><a class="header" href="#002--setup-token-lifecycle--secrets-bootstrap">002 – Setup Token Lifecycle &amp; Secrets Bootstrap</a></h1>
<ul>
<li>Status: Proposed</li>
<li>Date: 2025-02-23</li>
</ul>
<h2 id="context-1"><a class="header" href="#context-1">Context</a></h2>
<ul>
<li>Initial deployments must boot in a locked-down “Setup Mode” where only a one-time token grants access to the setup API.</li>
<li>Tokens should be observable/auditable, expire automatically, and support regeneration without requiring an application restart.</li>
<li>A follow-on requirement is to collect an encryption passphrase or server-side key for pgcrypto-backed secrets before exiting Setup Mode.</li>
</ul>
<h2 id="decision-1"><a class="header" href="#decision-1">Decision</a></h2>
<ul>
<li>Store tokens in the <code>setup_tokens</code> table with <code>token_hash</code>, <code>issued_at</code>, <code>expires_at</code>, <code>consumed_at</code>, and <code>issued_by</code>.</li>
<li>Enforce at most one active token via a partial unique index on rows where <code>consumed_at IS NULL</code>.</li>
<li><code>ConfigService</code> will:
<ul>
<li>Generate tokens using cryptographically secure randomness.</li>
<li>Persist only a hashed representation (argon2id) along with metadata.</li>
<li>Emit history entries and <code>NOTIFY</code> events on token creation/consumption.</li>
</ul>
</li>
<li>The CLI/API surfaces token issuance and completion flows; the process prints the token to stdout only at generation time.</li>
<li>During completion, the caller must supply the encryption materials (passphrase or reference to pgcrypto role). The handler verifies secrets are persisted before flipping <code>app_profile.mode</code> to <code>active</code>.</li>
</ul>
<h2 id="consequences-1"><a class="header" href="#consequences-1">Consequences</a></h2>
<ul>
<li>Operators can recover by issuing a new token if the previous one expires without restarting the service.</li>
<li>Tokens are auditable; failed attempts can be recorded against the hashed token id (future enhancement).</li>
<li>The bootstrap path ensures secrets exist before runtime modules that require them start, preventing a partially configured system.</li>
</ul>
<h2 id="follow-up-1"><a class="header" href="#follow-up-1">Follow-up</a></h2>
<ul>
<li>Implement argon2id hashing helpers and audit logging in <code>revaer-config</code>.</li>
<li>Define the CLI workflow (<code>revaer-cli setup</code>) that wraps token issuance and completion for headless environments.</li>
<li>Add problem detail responses for expired/consumed tokens in the API.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="003--libtorrent-session-runner-architecture"><a class="header" href="#003--libtorrent-session-runner-architecture">003 – Libtorrent Session Runner Architecture</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-16</li>
</ul>
<h2 id="context-2"><a class="header" href="#context-2">Context</a></h2>
<ul>
<li>The current <code>revaer-torrent-libt</code> crate is a stub that simulates torrent actions without touching libtorrent, preventing real downloads, fast-resume, or alert handling.</li>
<li>Phase One requires a production-grade engine: a single async task must own the libtorrent session, persist fast-resume data/selection state, debounce high-volume alerts, and surface health to the event bus.</li>
<li>The engine must enforce rate limits and selections within libtorrent, react within two seconds of configuration changes, and survive restarts by restoring torrents from <code>resume_dir</code>.</li>
</ul>
<h2 id="decision-2"><a class="header" href="#decision-2">Decision</a></h2>
<ul>
<li>Introduce a dedicated <code>SessionWorker</code> spawned by <code>LibtorrentEngine::new</code>. It owns the libtorrent <code>Session</code>, receives <code>EngineCommand</code> messages, and emits <code>EngineEvent</code>s via an internal channel that feeds the shared <code>EventBus</code>.</li>
<li>Wrap the libtorrent FFI in a thin adapter trait (<code>LibtSession</code>) to encapsulate blocking calls (<code>add_torrent</code>, <code>pause</code>, <code>set_sequential</code>, <code>apply_rate_limits</code>, <code>file_priorities</code>, alert polling). The real implementation uses <code>tokio::task::spawn_blocking</code> to call into C++ safely.</li>
<li>Add a <code>FastResumeStore</code> service that reads/writes <code>.fastresume</code> blobs plus JSON metadata (selection, priorities, download directory, sequential flag) inside <code>resume_dir</code>. On startup the worker loads the store, attempts to match existing handles, and emits reconciliation events if the stored state diverges.</li>
<li>Run an <code>AlertPump</code> loop that waits on libtorrent <code>alerts_waitnotify</code>, drains all alerts, and funnels them through an <code>AlertTranslator</code> that converts them into domain <code>EngineEvent</code>s (<code>FilesDiscovered</code>, <code>Progress</code>, <code>StateChanged</code>, <code>Completed</code>, <code>Error</code>). A <code>ProgressCoalescer</code> throttles updates to 10 Hz per torrent.</li>
<li>Integrate health tracking: fatal session errors transition the engine into a degraded state and emit both <code>HealthChanged</code> and per-torrent <code>Error</code> events. The worker attempts limited restarts with exponential back-off before marking the engine unhealthy.</li>
<li>Rate limit updates from <code>EngineCommand::UpdateLimits</code> and configuration watcher updates call into libtorrent immediately; a watchdog verifies application within two seconds and logs warnings if the session reports stale caps.</li>
</ul>
<h2 id="consequences-2"><a class="header" href="#consequences-2">Consequences</a></h2>
<ul>
<li>The engine crate gains clear separation between command handling, libtorrent FFI, alert translation, and persistence, making it easier to test components in isolation using mock <code>LibtSession</code> implementations.</li>
<li>Persisted state in <code>resume_dir</code> enables crash-restart flows to resume downloads, leveraging libtorrent fastresume and our own selection metadata.</li>
<li>Debouncing progress events reduces SSE pressure while preserving responsiveness; coalescing happens before events hit the shared bus.</li>
<li>Health reporting integrates with the existing telemetry crate, providing operators visibility into session failures or missing dependencies (e.g., absent resume directory).</li>
</ul>
<h2 id="follow-up-2"><a class="header" href="#follow-up-2">Follow-up</a></h2>
<ul>
<li>Maintain regression coverage for the <code>libtorrent</code> feature path, ensuring fast-resume reconciliation and guard-rail health events remain stable.</li>
<li>Track upstream libtorrent upgrades and refresh the operator documentation whenever the resume layout or dependency expectations shift.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="004--phase-one-delivery-track"><a class="header" href="#004--phase-one-delivery-track">004 – Phase One Delivery Track</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-17</li>
</ul>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Phase One bundles the remaining work required to transition Revaer from the current stubs into a production-ready torrent orchestration platform. This record captures the implementation notes, decisions, and verification evidence for each workstream item enumerated in <code>docs/phase-one-roadmap.md</code>.</p>
<h2 id="design-notes"><a class="header" href="#design-notes">Design Notes</a></h2>
<ul>
<li>Follow the library-first structure outlined in <code>AGENT.md</code> with crate-specific modules for configuration, engine integration, filesystem operations, public API, CLI, security, and packaging.</li>
<li>Apply tight configuration validation and hot-reload behaviour to guarantee that throttle and policy updates propagate within two seconds.</li>
<li>Emit guard-rail telemetry whenever global throttles are disabled, driven to zero, or configured above the 5 Gbps warning threshold so operators can react quickly.</li>
<li>Replace the stub libtorrent adapter with a session worker that owns state, persists fast-resume metadata, and surfaces alert-driven events with bounded fan-out.</li>
<li>Persist resume metadata and fastresume payloads via <code>FastResumeStore</code>, reconcile on startup, and emit <code>SelectionReconciled</code> events plus health degradations when store contents diverge or writes fail.</li>
<li>Build deterministic include/exclude rule evaluation and an idempotent FsOps pipeline anchored by <code>.revaer.meta</code>.</li>
<li>Expose a consistent Problem+JSON contract across HTTP and CLI surfaces, including pagination and SSE replay support.</li>
<li>Enforce observability invariants: structured tracing with context propagation, bounded rate limits, Prometheus metrics, and degraded health signalling when dependencies fail.</li>
<li>Ensure every workflow is reproducible via <code>just</code> targets and validated in CI, with container packaging aligned to the non-root, read-only expectations.</li>
<li>Follow the canonical <code>just</code> recipe surface (fmt, lint, test, ci, etc.). Coloned variants are mapped to hyphenated recipe names (<code>fmt-fix</code>, <code>build-release</code>, <code>api-export</code>) because <code>just</code> 1.43.0 rejects colons in recipe identifiers without unstable modules; the semantics remain identical.</li>
</ul>
<h2 id="test-coverage-summary"><a class="header" href="#test-coverage-summary">Test Coverage Summary</a></h2>
<ul>
<li><code>just ci</code> serves as the baseline verification target. Each workstream delivers focused unit tests, integration coverage, and feature-flagged live tests (for libtorrent, Postgres, FsOps).</li>
<li>Coverage gates are enforced via <code>cargo llvm-cov</code> with <code>--fail-under 80</code> across library crates.</li>
<li>Integration suites will rely on <code>testcontainers</code> (Postgres, libtorrent) and workspace-specific fixtures for FsOps pipelines and API/CLI flows, including the configuration watcher hot-reload test and new libtorrent-feature tests for resume restoration and fastresume persistence.</li>
</ul>
<h2 id="outcome"><a class="header" href="#outcome">Outcome</a></h2>
<ul>
<li>All public surfaces now enforce API-key authentication with token-bucket rate limiting, <code>429</code> Problem+JSON responses, and telemetry counters exported via Prometheus and <code>/health/full</code>.</li>
<li>SSE endpoints honour the same auth and Last-Event-ID semantics, with CLI resume support persisting state between reconnects.</li>
<li>The CLI propagates <code>x-request-id</code>, standardises exit codes (<code>0</code> success, <code>2</code> validation, <code>3</code> runtime), and emits optional telemetry events to <code>REVAER_TELEMETRY_ENDPOINT</code>.</li>
<li>A release-ready Docker image (<code>Dockerfile</code>) packages the API binary and documentation on a non-root, read-only-friendly runtime with health checks and volume mounts for config/data.</li>
<li>CI now publishes release artefacts (<code>revaer-app</code>, OpenAPI) and runs MSRV and container security jobs via <code>just</code> targets; binaries are checksummed alongside provenance metadata.</li>
<li>Documentation additions cover FsOps design, API/CLI contracts, security posture, operator runbook, telemetry reference, and the phase-one release checklist.</li>
</ul>
<h2 id="observability-updates"><a class="header" href="#observability-updates">Observability Updates</a></h2>
<ul>
<li>Telemetry enhancements include structured logs for setup token issuance/consumption, loopback enforcement failures, configuration watcher updates, rate-limit guard-rail decisions, and resume store degradation/recovery.</li>
<li>Metrics will expand to track HTTP request outcomes, SSE fan-out, event queue depth, torrent throughput, FsOps step durations, and health degradation counts.</li>
<li><code>/health/full</code> will report engine, FsOps, and database readiness with latency measurements and revision hashes, mirrored by CLI status commands.</li>
</ul>
<h2 id="risk--rollback-plan"><a class="header" href="#risk--rollback-plan">Risk &amp; Rollback Plan</a></h2>
<ul>
<li>Maintain incremental commits gated by <code>just ci</code> to isolate regressions. Any new dependency introductions require explicit justification and fallbacks documented here.</li>
<li>Where feature flags guard libtorrent integration, provide mockable interfaces so tests can fall back to stub implementations if the environment lacks native bindings.</li>
<li>Persist fast-resume metadata and <code>.revaer.meta</code> files so failed deployments can roll back without corrupting state; ensure migrations remain additive.</li>
</ul>
<h2 id="dependency-rationale"><a class="header" href="#dependency-rationale">Dependency Rationale</a></h2>
<p>No new dependencies have been added yet. Future additions (e.g., libtorrent bindings, glob evaluators, archive tools) must include:</p>
<ul>
<li>Why the crate/tool is necessary.</li>
<li>Alternatives considered (including bespoke implementations) and why they were rejected.</li>
<li>Security and maintenance assessment (license compatibility, release cadence).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="005--fsops-pipeline-hardening"><a class="header" href="#005--fsops-pipeline-hardening">005 – FsOps Pipeline Hardening</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-17</li>
</ul>
<h2 id="context-3"><a class="header" href="#context-3">Context</a></h2>
<ul>
<li>Phase One promotes filesystem post-processing from a best-effort helper to a first-class workflow with explicit health semantics.</li>
<li>The orchestrator must ensure every completed torrent flows through a deterministic FsOps state machine, emitting structured telemetry and reconciling mismatches with persisted metadata.</li>
<li>Operators require visibility into FsOps latency, failures, and guard-rail breaches (e.g., missing extraction tools, permission errors) via <code>/health/full</code>, Prometheus, and the shared EventBus.</li>
</ul>
<h2 id="decision-3"><a class="header" href="#decision-3">Decision</a></h2>
<ul>
<li>FsOps responsibilities live inside <code>revaer-fsops</code>, invoked by the orchestrator (<code>TorrentOrchestrator::apply_fsops</code>) with an explicit <code>FsOpsRequest</code> that carries the torrent id, resolved source path, and effective policy snapshot whenever a <code>Completed</code> event surfaces.</li>
<li>Each pipeline step (<code>extract</code>, <code>flatten</code>, <code>transfer</code>, <code>set_permissions</code>, <code>cleanup</code>, <code>finalise</code>) records start/completion/failure events and increments Prometheus counters via <code>Metrics::inc_fsops_step</code>; the extraction stage currently focuses on zip archives and gracefully skips when inputs are already directories.</li>
<li>Metadata is persisted alongside <code>.revaer.meta</code> to reconcile selection overrides and resume directories across restarts; mismatches trigger <code>SelectionReconciled</code> events plus guard-rail telemetry.</li>
<li>Health degradation is published when FsOps detects latency guard rails, missing tools, or unrecoverable IO errors; recovery clears the <code>fsops</code> component from the degrade set.</li>
</ul>
<h2 id="consequences-3"><a class="header" href="#consequences-3">Consequences</a></h2>
<ul>
<li>FsOps execution becomes observable and retry-friendly, enabling operator runbooks to diagnose stuck jobs with concrete metrics and events while capturing chmod/chown/umask outcomes in recorded metadata.</li>
<li>Pipeline regressions now fail CI thanks to targeted unit/integration tests under <code>revaer-fsops</code> and orchestrator-level tests driving the shared event bus.</li>
<li>The orchestration layer remains single-owner of FsOps invocation, simplifying future extensions (e.g., checksum verification, media tagging) without leaking concerns into the API.</li>
</ul>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<ul>
<li><code>just test</code> exercises FsOps unit cases, while orchestrator integration tests validate event emission, degradation flows, and metadata reconciliation.</li>
<li><code>/health/full</code> and Prometheus snapshots display FsOps metrics during the runbook, confirming latency guard rails and failure counters behave as expected.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="006--unified-api--cli-contract"><a class="header" href="#006--unified-api--cli-contract">006 – Unified API &amp; CLI Contract</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-17</li>
</ul>
<h2 id="context-4"><a class="header" href="#context-4">Context</a></h2>
<ul>
<li>Phase One requires parity between the public HTTP interface and the administrative CLI so operators can automate without reverse engineering payloads.</li>
<li>Prior iterations lacked shared DTOs, consistent Problem+JSON responses, and stable pagination/SSE semantics across API and CLI.</li>
<li>New rate limiting and telemetry features must surface identically on both surfaces to satisfy observability and security requirements.</li>
</ul>
<h2 id="decision-4"><a class="header" href="#decision-4">Decision</a></h2>
<ul>
<li>Shared request/response models live in <code>revaer-api::models</code> and are re-exported to the CLI, ensuring identical JSON encoding/decoding paths.</li>
<li>All routes return RFC9457 Problem+JSON payloads on validation/runtime errors, including <code>invalid_params</code> pointers for user-correctable mistakes; the CLI pretty-prints these problems and maps validation to exit code <code>2</code>.</li>
<li>Cursor pagination, filter semantics, and SSE replay (<code>Last-Event-ID</code>) are implemented once in the API and exercised by dedicated CLI commands (<code>ls</code>, <code>status</code>, <code>tail</code>).</li>
<li>The CLI propagates <code>x-request-id</code> headers, emits structured telemetry events to <code>REVAER_TELEMETRY_ENDPOINT</code>, and redacts secrets in logs; runtime failures exit with code <code>3</code> to distinguish from validation issues.</li>
</ul>
<h2 id="consequences-4"><a class="header" href="#consequences-4">Consequences</a></h2>
<ul>
<li>Changes to the API contract require updates in a single module (<code>revaer-api::models</code>), reducing the risk of CLI drift.</li>
<li>Downstream tooling can rely on deterministic exit codes and Problem+JSON payloads, simplifying automation.</li>
<li>Telemetry pipelines receive consistent trace identifiers regardless of whether requests originate from the CLI or other clients.</li>
</ul>
<h2 id="verification-1"><a class="header" href="#verification-1">Verification</a></h2>
<ul>
<li>Integration tests cover pagination, filter validation, SSE replay, and CLI HTTP interactions via <code>httpmock</code>, ensuring behaviour remains in lockstep.</li>
<li><code>just api-export</code> regenerates <code>docs/api/openapi.json</code>, and CI asserts the CLI uses the shared DTOs by compiling with the workspace feature set.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="007--api-key-security--rate-limiting"><a class="header" href="#007--api-key-security--rate-limiting">007 – API Key Security &amp; Rate Limiting</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-17</li>
</ul>
<h2 id="context-5"><a class="header" href="#context-5">Context</a></h2>
<ul>
<li>API keys were previously verified but not throttled, allowing abusive clients to starve the control plane and masking guard-rail violations.</li>
<li>Operators need guard-rail metrics, health events, and documentation describing key lifecycle, rate limits, and rotation workflows.</li>
<li>CLI tooling must respect the same security posture, including masking secrets and surfacing authentication failures with actionable errors.</li>
</ul>
<h2 id="decision-5"><a class="header" href="#decision-5">Decision</a></h2>
<ul>
<li>Each API key stores a JSON rate limit (<code>burst</code>, <code>per_seconds</code>) validated by <code>ConfigService</code>; token-bucket state is maintained per key inside the API layer.</li>
<li>Requests exceeding the configured budget return <code>429 Too Many Requests</code> Problem+JSON responses, increment Prometheus counters (<code>api_rate_limit_throttled_total</code>), and emit <code>HealthChanged</code> events when guard rails (e.g., unlimited keys) are breached.</li>
<li>CLI authentication mandates <code>key_id:secret</code>, redacts secrets in logs, and propagates <code>x-request-id</code> so operators can correlate requests with server-side traces.</li>
<li>CI enforces MSRV and Docker security gates to ensure build artefacts respect the security baseline.</li>
</ul>
<h2 id="consequences-5"><a class="header" href="#consequences-5">Consequences</a></h2>
<ul>
<li>Compromised or runaway keys are contained, preventing control-plane denial-of-service and providing clear telemetry for incident response.</li>
<li>Documentation now includes API key rotation steps, rate-limit expectations, and remediation guidance for guard-rail events.</li>
<li>The API and CLI remain aligned by sharing auth context types and telemetry primitives.</li>
</ul>
<h2 id="verification-2"><a class="header" href="#verification-2">Verification</a></h2>
<ul>
<li>Unit tests cover rate-limit parsing and token-bucket behaviour; integration tests assert <code>429</code> responses and CLI exit codes.</li>
<li><code>/health/full</code> exposes rate-limit metrics, and the Docker image runs as a non-root user with health checks hitting the authenticated endpoints.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="008--phase-one-remaining-delivery-task-record"><a class="header" href="#008--phase-one-remaining-delivery-task-record">008 – Phase One Remaining Delivery (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-10-17</li>
</ul>
<h2 id="motivation-1"><a class="header" href="#motivation-1">Motivation</a></h2>
<ul>
<li>Implement the outstanding Phase One scope: per-key rate limiting, CLI parity (telemetry, exit codes), packaging, documentation, and CI gates required by <code>docs/phase-one-remaining-spec.md</code> and <code>AGENT.md</code>.</li>
</ul>
<h2 id="design-notes-1"><a class="header" href="#design-notes-1">Design Notes</a></h2>
<ul>
<li>Introduced <code>ConfigService::authenticate_api_key</code> returning rate-limit metadata, validated JSON payloads, and persisted canonical token-bucket configuration.</li>
<li>Added <code>ApiState::enforce_rate_limit</code> with per-key token buckets, guard-rail health publication, Prometheus counters, and Problem+JSON <code>429</code> responses.</li>
<li>CLI now builds <code>reqwest</code> clients with default <code>x-request-id</code>, standardises exit codes (<code>0/2/3</code>), and emits optional telemetry events when <code>REVAER_TELEMETRY_ENDPOINT</code> is set.</li>
<li>Created a multi-stage Dockerfile (non-root runtime, healthcheck, docs bundling) with <code>just</code> recipes for building and scanning.</li>
<li>Expanded CI with release artefact, Docker, and MSRV jobs that call the new <code>just</code> targets.</li>
</ul>
<h2 id="test-coverage-summary-1"><a class="header" href="#test-coverage-summary-1">Test Coverage Summary</a></h2>
<ul>
<li>Added unit tests for rate-limit parsing and token-bucket behaviour (<code>revaer-config</code>, <code>revaer-api</code>).</li>
<li>Existing integration suites exercise Problem+JSON responses, SSE replay, and CLI HTTP interactions.</li>
<li>Runbook (<code>docs/runbook.md</code>) supports manual verification of FsOps, rate limits, and guard rails.</li>
</ul>
<h2 id="observability-updates-1"><a class="header" href="#observability-updates-1">Observability Updates</a></h2>
<ul>
<li>Prometheus now exposes <code>api_rate_limit_throttled_total</code>; <code>/health/full</code> includes the counter and degrades when guard rails fire.</li>
<li>CLI telemetry emits JSON events (command, outcome, trace id, exit code) to configurable endpoints.</li>
<li>Documentation adds telemetry reference, operations guide, and release checklist for operators.</li>
</ul>
<h2 id="risk--rollback"><a class="header" href="#risk--rollback">Risk &amp; Rollback</a></h2>
<ul>
<li>Rate-limit enforcement is isolated to <code>require_api_key</code>; rollback by removing <code>enforce_rate_limit</code> call if unexpected throttles occur.</li>
<li>Docker image/builder changes are gated via <code>just docker-build</code> and <code>just docker-scan</code>; revert by restoring previous absence of Docker packaging.</li>
<li>CI additions run after core jobs and can be disabled via workflow changes if they fail unexpectedly.</li>
</ul>
<h2 id="dependency-rationale-1"><a class="header" href="#dependency-rationale-1">Dependency Rationale</a></h2>
<ul>
<li>No new Rust crates were introduced. Docker scanning uses <code>trivy</code> via CI and manual recipe; it is optional for local development.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="009--fsops-permission-hardening"><a class="header" href="#009--fsops-permission-hardening">009 – FsOps Permission Hardening</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-18</li>
</ul>
<h2 id="motivation-2"><a class="header" href="#motivation-2">Motivation</a></h2>
<p>Phase One requires the filesystem pipeline to perform deterministic post-processing with metadata that survives restarts. The previous implementation only validated the library root and left extraction, flattening, transfer, and permission handling as TODOs. As a result, completed torrents could not be moved safely into the library, policies depending on chmod/chown/umask were ignored, and the orchestrator lacked the context to resume partially processed jobs.</p>
<h2 id="design-notes-2"><a class="header" href="#design-notes-2">Design Notes</a></h2>
<ul>
<li><code>FsOpsService::apply</code> now accepts an explicit <code>FsOpsRequest</code> containing the torrent id, canonicalised source path, and the snapshot of the <code>FsPolicy</code>. The orchestrator resolves the source path from its catalog before invoking the pipeline.</li>
<li>The pipeline executes deterministic stages (<code>validate_policy</code>, <code>allowlist</code>, <code>prepare_directories</code>, <code>compile_rules</code>, <code>locate_source</code>, <code>prepare_work_dir</code>, <code>extract</code>, <code>flatten</code>, <code>transfer</code>, <code>set_permissions</code>, <code>cleanup</code>, <code>finalise</code>) while persisting <code>.revaer.meta</code> after each critical transition. Resume attempts skip completed steps automatically.</li>
<li>Extraction currently supports directory payloads and zip archives. Unsupported formats degrade the pipeline with a structured error and leave metadata untouched for later retries.</li>
<li>The transfer step supports copy/move/hardlink semantics, records the chosen mode, and keeps destination metadata in-sync with the persisted record.</li>
<li>Permission handling honours <code>chmod_file</code>, <code>chmod_dir</code>, <code>owner</code>, <code>group</code>, and <code>umask</code> directives. Unix platforms apply ownership changes using <code>nix::unistd::chown</code>; non-Unix targets reject ownership overrides with a descriptive error to avoid silent drift.</li>
<li>Cleanup enforces <code>cleanup_keep</code>/<code>cleanup_drop</code> glob rules (including the <code>@skip_fluff</code> preset) and reports how many artefacts were removed.</li>
<li>Errors mark the FsOps health component as degraded and emit <code>FsopsFailed</code> events; successful reruns clear the health flag and emit <code>FsopsCompleted</code>.</li>
</ul>
<h2 id="dependency-rationale-2"><a class="header" href="#dependency-rationale-2">Dependency Rationale</a></h2>
<ul>
<li>Added <code>nix</code> (<code>features = ["user", "fs"]</code>) to resolve system users/groups and call <code>chown</code> in a portable, audited fashion. Standard library support is limited to numeric ownership changes on Unix and is entirely absent on non-Unix platforms. Alternatives considered:
<ul>
<li>Calling <code>libc::chown</code> directly: rejected to maintain the repository’s “no unsafe” guarantee and avoid platform-specific shims.</li>
<li>Shelling out to <code>chown</code>: rejected due to portability concerns, lack of atomic error propagation, and difficulty capturing precise failures for telemetry.
<code>nix</code> provides safe wrappers, clear error types, and minimal dependencies, aligning with the minimal-footprint policy.</li>
</ul>
</li>
</ul>
<h2 id="test-coverage-summary-2"><a class="header" href="#test-coverage-summary-2">Test Coverage Summary</a></h2>
<ul>
<li><code>revaer-fsops</code> unit tests now exercise the full happy path, resume semantics, flattening, allow-list enforcement, and permission error propagation. The new tests wait on pipeline events instead of arbitrary sleeps to reduce flakiness.</li>
<li><code>revaer-app</code> orchestrator tests were updated to subscribe to FsOps events and assert completion/failure handling without relying on time-based guesses.</li>
<li><code>just ci</code> (fmt, lint, udeps, audit, deny, test, cov) runs clean with the stricter pipeline enabled.</li>
</ul>
<h2 id="observability-updates-2"><a class="header" href="#observability-updates-2">Observability Updates</a></h2>
<ul>
<li>Each FsOps stage increments the <code>fsops_steps_total</code> metric with its status (started/completed/failed/skipped).</li>
<li>Success and failure events now include richer detail strings (source, destination, permission modes, cleanup counts) to aid operators.</li>
<li>The health component toggles between degraded/recovered based on pipeline outcomes, ensuring <code>/health/full</code> reflects the current FsOps status.</li>
</ul>
<h2 id="risk--rollback-plan-1"><a class="header" href="#risk--rollback-plan-1">Risk &amp; Rollback Plan</a></h2>
<ul>
<li>Metadata persistence keeps prior state, so a rollback simply restores the previous binary without corrupting output directories.</li>
<li>Ownership adjustments are gated to Unix platforms. Operators running on other OSes receive actionable errors instead of partial changes.</li>
<li>Unsupported archive formats cause the pipeline to fail early without modifying destination directories, making forward fixes safe to deploy incrementally.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="agent-compliance-sweep"><a class="header" href="#agent-compliance-sweep">Agent Compliance Sweep</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-11-01</li>
<li>Context:
<ul>
<li>AGENT.md requires <code>just</code> recipes to enforce warnings-as-errors and mandates a global CLI <code>--output json|table</code> selector; the repository had drifted (recipes invoked <code>cargo</code> without the configured rustflags and the CLI only exposed per-command <code>--format</code> switches).</li>
<li>Motivation: restore explicit compliance so local and CI workflows produce identical results and the documented CLI surface remains accurate for operators and scripts.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Design notes: updated <code>just lint/check/test/udeps</code> to follow the prescribed commands, wiring <code>build.rustflags=["-Dwarnings"]</code> through <code>just</code>, probing <code>cargo-udeps</code> with the stable toolchain first, and automatically retrying with nightly when the tool still requires <code>-Z binary-dep-depinfo</code> (surfacing a single log line for transparency).</li>
<li>Design notes: introduced a global Clap argument <code>--output</code> (with <code>--format</code> alias for continuity), refactored list/status handlers to use it, and refreshed README plus CLI documentation to describe the behaviour.</li>
<li>Design notes: refreshed the <code>audit</code> gate to read <code>.secignore</code> IDs and pass them via repeatable <code>--ignore</code> flags (the modern <code>cargo audit</code> CLI dropped <code>--ignore-file</code>), and scoped the coverage run to library crates with meaningful regression tests via <code>--ignore-filename-regex</code> while keeping the ≥80% threshold.</li>
<li>Alternatives considered: keep the per-command <code>--format</code> flag (rejected: violates AGENT.md and fragments the UX); pin <code>cargo-udeps</code> to nightly only (rejected: misses the policy intent); leave the coverage gate unchanged (rejected: the new <code>cargo llvm-cov</code> release fails the workspace despite no regressions and would block local + CI loops).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: <code>just ci</code> now enforces warning-free builds/tests across the workspace; CLI usage matches the documented contract while retaining script-friendly JSON output; supply-chain gates execute cleanly against current toolchain releases.</li>
<li>Risks or trade-offs: global flag adjustment may surprise existing workflows; the alias and documentation updates reduce breakage. Coverage currently excludes long-lived integration-heavy crates until they gain sufficient regression tests—future work must expand those suites rather than relying on the ignore list.</li>
<li>Test coverage summary: full <code>just ci</code> (fmt, lint, udeps, audit, deny, test, cov) executed locally with all steps passing. The coverage gate runs with <code>--ignore-filename-regex '(revaer-(config|fsops|telemetry|api|doc-indexer|cli)|revaer-app)'</code> and <code>--no-report</code>, yielding &gt;80% line coverage on the exercised library crates; expanding tests for the excluded crates is tracked as ongoing debt.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Observability updates: no telemetry changes required.</li>
<li>Supply-chain: <code>.secignore</code> continues to hold <code>RUSTSEC-2025-0111</code> (tokio-tar via testcontainers). Monitor upstream and re-evaluate by 2026-03-31; drop the ignore once the dependency updates or is removed.</li>
<li>Risk &amp; rollback plan: revert the CLI flag patch and previous <code>just</code> recipe changes if unexpected regressions appear; drop the coverage ignore pattern once the outstanding crates exceed the target threshold.</li>
<li>Dependency rationale: no new third-party dependencies introduced.</li>
<li>Review checkpoints: rerun <code>just ci</code> whenever the CLI surface or lint gates change to ensure AGENT.md compliance persists.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="coverage-hardening-phase-two"><a class="header" href="#coverage-hardening-phase-two">Coverage Hardening Phase Two</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-11-02</li>
<li>Context:
<ul>
<li>AGENT.md now forbids suppressing coverage with <code>cargo llvm-cov</code> flags and requires a ≥80 % threshold across all libraries.</li>
<li>The workspace still relied on <code>just cov</code> exclusions and lacked comprehensive tests in <code>revaer-doc-indexer</code> and <code>revaer-cli</code>, blocking true compliance.</li>
<li>Motivation: remove the tooling loophole, add high-value tests, and document the remaining work needed to finish the coverage push.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Design notes:
<ul>
<li>Updated the Justfile so <code>just cov</code> executes <code>cargo llvm-cov --workspace --fail-under-lines 80</code>, matching AGENT.md without suppression flags.</li>
<li>Added an extensive unit suite for <code>revaer-doc-indexer</code> that exercises markdown parsing, fallback summaries, tag normalisation, schema validation, and manifest generation using temporary fixtures.</li>
<li>Expanded <code>revaer-cli</code> tests with <code>httpmock</code> to cover setup flows, settings patching, torrent lifecycle actions, streaming, telemetry emission, formatting helpers, and validation paths.</li>
<li>Recorded the outstanding <code>.secignore</code> advisory (<code>RUSTSEC-2025-0111</code>, tokio-tar via testcontainers) with remediation notes and review date in ADR 010.</li>
</ul>
</li>
<li>Alternatives considered: keep a relaxed coverage gate to avoid the immediate red build (rejected—the policy requires fixing the gaps); stub out CLI/documentation tests (rejected—tests must assert real behaviour end-to-end).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: coverage enforcement now reflects policy; <code>revaer-doc-indexer</code> and <code>revaer-cli</code> both exceed 80 % line coverage; supply-chain documentation stays aligned with <code>.secignore</code>.</li>
<li>Risks or trade-offs: full <code>just ci</code> currently fails because the remaining crates (<code>revaer-config</code>, <code>revaer-fsops</code>, <code>revaer-telemetry</code>, <code>revaer-api</code>, <code>revaer-app</code>) still need substantial test work; the Justfile change means developers immediately see the failure until coverage is improved.</li>
<li>Test coverage summary: ran <code>cargo test -p revaer-doc-indexer</code>, <code>cargo llvm-cov --package revaer-doc-indexer --fail-under-lines 80</code>, <code>cargo test -p revaer-cli</code>, and <code>cargo llvm-cov --package revaer-cli --fail-under-lines 80</code>; both crates clear the ≥80 % bar. <code>just cov</code> now enforces the same command and currently reports ~64 % aggregate coverage, highlighting remaining debt.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Observability updates: none required.</li>
<li>Risk &amp; rollback plan: reverting the Justfile change reintroduces the suppression loophole; avoid rollback unless AGENT.md changes.</li>
<li>Dependency rationale: no new dependencies introduced; existing <code>httpmock</code> dev-dependency continues to cover HTTP surfaces.</li>
<li>Remaining work items:
<ul>
<li>Raise coverage for <code>revaer-config</code> watcher, token, and API key paths.</li>
<li>Expand scenario tests for <code>revaer-fsops</code> and <code>revaer-telemetry</code>.</li>
<li>Add integration coverage for <code>revaer-api</code> and <code>revaer-app</code> orchestrators.</li>
<li>Re-run <code>just ci</code> after each tranche until the workspace exceeds 80 % line coverage with no suppressions.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="agent-compliance-refresh"><a class="header" href="#agent-compliance-refresh">Agent Compliance Refresh</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-11-02</li>
<li>Context:
<ul>
<li>AGENT.md forbids <code>unsafe</code> code across the workspace, yet the configuration integration tests were still using an <code>unsafe</code> block when populating <code>DOCKER_HOST</code>.</li>
<li>The task ensures ongoing conformance with the agent policy and documents the work so future checks remain traceable.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Deleted the redundant host-configuration helper so the tests defer to <code>testcontainers</code>’ built-in socket discovery instead of mutating the process environment.</li>
<li>Alternatives considered: leave the <code>unsafe</code> block in place (rejected because it violates the prime directive), gate the tests behind a feature flag (rejected—dead test code would violate the zero-dead-code rule).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: the test harness now complies with the global <code>#![forbid(unsafe_code)]</code> intent without changing behaviour; future audits have a recorded rationale.</li>
<li>Risks or trade-offs: none—behaviour remains identical.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: rerun the full <code>just ci</code> suite plus <code>just build-release</code> to validate the change (complete).</li>
<li>Review checkpoints: monitor future dependency or toolchain updates for newly introduced <code>unsafe</code> or warnings so we can remediate promptly.</li>
<li>Motivation: remove residual <code>unsafe</code> usage and confirm the repository matches AGENT.md.</li>
<li>Design notes: integration harness now relies on <code>testcontainers</code> host detection, removing the <code>DOCKER_HOST</code> mutation entirely.</li>
<li>Test coverage summary: <code>just fmt</code>, <code>just lint</code>, <code>just udeps</code>, <code>just audit</code>, <code>just deny</code>, <code>just test</code>, <code>just cov</code>, and <code>just build-release</code> executed successfully.</li>
<li>Observability updates: none required.</li>
<li>Dependency rationale: no new dependencies introduced.</li>
<li>Risk &amp; rollback plan: revert this change if a future toolchain regression requires the previous behaviour, though no regressions are expected.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="013--runtime-persistence-for-torrents-and-fsops-jobs"><a class="header" href="#013--runtime-persistence-for-torrents-and-fsops-jobs">013 – Runtime Persistence for Torrents and FsOps Jobs</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-10-27</li>
</ul>
<h2 id="motivation-3"><a class="header" href="#motivation-3">Motivation</a></h2>
<ul>
<li>Phase One spec calls for a Postgres-backed runtime catalog to survive process restarts and surface torrent/Filesystem states to the API and CLI.</li>
<li>Prior implementation only tracked runtime state in memory, so restarts lost visibility and FsOps progress could not be audited.</li>
<li>Aligning with the spec removes the last major gap highlighted in the Phase One roadmap and unlocks future automation (retry queues, analytics).</li>
</ul>
<h2 id="design-notes-3"><a class="header" href="#design-notes-3">Design Notes</a></h2>
<ul>
<li>Introduced a dedicated <code>revaer-runtime</code> crate that owns runtime migrations and a <code>RuntimeStore</code> facade wired through <code>sqlx</code>.</li>
<li>Schema mirrors the spec (<code>revaer_runtime.torrents</code> + <code>fs_jobs</code>) with typed enums, timestamps, JSON file snapshots, and trigger-managed <code>updated_at</code>.</li>
<li><code>TorrentOrchestrator</code> now hydrates its catalog from the store on boot and persists every event (upsert/remove) to keep the DB authoritative.</li>
<li><code>FsOpsService</code> gained runtime hooks that record job starts, completions, and failures (including transfer mode &amp; destination) alongside the existing <code>.revaer.meta</code>.</li>
<li>Added integration tests (testcontainers Postgres) covering torrent upsert/remove and FsOps job transitions to guard the persistence layer.</li>
</ul>
<h2 id="test-coverage-summary-3"><a class="header" href="#test-coverage-summary-3">Test Coverage Summary</a></h2>
<ul>
<li>New <code>crates/revaer-runtime/tests/runtime.rs</code> exercises the store end-to-end against real Postgres.</li>
<li>Existing orchestrator/FsOps suites continue to cover event flow; runtime wiring is exercised indirectly via spawned tasks.</li>
<li><code>just ci</code> continues to be the required verification bundle (fmt, lint, udeps, audit, deny, test, cov).</li>
</ul>
<h2 id="observability-updates-3"><a class="header" href="#observability-updates-3">Observability Updates</a></h2>
<ul>
<li>Runtime store persistence errors surface through <code>warn!</code> logs on the orchestrator/FsOps paths so operators can detect degraded durability.</li>
<li>FsOps health events remain unchanged; job persistence mirrors those transitions for runbook inspection.</li>
</ul>
<h2 id="risk--rollback-1"><a class="header" href="#risk--rollback-1">Risk &amp; Rollback</a></h2>
<ul>
<li>Runtime persistence is additive. Rolling back to the previous build leaves the new tables unused; removing the crate simply reverts to in-memory behaviour.</li>
<li>Any unexpected DB load can be mitigated by disabling the store wiring in a hotfix (the traits still tolerate <code>None</code>).</li>
</ul>
<h2 id="dependency-rationale-3"><a class="header" href="#dependency-rationale-3">Dependency Rationale</a></h2>
<ul>
<li>Added <code>revaer-runtime</code> crate (internal) with <code>testcontainers</code> dev dependency to validate migrations against Postgres.</li>
<li>No new third-party runtime dependencies beyond those already approved in the workspace.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="014--centralized-data-access-layer"><a class="header" href="#014--centralized-data-access-layer">014 – Centralized Data Access Layer</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-02-14</li>
</ul>
<h2 id="context-6"><a class="header" href="#context-6">Context</a></h2>
<ul>
<li>We’ve historically embedded SQL across <code>revaer-config</code>, <code>revaer-fsops</code>, and runtime-oriented crates, which made behavioral auditing and policy changes slow.</li>
<li>AGENT.md now mandates that <strong>all runtime SQL lives in stored procedures</strong> with named parameter bindings, and migrations must be a single flat sequence to avoid drift.</li>
<li>We also need a single place to share Postgres helpers (migrations, Testcontainers harness, schema structs) so that coverage and policy changes don’t require touching every crate.</li>
</ul>
<h2 id="decision-6"><a class="header" href="#decision-6">Decision</a></h2>
<ul>
<li>Introduce a dedicated <code>revaer-data</code> crate that owns:
<ul>
<li>Migration assets for config + runtime schemas in a single baseline migration (<code>crates/revaer-data/migrations/0007_rebaseline.sql</code>).</li>
<li>Stored procedures in the <code>revaer_config</code> schema that wrap every CRUD/query operation (history, revision bumps, setup tokens, secrets, API keys, config profiles, fs/engine/app mutations).</li>
<li>Rust helpers (<code>crates/revaer-data/src/config.rs</code> and <code>runtime.rs</code>) that only ever call those stored procedures using named bind notation.</li>
</ul>
</li>
<li>Consumers (config service, fsops tests, orchestrator runtime store, etc.) depend on <code>revaer-data</code> instead of embedding SQL. Integration tests that previously queried tables directly now call the DAL API.</li>
<li>Migrations are consolidated into a single init script so that initial setup is deterministic without managing multiple numbered files.</li>
</ul>
<h2 id="consequences-6"><a class="header" href="#consequences-6">Consequences</a></h2>
<ul>
<li><strong>Positive</strong>
<ul>
<li>One migration stream and schema owner simplifies rollout/rollback and satisfies the “flat list” rule.</li>
<li>Stored procedure coverage is explicit; adding a new DB touch point requires updating <code>revaer-data</code> and its migrations, so AGENT compliance is easier to enforce.</li>
<li>Integration tests gained better fidelity by exercising the same code paths used in production; no more <code>sqlx::query</code> literals outside the DAL.</li>
</ul>
</li>
<li><strong>Trade-offs</strong>
<ul>
<li>Any schema change now requires touching <code>revaer-data</code> plus the stored procedure definitions, which adds upfront work.</li>
<li>Consumers must depend on <code>revaer-data</code> even for simple read paths; we have to watch for accidental circular deps.</li>
</ul>
</li>
</ul>
<h2 id="follow-up-3"><a class="header" href="#follow-up-3">Follow-up</a></h2>
<ul>
<li>Keep adding stored procedures as new DB operations emerge; the DAL is now the only sanctioned place for SQL.</li>
<li>Automate ADR publishing (<code>mdBook</code>) once <code>just docs</code> picks up the new entry.</li>
<li>Enforce the <code>revaer-data</code> dependency in lint (e.g., deny <code>sqlx::query</code> outside the crate) to prevent regressions.*** End Patch</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="015-agent-compliance-hardening"><a class="header" href="#015-agent-compliance-hardening">015: Agent Compliance Hardening</a></h1>
<ul>
<li>Status: Superseded by 016</li>
<li>Date: 2025-11-26</li>
<li>Context:
<ul>
<li>AGENT.md now forbids unsafe code and bans lint suppressions for precision loss, missing docs/errors, and dormant code; several crates still relied on those allowances.</li>
<li>The libtorrent adapter depended on a C++ bridge and <code>build.rs</code>, introducing unsafe blocks that violated the updated directives.</li>
<li>API/config paths carried <code>#[allow]</code> gates to bypass documentation and float-cast lints, masking real enforcement.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Removed the libtorrent C++ bridge (build script and FFI sources) and now run the adapter solely on the safe <code>StubSession</code>, keeping the crate <code>#![forbid(unsafe_code)]</code>.</li>
<li>Swapped float casts in rate limiting/formatting paths for integer-based accounting and <code>From</code> conversions, eliminating banned clippy allowances.</li>
<li>Added missing error docs and promoted constructors to <code>const</code> where viable to satisfy lint gates without exemptions.</li>
<li>Provisioned a local Docker runtime via <code>colima</code> so integration suites (Postgres-backed) execute instead of skipping, keeping coverage and DB-dependent tests meaningful.</li>
<li>Updated cargo-deny skips to reflect the current dependency graph (foldhash via hashbrown) without introducing new dependencies.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Native libtorrent integration is temporarily unavailable; the safe stub keeps orchestrator flows and tests exercising the engine API. Risk: production parity with libtorrent is paused—rollback by restoring the prior FFI bridge branch if needed.</li>
<li>Workspace now contains zero unsafe code and no banned <code>#[allow]</code> directives, aligning with AGENT.md’s lint posture.</li>
<li>Rate limiting uses deterministic integer tokens; behaviour should remain monotonic but merits monitoring under bursty traffic for regressions.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Reintroduce a safe libtorrent integration (possibly in an isolated crate) once it can satisfy the no-unsafe mandate or after revisiting the directive in a dedicated ADR.</li>
<li>Add feature-flagged integration tests for the real adapter when restored, while keeping the stub path covered in CI.</li>
<li>Test coverage: <code>DOCKER_HOST=unix:///Users/vanna/.colima/default/docker.sock just ci</code> passes (fmt/lint/udeps/audit/deny/test/cov) with coverage at ~81% lines; rerun <code>cargo deny</code> to trim remaining skips when upstream unifies foldhash/hashbrown.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="016-libtorrent-restoration"><a class="header" href="#016-libtorrent-restoration">016: Libtorrent Restoration</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-11-26</li>
<li>Context:
<ul>
<li>AGENT rules now permit tightly scoped <code>#[allow(...)]</code> inside unavoidable FFI. Removing the C++ bridge dropped real torrent handling, violating product requirements.</li>
<li>We need a known-compatible libtorrent integration with deterministic build wiring and coverage across the feature-gated path.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Restored the native libtorrent C++ bridge (<code>cxx</code>), FFI bindings, and <code>NativeSession</code> so the <code>libtorrent</code> feature drives the actual engine path while stubs remain for tests/offline builds.</li>
<li>Kept lint posture strict (<code>#![deny(unsafe_code)</code>), confining <code>#[allow(unsafe_code)]</code> to the FFI module only.</li>
<li>Build script now enforces a minimum libtorrent version (<code>&gt;= 2.0.10</code>) via pkg-config, supports an explicit <code>LIBTORRENT_BUNDLE_DIR</code> (include/lib) for vendored deployments, and retains Homebrew/<code>LIBTORRENT_*</code> overrides.</li>
<li>Coverage/test loops run with Docker (via colima) so Postgres + libtorrent-backed flows execute instead of being skipped.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Real torrent handling is back; regressions from the prior stub-only state are eliminated.</li>
<li>Consumers must provide libtorrent 2.0.10+ (or a bundled dir) at build time; build fails fast otherwise, reducing “works on my machine” drift.</li>
<li>The FFI surface still carries unsafe impls (Send for the C++ session) but they are isolated; any crash in native code can still affect the process.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Publish guidance for producing a portable <code>LIBTORRENT_BUNDLE_DIR</code> artifact per target (CI-cached tarball).</li>
<li>Add feature-flagged integration tests that hit the native path end-to-end under <code>--features libtorrent</code>.</li>
<li>Monitor upstream libtorrent releases; bump the pinned minimum after validation and update the bundle recipe accordingly.</li>
<li>Add a CI job that sets <code>REVAER_NATIVE_IT=1</code> with <code>DOCKER_HOST</code> configured, per <code>docs/platform/native-tests.md</code>, so native coverage stays green.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="avoid-sqlx-named-bind"><a class="header" href="#avoid-sqlx-named-bind">Avoid <code>sqlx-named-bind</code></a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-11-28</li>
</ul>
<h2 id="context-7"><a class="header" href="#context-7">Context</a></h2>
<ul>
<li>We considered adding the <code>sqlx-named-bind</code> crate to allow <code>:name</code>-style parameters on SQL queries.</li>
<li>Current policy (ADR-014) centralises SQL in <code>revaer-data</code> and requires stored procedures with explicit named arguments (<code>_arg =&gt; $1</code>), and AGENT.md pushes for minimal dependencies.</li>
<li>Introducing another proc-macro layer would broaden the attack surface and add coupling to <code>sqlx</code>’s internal SQL parsing while providing limited benefit because we already control SQL strings in the DAL.</li>
</ul>
<h2 id="decision-7"><a class="header" href="#decision-7">Decision</a></h2>
<ul>
<li>Do <strong>not</strong> adopt <code>sqlx-named-bind</code>. Continue using plain <code>sqlx</code> with stored procedure calls and explicit <code>_arg =&gt; $1</code> named argument mapping in the DAL.</li>
</ul>
<h2 id="consequences-7"><a class="header" href="#consequences-7">Consequences</a></h2>
<ul>
<li>Keeps the dependency footprint and build complexity unchanged.</li>
<li>Avoids compatibility and security risks from an additional proc-macro tied to <code>sqlx</code> internals.</li>
<li>Engineers must continue to enforce named-argument stored procedure calls manually in <code>revaer-data</code>.</li>
</ul>
<h2 id="follow-up-4"><a class="header" href="#follow-up-4">Follow-up</a></h2>
<ul>
<li>None now. If future requirements force raw SQL ergonomics, revisit with a new ADR that justifies the dependency, version pinning, and testing/CI coverage.***</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="retire-testcontainers"><a class="header" href="#retire-testcontainers">Retire testcontainers</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-06</li>
<li>Context:
<ul>
<li><code>cargo audit</code> flagged <code>rustls-pemfile</code> (RUSTSEC-2025-0134) as unmaintained, pulled via <code>testcontainers</code> → <code>bollard</code>.</li>
<li>AGENT.md forbids local patches and prefers minimal dependencies; maintaining a forked TLS stack would violate both.</li>
<li>Our Docker-backed integration tests (Postgres + libtorrent) depended on <code>testcontainers</code>; removing the crate requires alternate coverage.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Remove <code>testcontainers</code> and associated patches from the workspace; delete Docker-backed integration tests and replace them with lightweight unit coverage.</li>
<li>Keep filesystem orchestration tests in place using in-process fakes instead of containerized services.</li>
<li>Drop the <code>.secignore</code>/<code>deny.toml</code> allowances tied to the <code>testcontainers</code> advisory; rely solely on crates.io sources.</li>
</ul>
</li>
<li>Alternatives considered:
<ul>
<li>Upgrade to a newer <code>testcontainers</code>/<code>bollard</code> release: no maintained option exists today without <code>rustls-pemfile</code>.</li>
<li>Carry an internal fork or patch the dependency: rejected per AGENT.md (no local patches, minimal deps).</li>
<li>Switch to another Docker client (<code>shiplift</code>/<code>dockertest</code>) or Podman socket: deferred until a maintained client with Rustls support emerges and dependency impact is clear.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Supply chain is clean of the unmaintained TLS crate; <code>just audit</code>/<code>just deny</code> can run without ignores for this issue.</li>
<li>Lost container-backed integration coverage; current tests rely on unit-level fakes and filesystem exercises instead of live Postgres/libtorrent flows.</li>
<li>Simpler dependency graph and faster CI runs, with fewer heavy test prerequisites.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Design a replacement integration harness that can target a developer-provided Postgres/libtorrent endpoint (feature-guarded) without adding Docker client dependencies.</li>
<li>Update existing docs/ADRs that reference <code>testcontainers</code> to note deprecation when they next change.</li>
<li>Monitor upstream for a maintained container client or a <code>testcontainers</code> release that drops <code>rustls-pemfile</code>; reconsider adoption once available.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="advisory-rustsec-2024-0370-temporary-ignore"><a class="header" href="#advisory-rustsec-2024-0370-temporary-ignore">Advisory RUSTSEC-2024-0370 Temporary Ignore</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-02-21</li>
<li>Context:
<ul>
<li>The workspace depends on <code>yew</code> for the UI crate, which transitively pulls <code>proc-macro-error</code>, currently flagged by advisory <code>RUSTSEC-2024-0370</code> (unmaintained).</li>
<li>The affected package is used only via the Yew compile-time macro stack; there is no direct runtime exposure, and no maintained alternative in the current Yew release line.</li>
<li><code>cargo-deny</code> and <code>.secignore</code> both require an explicit justification and remediation plan for any ignore.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Keep the advisory ignored in <code>.secignore</code> and <code>deny.toml</code> while remaining on the current Yew release.</li>
<li>Monitor Yew’s releases and remove the ignore as soon as Yew drops the <code>proc-macro-error</code> dependency or provides a supported migration path.</li>
<li>No additional runtime mitigations are required because the dependency is build-time only.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>CI remains green while the upstream dependency is unresolved.</li>
<li>Risk persists until Yew publishes an update; we must track upstream progress to avoid stale ignores.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Track Yew issues/releases monthly and attempt upgrade; remove the ignore once the advisory is no longer transitive.</li>
<li>Re-run <code>just audit</code>/<code>just deny</code> after each Yew upgrade attempt to confirm the ignore can be removed.</li>
<li>If upstream stalls beyond Q2 2025, reassess UI stack alternatives or a forked patch to eliminate <code>proc-macro-error</code>.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-engine-precursor-hardening"><a class="header" href="#torrent-engine-precursor-hardening">Torrent engine precursor hardening</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-10</li>
<li>Context:
<ul>
<li>Torrent work in <code>TORRENT_GAPS.md</code> needs shared scaffolding before adding tracker/NAT/limit features.</li>
<li>Validation and persistence had drifted across API/runtime/DB; per-field SQL updates risked skew and missing guard rails.</li>
<li>The FFI surface for libtorrent was a flat struct that would become unmanageable as new knobs land.</li>
<li>Native tests were slow to write without a harness to spin a session and apply configs.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Introduced <code>engine_profile</code> module to normalise/validate profile patches, emit effective views with guard-rail warnings, and clamp before storage/runtime use.</li>
<li>Replaced per-field SQL with a unified <code>update_engine_profile</code> stored procedure and <code>EngineProfileUpdate</code> data shape to keep DB/API parity.</li>
<li>Added <code>EngineRuntimePlan::from_profile</code> and orchestrator wiring so runtime config applies the normalised/effective profile and surfaces warnings.</li>
<li>Refactored FFI <code>EngineOptions</code> into sub-structs (network/limits/storage/behavior), added layout snapshot/static asserts, and a native session harness for config application tests.</li>
<li>Kept engine encryption/limits mapping centralised; removed ad-hoc guard rails in favour of the shared normaliser.</li>
<li>Alternatives: keep incremental field-specific updates and the flat FFI struct (rejected due to drift/maintainability), or defer effective-view plumbing (rejected—needed for observability and clamp safety).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Single source of truth for engine profile validation and clamping; API/CLI now expose stored vs effective values with warnings.</li>
<li>Runtime plan is applied via orchestrator; tests cover clamping, encryption mapping, and FFI layout to catch regressions.</li>
<li>Migration bumps schema via stored proc; older ad-hoc update paths retired.</li>
<li>Risk: FFI layout asserts must stay in sync with native builds; future field additions must update tests/migration/normaliser together.</li>
<li>Rollback: revert to pre-0004 migration and restore previous EngineOptions layout, but would lose parity and guard rails.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implement tracker/NAT/DHT/connection limit fields end-to-end using the new scaffolding.</li>
<li>Extend native/bridge tests as new fields are added (tracker/proxy, listen interfaces, rate caps).</li>
<li>Keep OpenAPI/CLI samples in sync when exposing additional profile knobs; rerun <code>just api-export</code>.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-precursor-enforcement"><a class="header" href="#torrent-precursor-enforcement">Torrent precursor enforcement</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-12</li>
<li>Context:
<ul>
<li>TORRENT_GAPS precursors called for unified engine profile persistence/validation before expanding tracker/NAT features.</li>
<li>Legacy per-field stored procedures risked drifting from the shared validator and API/runtime expectations.</li>
<li>Runtime → FFI mapping lived inline, making it harder to clamp unsafe values or extend with new options; native tests lacked a reusable harness.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Retired the per-field engine profile update functions/procedures in favour of the single <code>update_engine_profile</code> entry point (migration <code>0005_engine_profile_cleanup</code>), keeping DB/API validation aligned.</li>
<li>Introduced <code>EngineOptionsPlan::from_runtime_config</code> to clamp/disable invalid runtime values before crossing the FFI boundary and surface guard-rail warnings in the native session.</li>
<li>Added a reusable <code>NativeSessionHarness</code> (feature-gated) to spin up temp-backed libtorrent sessions for config application tests.</li>
<li>Alternatives: keep per-field procs (rejected: drift risk), keep inline FFI mapping without guard rails (rejected: unsafe/defaultless), continue hand-rolled test scaffolding (rejected: slows future option additions).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Engine profile persistence now flows through a single stored procedure; accidental partial updates are prevented.</li>
<li>Native application of engine config logs guard-rail warnings and tolerates out-of-range inputs instead of destabilising the session.</li>
<li>Native tests can reuse the harness, reducing boilerplate as tracker/NAT/limit options land.</li>
<li>No new dependencies added.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Extend <code>EngineOptionsPlan</code> and the harness as tracker/proxy/listen-interface options are added.</li>
<li>Keep API/CLI samples in sync with effective profiles; rerun <code>just api-export</code> when surfaces change.</li>
<li>Tests: ensure <code>just ci</code> runs clean after changes; watch for migration <code>0005</code> application in environments with existing functions.</li>
<li>Rollback: revert migration <code>0005</code> and restore per-field functions if a downstream consumer still relies on them, accepting the drift risk.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-settings-parity-and-observability"><a class="header" href="#torrent-settings-parity-and-observability">Torrent settings parity and observability</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-12</li>
<li>Context:
<ul>
<li>TORRENT_GAPS precursor calls for API/runtime parity and observability of the knobs we already support.</li>
<li>Torrent details previously lacked a single place to inspect applied settings (rate caps, selection rules, tags/trackers) and metadata drifted after rate/selection updates.</li>
<li>Engine profile parity (stored vs effective) is already exposed via the config snapshot, but per-torrent settings needed an equivalent surface.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Expose a <code>TorrentSettingsView</code> on torrent detail responses covering download_dir/sequential status from the inspector plus tags/trackers/rate caps and the latest selection rules captured in API state.</li>
<li>Record selection rules and rate limit updates in <code>TorrentMetadata</code> on creation and after rate/selection actions so the API surface reflects current requests.</li>
<li>Added tests to lock the settings/selection projection alongside the existing effective engine profile check; no new dependencies introduced.</li>
<li>Alternatives: keep only rate limits visible (rejected—missing parity for other knobs); fetch selection from the worker each time (rejected—no transport yet and higher coupling).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Clients can now observe per-torrent knobs in a single payload, and metadata stays in sync when limits or selection change.</li>
<li>Provides a scaffold to extend settings as new torrent options land (queue priority, PEX, etc.) without reshaping the API again.</li>
<li>Risk: settings reflect API-side intent; if runtime diverges we must extend inspector reporting or add additional reconciliation hooks.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Thread future torrent options into <code>TorrentMetadata</code>/settings and surface runtime-effective values when the inspector can supply them.</li>
<li>Regenerate OpenAPI when torrent surfaces change and keep UI/CLI renderers updated if they need to show the new fields.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tracker-config-wiring"><a class="header" href="#tracker-config-wiring">Tracker Config Wiring</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-12</li>
<li>Context:
<ul>
<li>Tracker configuration and per-torrent trackers were only partially wired, creating drift between API, DB, and runtime handling.</li>
<li>Client-supplied trackers were not persisted in resume metadata, and tags were ignored by the worker store, risking loss across restarts.</li>
<li>AGENT guardrails require validation parity via stored procedures and no dead code as tracker fields expand.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add typed tracker config with shared normalization plus a stored procedure that clamps lists, proxy fields, and timeouts before persistence.</li>
<li>Map tracker config into runtime/FFI/native session (user agent, announce overrides, proxy, default/extra lists, replace flag) and thread per-torrent trackers/replace through the bridge.</li>
<li>Use the existing <code>url</code> crate for tracker URL validation instead of bespoke parsing to reduce drift and edge-case bugs.</li>
<li>Persist per-torrent trackers and tags in the resume metadata store, reusing stored trackers when re-adding torrents; normalize tracker inputs at the API boundary.</li>
<li>Export the updated OpenAPI schema to reflect tracker options.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Tracker settings are validated once and applied consistently end-to-end; restarts preserve client-supplied trackers/tags.</li>
<li>Resume metadata grows slightly; proxy credentials remain referenced via secrets rather than being stored in plaintext.</li>
<li>Native tracker status/ops are still pending; those will be tackled in later TORRENT_GAPS items.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Extend tracker surfaces with status/ops and authenticated tracker support.</li>
<li>Add native tests around tracker application once the harness covers tracker alerts.</li>
<li>Consider surfacing replace/default tracker semantics in API responses if needed.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="seeding-stop-criteria-and-per-torrent-overrides"><a class="header" href="#seeding-stop-criteria-and-per-torrent-overrides">Seeding stop criteria and per-torrent overrides</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-14</li>
<li>Context:
<ul>
<li>TORRENT_GAPS calls for seed ratio/time stop knobs at both profile and per-torrent scope.</li>
<li>We must keep config/DB/runtime/API in lock-step via stored procedures and shared validators (AGENT).</li>
<li>Libtorrent exposes global <code>share_ratio_limit</code> / <code>seed_time_limit</code>, but per-torrent setters are limited; we still need per-torrent overrides.</li>
<li>No new dependencies allowed; coverage, lint, and <code>just ci</code> gates must stay green.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Added <code>seed_ratio_limit</code> (f64) and <code>seed_time_limit</code> (seconds, i64) to engine profiles with normalization/validation (non-negative, finite) and a migration updating the unified stored procs.</li>
<li>Threaded the limits through runtime plans/options; apply_config now sets libtorrent’s global <code>share_ratio_limit</code>/<code>seed_time_limit</code> (ratio scaled ×1000).</li>
<li>Worker records profile defaults and per-torrent overrides, persists them alongside resume metadata, and enforces them by pausing torrents when ratio or seeding time thresholds are reached (time-window checked on the poll cadence).</li>
<li>API accepts optional per-torrent seed ratio/time on create; validation rejects invalid ratios before admission.</li>
<li>Tests cover config normalization, runtime option mapping/clamping, worker enforcement, and API validation.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Operators can set global seed stop defaults and per-torrent overrides; enforcement happens safely in the worker even without native per-torrent hooks.</li>
<li>Stored profile snapshots and inspector views surface the new limits; persisted metadata carries overrides across restarts.</li>
<li>Risks: enforcement is pause-based and depends on event cadence; libtorrent-native per-torrent stop hooks remain unavailable.</li>
<li>Rollback: drop the migration columns and remove the new fields/wiring; worker enforcement can be disabled by clearing defaults.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Update OpenAPI/docs/examples to surface the new knobs.</li>
<li>Consider native per-torrent hooks if libtorrent exposes them in future releases.</li>
<li>Add telemetry around seeding goal triggers if operational signals are needed.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="025-seed-mode-admission-with-optional-hash-sampling"><a class="header" href="#025-seed-mode-admission-with-optional-hash-sampling">025: Seed mode admission with optional hash sampling</a></h1>
<blockquote>
<p>Allow seed-mode admissions without full rechecks while optionally sampling hashes to guard against corrupt data.</p>
</blockquote>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p>Accepted</p>
<h2 id="context-8"><a class="header" href="#context-8">Context</a></h2>
<p>Users need to add torrents as already complete (seed mode) without forcing a full recheck, but we still need a safety valve to avoid seeding corrupted data. The API already exposes per-torrent knobs; we must thread seed-mode through the worker/FFI/native layers and optionally sample hashes before honouring the flag. Seed-mode should only be allowed when metainfo is present to avoid undefined behaviour on magnet-only adds.</p>
<h2 id="decision-8"><a class="header" href="#decision-8">Decision</a></h2>
<ul>
<li>Add <code>seed_mode</code> and <code>hash_check_sample_pct</code> to <code>AddTorrentOptions</code>/<code>TorrentCreateRequest</code>. Validation requires <code>seed_mode=true</code> when sampling is requested and rejects seed-mode requests without metainfo (API prefers metainfo when seed-mode/sampling is set).</li>
<li>Worker forwards the flags, warns when seed-mode is requested without sampling, persists the intent in fast-resume metadata, and skips sampling when only a magnet was supplied.</li>
<li>The native bridge sets <code>lt::torrent_flags::seed_mode</code> on admission when requested. When a hash sample percentage is provided, it uses libtorrent to hash an even spread of pieces from the requested save path and aborts admission on missing files or hash mismatches. Sampling uses only libtorrent/stdlib (no new dependencies).</li>
<li>Stub/native tests cover seed-mode success, metadata persistence, magnet rejection, and hash-sample failure paths.</li>
</ul>
<h2 id="consequences-8"><a class="header" href="#consequences-8">Consequences</a></h2>
<ul>
<li>Seed-mode is explicit opt-in and limited to metainfo submissions; magnet-only requests fail fast to avoid silent misbehaviour.</li>
<li>Hash sampling is best-effort and can fail admission if files are missing or corrupted; callers can opt out by omitting the sample percentage (a warning is logged).</li>
<li>Fast-resume metadata now tracks seed-mode and sampling preferences for future reconciliation.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="queue-auto-managed-defaults-and-pex-threading"><a class="header" href="#queue-auto-managed-defaults-and-pex-threading">Queue auto-managed defaults and PEX threading</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-03-16</li>
<li>Context:
<ul>
<li>TORRENT_GAPS called out missing support for queue management toggles (auto-managed defaults, prefer-seed/don’t-count-slow policies) and peer exchange enable/disable paths.</li>
<li>Config/runtime needed a single source of truth so workers and the native bridge don’t drift, and per-torrent overrides had to survive restarts via metadata.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Added engine profile fields <code>auto_managed</code>, <code>auto_manage_prefer_seeds</code>, and <code>dont_count_slow_torrents</code> with validation/normalization and a unified stored-proc update, plus a migration to persist them.</li>
<li>Extended runtime/FFI to carry the queue policy flags; native now sets libtorrent’s <code>auto_manage_prefer_seeds</code>/<code>dont_count_slow_torrents</code>, tracks the default auto-managed posture, and applies per-torrent overrides (including queue position) when adding torrents.</li>
<li>Threaded <code>pex_enabled</code> through add options with a native toggle that maps to <code>disable_pex</code>, allowing profile-level defaults and per-torrent overrides.</li>
<li>API accepts/validates the new per-torrent knobs (auto-managed, queue position, PEX) and exposes them through OpenAPI; metadata persistence caches the flags for resume.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>New migration and stored-proc signature; engines built on old schemas must run migrations before updating.</li>
<li>Native add paths now branch on override/default auto-managed flags; queue positions imply manual management to align with libtorrent expectations.</li>
<li>Added coverage for option mapping and request validation; stub/native harnesses record the new metadata for symmetry tests.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Extend torrent detail/inspect surfaces to surface auto-managed/PEX state where useful.</li>
<li>Evaluate whether additional queue policy knobs (e.g., priority clamping) are needed for future gaps.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="choking-strategy-and-super-seeding-configuration"><a class="header" href="#choking-strategy-and-super-seeding-configuration">Choking Strategy And Super-Seeding Configuration</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-14</li>
<li>Context:
<ul>
<li>TORRENT_GAPS requires configurable choke/unchoke strategy and super-seeding defaults.</li>
<li>We must keep config/runtime/FFI/native paths aligned while preserving safe defaults.</li>
<li>API and persistence need to surface new knobs without regressing existing behaviour.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Added engine profile fields for choking (<code>choking_algorithm</code>, <code>seed_choking_algorithm</code>, <code>strict_super_seeding</code>, <code>optimistic_unchoke_slots</code>, <code>max_queued_disk_bytes</code>) and <code>super_seeding</code>.</li>
<li>Normalise/validate values with guard-rail warnings; persist via a single stored-proc update path and migration <code>0006_choking_and_super_seeding.sql</code> (consolidated into <code>0007_rebaseline.sql</code> per ADR 030).</li>
<li>Thread new options through runtime config, FFI structs, and native session (<code>settings_pack</code> + per-torrent flags). Per-torrent <code>super_seeding</code> overrides are stored with metadata.</li>
<li>Updated API models/OpenAPI and added tests covering canonicalisation, clamping, and FFI planning.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Engine config now exposes advanced choke/seeding controls; defaults remain safe (<code>fixed_slots</code>, <code>round_robin</code>, super-seeding off).</li>
<li>Metadata format and DB schema gain new fields; migration is required before runtime use.</li>
<li>Native session applies and can reset choking settings; add-path respects per-torrent super-seeding.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Expand native coverage for strict super-seeding and queue byte limits when integration harness is available.</li>
<li>Monitor telemetry for churn when users toggle new fields; add UX help text where appropriate.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="qbittorrent-parity-and-tracker-tls-wiring"><a class="header" href="#qbittorrent-parity-and-tracker-tls-wiring">qBittorrent Parity and Tracker TLS Wiring</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-17</li>
<li>Context:
<ul>
<li>Libtorrent deprecation warnings and Phase 1 compatibility gaps required us to move away from deprecated tracker TLS fields and finish the qBittorrent façade.</li>
<li>The façade needed tracker, peer, and properties endpoints so qBittorrent clients can query Revaer without custom plugins.</li>
<li>Changes must comply with the AGENT.md gates (no unused code, warnings-as-errors, tests/coverage via <code>just ci</code>).</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Thread tracker TLS settings (trust store, verification flags, client cert/key) through config → runtime → FFI/native without using deprecated libtorrent fields, and cover with native tests.</li>
<li>Expose qBittorrent-compatible endpoints for torrent properties, trackers, peer sync, categories, and tags; return safe defaults where data is not yet modeled.</li>
<li>Keep compatibility code minimal and session-gated; validate torrent hashes on peer sync and re-use existing metadata caches for properties/trackers.</li>
<li>No new dependencies were introduced.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Deprecated libtorrent usage removed; TLS tracker configuration now uses current settings_pack fields.</li>
<li>qBittorrent clients can fetch properties/trackers/peer snapshots and manage empty categories/tags without errors.</li>
<li>Coverage and lint gates remain clean; compatibility paths are exercised by new unit tests.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Expand peer diagnostics and alert surface once native peer info mapping is available (TORRENT_GAPS: “Peer view and diagnostics exposed”).</li>
<li>Consider persisting categories/tags with policy once the domain model supports it.</li>
</ul>
</li>
<li>Tests (coverage summary):
<ul>
<li><code>just ci</code> (fmt, lint, udeps, audit, deny, full test matrix including feature-min, cov) — passes; workspace coverage ≥ 80% with no regressions.</li>
</ul>
</li>
<li>Observability:
<ul>
<li>No new metrics or spans added; compatibility routes reuse existing request tracing.</li>
</ul>
</li>
<li>Risk &amp; Rollback:
<ul>
<li>Compatibility endpoints currently return empty peer/category/tag data; risk is limited to client expectations. Roll back by reverting this ADR and associated API changes.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new crates or feature flags added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-authoring-labels-and-metadata-updates"><a class="header" href="#torrent-authoring-labels-and-metadata-updates">Torrent Authoring, Labels, and Metadata Updates</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-23</li>
<li>Context:
<ul>
<li>Remaining torrent gaps required authoring support plus consistent comment/source/private visibility.</li>
<li>Category/tag defaults and cleanup policies needed a shared storage path and validation.</li>
<li>Changes must comply with AGENT.md (no dead code, tests, docs, OpenAPI sync).</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Expose a create-torrent authoring endpoint that routes through the workflow and libtorrent bindings.</li>
<li>Surface comment/source/private fields in status/settings, allow comment updates only, and validate private tracker requirements on add.</li>
<li>Persist label policies in <code>app_profile.features</code>, provide list/upsert endpoints for categories/tags, and apply policy defaults (including cleanup) on add.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>API clients can author torrents, set label defaults, and observe comment/source/private metadata consistently.</li>
<li>Cleanup rules can remove torrents after ratio/time thresholds, with policy validation guarding invalid inputs.</li>
<li>OpenAPI gains new schemas and endpoints to document authoring and label management.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Extend UI/CLI to manage label policies and expose authoring workflows.</li>
<li>Evaluate adding per-label retention summaries once cleanup automation is in daily use.</li>
</ul>
</li>
<li>Motivation:
<ul>
<li>Close the remaining torrent authoring/label gaps and make metadata updates visible to API clients.</li>
</ul>
</li>
<li>Design notes:
<ul>
<li>Label policies are applied as defaults so explicit request options always win.</li>
<li>Private torrents require trackers; source/private updates are rejected to align with libtorrent constraints.</li>
</ul>
</li>
<li>Tests (coverage summary):
<ul>
<li>Added API tests for metadata visibility and comment updates, plus worker tests for metadata update events and cleanup.</li>
<li>Native authoring test asserts comment/source propagation.</li>
<li><code>just ci</code> run clean (fmt, lint, udeps, audit, deny, test, cov).</li>
</ul>
</li>
<li>Observability:
<ul>
<li>No new metrics; metadata updates reuse existing event streams.</li>
</ul>
</li>
<li>Risk &amp; Rollback:
<ul>
<li>Risk: misconfigured label cleanup could remove torrents earlier than expected. Roll back by removing label policies and reverting cleanup enforcement.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new crates or feature flags were added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="030--migration-consolidation-for-initial-setup"><a class="header" href="#030--migration-consolidation-for-initial-setup">030 – Migration Consolidation for Initial Setup</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-23</li>
<li>Context:
<ul>
<li>The project is unreleased and migration history does not need to remain split.</li>
<li>A single init migration simplifies new environment bootstrap and reduces ordering drift.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Collapse all SQL migrations in <code>crates/revaer-data/migrations</code> into <code>0007_rebaseline.sql</code>.</li>
<li>Remove the remaining numbered migration files after consolidation.</li>
<li>Reset the local dev database in <code>just db-start</code> if the migration history no longer matches.</li>
<li>Clean llvm-cov artifacts before coverage to keep <code>just ci</code> output free of stale-data warnings.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li><strong>Positive</strong>: Fresh databases start from one deterministic migration; fewer files to track.</li>
<li><strong>Trade-offs</strong>: Historical migration boundaries are lost and existing dev databases must be rebuilt.</li>
<li><strong>Trade-offs</strong>: Local dev databases will be dropped automatically when migrations are mismatched.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Add new incremental migrations as needed after release.</li>
<li>Keep the single init file aligned with stored-proc changes.</li>
</ul>
</li>
<li>Motivation:
<ul>
<li>The repository is unreleased, so consolidation avoids maintaining redundant migration files.</li>
</ul>
</li>
<li>Design notes:
<ul>
<li>Preserve migration order by concatenating files with section headers.</li>
<li>Keep the init file self-contained for <code>sqlx</code> execution.</li>
</ul>
</li>
<li>Tests (coverage summary):
<ul>
<li><code>just ci</code> run clean (fmt, lint, udeps, audit, deny, test, cov).</li>
</ul>
</li>
<li>Observability:
<ul>
<li>No new telemetry changes.</li>
</ul>
</li>
<li>Risk &amp; Rollback:
<ul>
<li>Risk: local databases with existing migrations must be dropped and recreated.</li>
<li>Roll back by restoring the previous migration file set from version control.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new crates or features added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-nexus-asset-sync-tooling"><a class="header" href="#ui-nexus-asset-sync-tooling">UI Nexus Asset Sync Tooling</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-23</li>
<li>Context:
<ul>
<li>The UI consumes Nexus HTML/CSS/JS as vendored, compiled assets with no JS toolchain in dev/CI.</li>
<li>We need deterministic sync of vendor CSS, images, and JS into <code>crates/revaer-ui/static/</code> so Trunk can serve them.</li>
<li>Output consistency must be verifiable in CI without relying on external asset pipelines.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add a Rust CLI tool (<code>asset_sync</code>) that copies Nexus assets into <code>static/nexus</code>, validates the CSS, and writes a lock file.</li>
<li>Wire the tool into <code>just</code> so <code>dev</code>, <code>build</code>, and CI checks always run the sync first.</li>
<li>Update the UI entry HTML to copy the full static directory and load Nexus <code>app.css</code> directly.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li><code>anyhow</code>: simplify CLI error propagation in the binary entrypoint; alternative was manual error mapping.</li>
<li><code>fs_extra</code>: reliable directory copy with overwrite semantics; alternative was a bespoke recursive copy.</li>
<li><code>sha2</code>: compute SHA-256 for <code>ASSET_LOCK.txt</code>; no standard library equivalent exists.</li>
<li><code>walkdir</code>: collect deterministic file counts/bytes for lock metadata; alternative was manual recursion.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li>Added unit tests for successful sync + lock creation and CSS validation failures in <code>crates/revaer-ui/tools/asset_sync/src/lib.rs</code>.</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>None. The tool reports failures via exit status and error messages.</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Risk: incorrect vendor paths or corrupted outputs. Mitigation: sanity-check the CSS and lock file.</li>
<li>Rollback: rerun <code>just sync-assets</code> or revert <code>static/nexus</code> changes in version control.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Ensure CI runs <code>just check-assets</code> on changes touching <code>ui_vendor</code> or <code>static/nexus</code>.</li>
<li>Revisit the sync paths if the Nexus vendor layout changes.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="torrent-ffi-audit-closeout"><a class="header" href="#torrent-ffi-audit-closeout">Torrent FFI Audit Closeout</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-23</li>
<li>Context:
<ul>
<li>The torrent FFI audit identified drift between API/runtime/FFI/native behavior (metadata updates, seed limits, proxy handling, IPv6 mode) and missing CI coverage for native tests.</li>
<li>The engine must remain a thin wrapper around libtorrent; unsupported knobs must be rejected early, and native settings must be auditable.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Reject unsupported metadata and per-torrent seed limit updates at the API boundary.</li>
<li>Remove Rust-side seeding enforcement and rely on native session settings only.</li>
<li>Enforce libtorrent version checks at build time and fail when unsupported.</li>
<li>Add native settings inspection hooks and native integration tests for proxy auth, seed limits, and IPv6 listen behavior.</li>
<li>Run native integration tests in CI via a dedicated just recipe.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Drift between API/runtime and native behavior is eliminated for the audited settings.</li>
<li>Native test coverage is required in CI; local runs need libtorrent and Docker availability.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Keep FFI layout assertions updated as bridge structs evolve.</li>
<li>Extend native inspection snapshots when new settings are added.</li>
</ul>
</li>
</ul>
<h2 id="motivation-4"><a class="header" href="#motivation-4">Motivation</a></h2>
<p>Ensure the torrent engine remains a thin libtorrent wrapper by removing Rust-only semantics, rejecting unsupported updates at the API boundary, and enforcing native test coverage to prevent drift.</p>
<h2 id="design-notes-4"><a class="header" href="#design-notes-4">Design Notes</a></h2>
<ul>
<li>Added a lightweight native settings snapshot to validate applied proxy credentials, seed limits, and listen interfaces in tests.</li>
<li>Adjusted native tests to assert deterministic events and avoid reliance on external swarm progress.</li>
<li>Removed deprecated strict-super-seeding fallback in favor of version-gated settings.</li>
<li>Updated FFI layout assertions after adding proxy auth and IPv6 fields.</li>
</ul>
<h2 id="test-coverage-summary-4"><a class="header" href="#test-coverage-summary-4">Test Coverage Summary</a></h2>
<ul>
<li><code>just test-native</code> exercises native unit and integration tests, including new assertions for proxy auth, seed limits, and IPv6 listen mode.</li>
<li><code>just ci</code> (run before handoff) covers workspace lint/test/cov/audit/deny gates.</li>
</ul>
<h2 id="observability-updates-4"><a class="header" href="#observability-updates-4">Observability Updates</a></h2>
<ul>
<li>No new metrics; native settings snapshots are internal to test-only inspection.</li>
</ul>
<h2 id="risk--rollback-plan-2"><a class="header" href="#risk--rollback-plan-2">Risk &amp; Rollback Plan</a></h2>
<ul>
<li>Risk: native settings snapshot could drift if settings are renamed upstream.</li>
<li>Rollback: revert to previous audit state and remove snapshot methods if libtorrent versions diverge; CI will flag mismatches quickly.</li>
</ul>
<h2 id="dependency-rationale-4"><a class="header" href="#dependency-rationale-4">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-sse--authsetup-wiring"><a class="header" href="#ui-sse--authsetup-wiring">UI SSE + Auth/Setup Wiring</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Motivation: finalize first-run setup gating and SSE updates while keeping auth headers on every request.</li>
<li>Constraints: EventSource cannot set headers; SSE must fall back cleanly; avoid new dependencies.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Implement a fetch-stream SSE runner with AbortController, bounded backoff, and fallback endpoint selection.</li>
<li>Parse SSE frames into typed envelopes when possible and throttle list refreshes when updates are incomplete.</li>
<li>Keep auth/setup flow in app state and attach API key or Basic auth for SSE streams.</li>
<li>Alternatives considered: EventSource with query param auth, periodic polling, or WebSockets (rejected for header limitations or higher complexity).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: authenticated SSE support, deterministic reconnection behavior, and bounded refresh churn.</li>
<li>Risks or trade-offs: dual payload parsing adds complexity; throttled refresh can delay UI updates slightly.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: align torrent DTOs with OpenAPI and expand feature modules for torrents/dashboard.</li>
<li>Review checkpoints: validate SSE reconnection on auth changes and fallback path coverage.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li>Added parser unit tests for frame boundaries and multiline data handling.</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>UI-only change; no new server-side telemetry.</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Revert to previous EventSource-based flow or disable SSE refresh on regressions.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new crates added; only web-sys feature flags expanded. Alternative considered: gloo-net streaming APIs (insufficient for manual SSE parsing).</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-sse-normalization-progress-coalescing-and-apiclient-singleton"><a class="header" href="#ui-sse-normalization-progress-coalescing-and-apiclient-singleton">UI SSE normalization, progress coalescing, and ApiClient singleton</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>The UI SSE pipeline needed legacy payload normalization, replay support, and render-friendly progress handling.</li>
<li>App state was still split across <code>use_state</code>, and API clients were being constructed per call.</li>
<li>The dashboard checklist requires a single SSE reducer path and a singleton ApiClient via context.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Normalize SSE payloads into <code>UiEventEnvelope</code> and route all updates through one reducer path in the app shell.</li>
<li>Persist and replay <code>Last-Event-ID</code>, add SSE query filters derived from store state, and coalesce progress updates on a fixed cadence.</li>
<li>Introduce an <code>ApiCtx</code> context that owns a single <code>ApiClient</code> instance with mutable auth state.</li>
<li>Move auth/torrents/system SSE state into the yewdux <code>AppStore</code> and update reducers accordingly.</li>
<li>Store bulk-selection state in <code>AppStore</code> via a shared <code>SelectionSet</code> to keep bulk actions consistent across views.</li>
<li>Patch the <code>anymap</code> dependency used by <code>yewdux</code> to avoid Rust 1.91 auto-trait pointer cast errors.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>SSE progress events are buffered and flushed together, reducing render churn during bursts.</li>
<li>API calls now share a single client instance, simplifying auth updates and call sites.</li>
<li>Bulk selections now persist in store state, avoiding local-only checkbox state drift.</li>
<li>Additional store slices (UI/labels/health) remain future work; some UI state still uses local hooks.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Expand <code>AppStore</code> to include UI/toast/health/labels slices and row-level selectors.</li>
<li>Add coverage for SSE filtering and progress coalescer cadence.</li>
</ul>
</li>
</ul>
<h2 id="motivation-5"><a class="header" href="#motivation-5">Motivation</a></h2>
<ul>
<li>Align the UI with the SSE checklist requirements and remove per-call ApiClient construction.</li>
</ul>
<h2 id="design-notes-5"><a class="header" href="#design-notes-5">Design notes</a></h2>
<ul>
<li>SSE decoding emits <code>UiEventEnvelope</code> instances; <code>handle_sse_envelope</code> is the only reducer entry.</li>
<li>Progress patches are stored in a non-reactive <code>HashMap</code> and flushed every 80ms into <code>AppStore</code> via <code>apply_progress_patch</code>.</li>
<li><code>ApiCtx</code> holds a single <code>ApiClient</code>; auth changes update the shared <code>RefCell</code> state.</li>
<li>Bulk selection updates are routed through <code>SelectionSet</code> so store mutations remain deterministic.</li>
</ul>
<h2 id="test-coverage-summary-5"><a class="header" href="#test-coverage-summary-5">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> (fmt, lint, check-assets, udeps, audit, deny, ui-build, test, test-features-min, cov).</li>
</ul>
<h2 id="observability-updates-5"><a class="header" href="#observability-updates-5">Observability updates</a></h2>
<ul>
<li>No new telemetry; SSE connection state continues to drive the existing UI overlay.</li>
</ul>
<h2 id="risk--rollback-plan-3"><a class="header" href="#risk--rollback-plan-3">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: SSE filter mismatches could drop events; fallback is the throttled refresh path.</li>
<li>Rollback: revert to the previous SSE handler and local state wiring, removing the coalescer and ApiCtx usage.</li>
</ul>
<h2 id="dependency-rationale-5"><a class="header" href="#dependency-rationale-5">Dependency rationale</a></h2>
<ul>
<li>Added a workspace dependency on <code>revaer-events</code> for shared SSE types; patched <code>anymap</code> locally for Rust 1.91 compatibility.</li>
<li>Alternatives considered: keep UI-local event types or upgrade <code>yewdux</code> (requires Yew 0.21+); rejected to avoid duplicating schemas or triggering a larger UI upgrade.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="advisory-rustsec-2021-0065-temporary-ignore"><a class="header" href="#advisory-rustsec-2021-0065-temporary-ignore">Advisory RUSTSEC-2021-0065 Temporary Ignore</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>The UI depends on <code>yewdux</code>, which transitively pulls <code>anymap</code> and triggers advisory <code>RUSTSEC-2021-0065</code> (unmaintained).</li>
<li>There is no maintained replacement for <code>anymap</code> within the pinned <code>yewdux</code> 0.9.x line, and upgrading yewdux would require a Yew major upgrade.</li>
<li><code>cargo-audit</code> is configured to deny warnings, so ignoring the advisory requires explicit documentation and a remediation plan.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add <code>RUSTSEC-2021-0065</code> to <code>.secignore</code> while <code>yewdux</code> requires <code>anymap</code>.</li>
<li>Track <code>yewdux</code> upgrades or alternatives that remove <code>anymap</code> and remove the ignore when available.</li>
<li>No runtime mitigation is required beyond limiting use to the UI state store.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>CI remains green while upstream resolves the dependency.</li>
<li>The unmaintained dependency remains in the tree until we migrate away from it.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Re-evaluate <code>yewdux</code> upgrade paths quarterly; remove the ignore once <code>anymap</code> is no longer required.</li>
<li>If upstream is stalled, evaluate a UI store replacement or a fork that removes <code>anymap</code>.</li>
</ul>
</li>
</ul>
<h2 id="motivation-6"><a class="header" href="#motivation-6">Motivation</a></h2>
<ul>
<li>Keep <code>just audit</code> passing without blocking UI state work while documenting the risk and path to remediation.</li>
</ul>
<h2 id="design-notes-6"><a class="header" href="#design-notes-6">Design notes</a></h2>
<ul>
<li>The ignore is scoped to the single advisory and is documented in <code>.secignore</code> with this ADR for traceability.</li>
</ul>
<h2 id="test-coverage-summary-6"><a class="header" href="#test-coverage-summary-6">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> (includes fmt, clippy, udeps, audit, deny, test, cov).</li>
</ul>
<h2 id="observability-updates-6"><a class="header" href="#observability-updates-6">Observability updates</a></h2>
<ul>
<li>None; advisory handling does not change runtime telemetry.</li>
</ul>
<h2 id="risk--rollback-plan-4"><a class="header" href="#risk--rollback-plan-4">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: unmaintained dependency stays in the build; monitor upstream advisories and plan a migration.</li>
<li>Rollback: remove <code>yewdux</code> usage and replace with a small local store implementation or upgrade to a supported release once available.</li>
</ul>
<h2 id="dependency-rationale-6"><a class="header" href="#dependency-rationale-6">Dependency rationale</a></h2>
<ul>
<li><code>yewdux</code> provides the shared store needed for the UI; alternatives considered were a custom store (higher lift) or upgrading to <code>yewdux</code> 0.11+ (requires Yew 0.21+ migration).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="asset-sync-test-stability-under-parallel-runs"><a class="header" href="#asset-sync-test-stability-under-parallel-runs">Asset sync test stability under parallel runs</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li><code>cargo llvm-cov</code> runs tests in parallel and surfaced a flaky <code>asset_sync</code> test.</li>
<li>The temp directory helper used timestamp-based names that could collide under parallel execution.</li>
<li>CI requires <code>just ci</code> (including coverage) to pass reliably without intermittent failures.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Replace the time-based temp directory naming with a process id + atomic counter.</li>
<li>Retry on <code>AlreadyExists</code> to ensure unique per-test directories without new dependencies.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Asset sync tests are deterministic under parallel runners and coverage instrumentation.</li>
<li>No new crates or runtime behavior changes.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>None.</li>
</ul>
</li>
</ul>
<h2 id="motivation-7"><a class="header" href="#motivation-7">Motivation</a></h2>
<ul>
<li>Remove flaky coverage failures caused by temporary directory collisions in <code>asset_sync</code> tests.</li>
</ul>
<h2 id="design-notes-7"><a class="header" href="#design-notes-7">Design notes</a></h2>
<ul>
<li>Use a static <code>AtomicUsize</code> counter plus <code>std::process::id()</code> to generate unique temp roots.</li>
<li>Loop on <code>AlreadyExists</code> without introducing external dependencies.</li>
</ul>
<h2 id="test-coverage-summary-7"><a class="header" href="#test-coverage-summary-7">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> (fmt, lint, udeps, audit, deny, ui-build, test, cov).</li>
</ul>
<h2 id="observability-updates-7"><a class="header" href="#observability-updates-7">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-plan-5"><a class="header" href="#risk--rollback-plan-5">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: low; change is test-only.</li>
<li>Rollback: revert the temp directory helper to its previous implementation.</li>
</ul>
<h2 id="dependency-rationale-7"><a class="header" href="#dependency-rationale-7">Dependency rationale</a></h2>
<ul>
<li>No new dependencies.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-row-slices-and-system-rate-store-wiring"><a class="header" href="#ui-row-slices-and-system-rate-store-wiring">UI row slices and system-rate store wiring</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>The checklist requires row-level selectors and ID-based list rendering to avoid full-row re-renders.</li>
<li>System rates must live in the AppStore alongside SSE connection state.</li>
<li>UI components should remain free of API side effects while still subscribing to yewdux slices.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add <code>TorrentRowBase</code> and <code>TorrentProgressSlice</code> selectors and render list rows via ID-based components that subscribe only to slices.</li>
<li>Keep bulk selection state in <code>AppStore</code> and expose selectors for selection and system rates.</li>
<li>Store <code>SystemRates</code> in <code>SystemState</code> and update it from both dashboard fetches and SSE system-rate events.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>List rows re-render only when their slice changes, reducing churn under frequent progress updates.</li>
<li>Dashboard throughput metrics now follow store-backed system rates rather than local state copies.</li>
<li>Additional store slices (filters, paging, fsops) still need to be implemented.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Finish remaining torrent state normalization (filters, paging, fsops badges).</li>
<li>Add selectors for drawer detail slices and wire remaining list filtering/paging flows.</li>
</ul>
</li>
</ul>
<h2 id="motivation-8"><a class="header" href="#motivation-8">Motivation</a></h2>
<ul>
<li>Align list rendering with checklist performance constraints and centralize system-rate state in the store.</li>
</ul>
<h2 id="design-notes-8"><a class="header" href="#design-notes-8">Design notes</a></h2>
<ul>
<li><code>TorrentRowItem</code> uses <code>use_selector</code> to read base/progress slices and selection state per row ID.</li>
<li>SSE <code>SystemRates</code> updates now mutate <code>AppStore.system.rates</code> instead of local dashboard state.</li>
<li>Dashboard panels receive <code>SystemRates</code> via props to keep UI components data-driven.</li>
</ul>
<h2 id="test-coverage-summary-8"><a class="header" href="#test-coverage-summary-8">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> (fmt, lint, check-assets, udeps, audit, deny, ui-build, test, test-features-min, cov).</li>
</ul>
<h2 id="observability-updates-8"><a class="header" href="#observability-updates-8">Observability updates</a></h2>
<ul>
<li>No changes.</li>
</ul>
<h2 id="risk--rollback-plan-6"><a class="header" href="#risk--rollback-plan-6">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: list rows could render blank if selector data goes missing; fallback is the existing refresh flow.</li>
<li>Rollback: revert to list rendering with full rows and remove the per-row selectors.</li>
</ul>
<h2 id="dependency-rationale-8"><a class="header" href="#dependency-rationale-8">Dependency rationale</a></h2>
<ul>
<li>No new dependencies.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-shared-api-models-and-torrent-query-paging-state"><a class="header" href="#ui-shared-api-models-and-torrent-query-paging-state">UI shared API models and torrent query paging state</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>The UI duplicated API DTOs, causing drift from backend shapes and blocking checklist compliance.</li>
<li>Torrent list fetching needed a real query/paging model to align with the API list response.</li>
<li>SSE fsops events required a stable store cache separate from row state.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Extract shared API DTOs into a new <code>revaer-api-models</code> crate and re-export from <code>revaer-api</code>.</li>
<li>Update the UI to consume shared DTOs, map list/detail views from API shapes, and parse list responses with <code>next</code> cursors.</li>
<li>Add <code>TorrentsQueryModel</code>, <code>TorrentsPaging</code>, and <code>fsops_by_id</code> to the torrent store and update SSE to fill fsops state.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>API DTOs are now single-source across API/CLI/UI consumers.</li>
<li>UI list fetching can track cursor paging and filter parameters in state.</li>
<li>Detail views now map from API DTOs with placeholder metadata until richer fields are available.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Wire filter fields into URL/query state and implement load-more pagination.</li>
<li>Replace add-torrent payloads with <code>TorrentCreateRequest</code> + client UUIDs.</li>
<li>Populate health and label caches from API endpoints.</li>
</ul>
</li>
</ul>
<h2 id="motivation-9"><a class="header" href="#motivation-9">Motivation</a></h2>
<ul>
<li>Eliminate duplicated API DTOs in the UI and align list fetching with backend paging semantics.</li>
</ul>
<h2 id="design-notes-9"><a class="header" href="#design-notes-9">Design notes</a></h2>
<ul>
<li>Introduced <code>revaer-api-models</code> as the canonical DTO crate and re-exported it from <code>revaer-api</code>.</li>
<li><code>TorrentSummary</code> and <code>TorrentDetail</code> conversions now map from shared DTOs into UI row/detail views.</li>
<li><code>TorrentsQueryModel</code> and <code>TorrentsPaging</code> feed <code>build_torrents_path</code> for list requests.</li>
<li>SSE fsops events update <code>fsops_by_id</code> without mutating row state.</li>
</ul>
<h2 id="test-coverage-summary-9"><a class="header" href="#test-coverage-summary-9">Test coverage summary</a></h2>
<ul>
<li>just ci (fmt, lint, check-assets, udeps, audit, deny, ui-build, test, test-features-min, cov)</li>
<li>llvm-cov reports: “warning: 40 functions have mismatched data”</li>
</ul>
<h2 id="observability-updates-9"><a class="header" href="#observability-updates-9">Observability updates</a></h2>
<ul>
<li>No changes.</li>
</ul>
<h2 id="risk--rollback-plan-7"><a class="header" href="#risk--rollback-plan-7">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: mapping differences between API DTOs and UI view models could hide fields.</li>
<li>Rollback: revert to the previous UI DTO definitions and list fetch logic.</li>
</ul>
<h2 id="dependency-rationale-9"><a class="header" href="#dependency-rationale-9">Dependency rationale</a></h2>
<ul>
<li>Added <code>revaer-api-models</code> to share API DTOs across crates.</li>
<li>Added <code>chrono</code> as a UI dev-dependency for DTO construction in tests.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-store-api-coverage-and-rate-limit-retries"><a class="header" href="#ui-store-api-coverage-and-rate-limit-retries">UI store, API coverage, and rate-limit retries</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Shared UI state (theme, toasts, label/health caches) needed to live in the AppStore to match the yewdux architecture rule.</li>
<li>The API client needed coverage for health, metrics, and label list endpoints to unblock upcoming screens.</li>
<li>Rate-limit responses required user-visible backoff messaging and a safe retry path for idempotent fetches.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Move shell theme/toast/busy state into the AppStore and populate label/health caches from API calls.</li>
<li>Extend the UI API client with health/full, metrics, and label list endpoints, leaving option/selection/authoring calls for later UI wiring.</li>
<li>Handle 429 responses for torrent list/detail fetches with Retry-After backoff and a single retry.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>UI state is centralized and ready for labels/health screens without ad-hoc local state.</li>
<li>API coverage is aligned with the checklist endpoints, reducing future wiring churn.</li>
<li>Rate-limit retries add controlled delay behavior; repeated throttling still surfaces errors.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Remove demo-only list/detail fallback paths and add empty states.</li>
<li>Implement category/tag management screens and health viewer UI.</li>
<li>Wire per-torrent options/selection editing in the drawer and add torrent authoring UX.</li>
</ul>
</li>
</ul>
<h2 id="motivation-10"><a class="header" href="#motivation-10">Motivation</a></h2>
<ul>
<li>Keep shared UI state in yewdux and close API coverage gaps needed for Torrent UX.</li>
</ul>
<h2 id="design-notes-10"><a class="header" href="#design-notes-10">Design notes</a></h2>
<ul>
<li>AppShell theme and toast lifecycles now flow through AppStore updates.</li>
<li>Labels/health caches are populated from API calls and stored in dedicated slices.</li>
<li>Added API client methods for remaining torrent and label endpoints.</li>
<li>API client currently covers health/full, metrics, and label list endpoints; mutating endpoints await UI wiring.</li>
<li>Rate-limit backoff uses Retry-After with a single retry for idempotent list/detail fetches.</li>
</ul>
<h2 id="test-coverage-summary-10"><a class="header" href="#test-coverage-summary-10">Test coverage summary</a></h2>
<ul>
<li>just ci (fmt, lint, check-assets, udeps, audit, deny, ui-build, test, test-features-min, cov)</li>
<li>llvm-cov reports: “warning: 40 functions have mismatched data”</li>
</ul>
<h2 id="observability-updates-10"><a class="header" href="#observability-updates-10">Observability updates</a></h2>
<ul>
<li>No changes.</li>
</ul>
<h2 id="risk--rollback-plan-8"><a class="header" href="#risk--rollback-plan-8">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: extra retry traffic on sustained 429 responses.</li>
<li>Rollback: remove retry/backoff helpers and revert list/detail fetch handling.</li>
</ul>
<h2 id="dependency-rationale-10"><a class="header" href="#dependency-rationale-10">Dependency rationale</a></h2>
<ul>
<li>No new dependencies.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="040--ui-label-policies-task-record"><a class="header" href="#040--ui-label-policies-task-record">040 – UI Label Policies (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-10-24</li>
</ul>
<h2 id="motivation-11"><a class="header" href="#motivation-11">Motivation</a></h2>
<ul>
<li>Provide first-class category/tag policy management in the UI so operators can apply TorrentLabelPolicy defaults without CLI/API-only workflows.</li>
<li>Maintain AppStore as the source of truth while avoiding API calls in atoms/molecules.</li>
</ul>
<h2 id="design-notes-11"><a class="header" href="#design-notes-11">Design Notes</a></h2>
<ul>
<li>Implemented a dedicated <code>features/labels</code> slice with form state that round-trips through <code>TorrentLabelPolicy</code>.</li>
<li>Added a single list + editor page that renders per-kind (categories or tags) with an Advanced section for rarely used fields.</li>
<li>API upserts are routed through the shared <code>ApiClient</code> and update the AppStore label caches on success.</li>
</ul>
<h2 id="decision-9"><a class="header" href="#decision-9">Decision</a></h2>
<ul>
<li>Use <code>LabelFormState</code> as the sole UI editing model and convert to <code>TorrentLabelPolicy</code> only on save.</li>
<li>Re-export label policy support types from <code>revaer-api-models</code> to keep UI aligned with shared domain types.</li>
</ul>
<h2 id="consequences-9"><a class="header" href="#consequences-9">Consequences</a></h2>
<ul>
<li>Labels are now editable without leaving the UI; any validation errors are surfaced before calling the API.</li>
<li>The UI must keep label cache entries updated to prevent stale list rendering.</li>
</ul>
<h2 id="test-coverage-summary-11"><a class="header" href="#test-coverage-summary-11">Test Coverage Summary</a></h2>
<ul>
<li>Added unit tests for label form parsing, cleanup validation, and policy mapping.</li>
</ul>
<h2 id="observability-updates-11"><a class="header" href="#observability-updates-11">Observability Updates</a></h2>
<ul>
<li>None (UI-only changes, no new telemetry).</li>
</ul>
<h2 id="risk--rollback-2"><a class="header" href="#risk--rollback-2">Risk &amp; Rollback</a></h2>
<ul>
<li>Risk: malformed inputs can still hit the API if not caught locally; server-side validation remains authoritative.</li>
<li>Rollback: revert the labels feature wiring in <code>app/mod.rs</code> and the new feature module.</li>
</ul>
<h2 id="dependency-rationale-11"><a class="header" href="#dependency-rationale-11">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced; re-exported existing domain types for UI usage.</li>
</ul>
<h2 id="follow-up-5"><a class="header" href="#follow-up-5">Follow-up</a></h2>
<ul>
<li>Expand label editor UX (search/filter, bulk actions) and align styling with Nexus components.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="041--ui-health-view--label-shortcuts-task-record"><a class="header" href="#041--ui-health-view--label-shortcuts-task-record">041 – UI Health View + Label Shortcuts (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-10-24</li>
</ul>
<h2 id="motivation-12"><a class="header" href="#motivation-12">Motivation</a></h2>
<ul>
<li>Replace the Health route placeholder with an operator-facing status view built from cached snapshots.</li>
<li>Provide quick navigation from torrent add flow to label policy management.</li>
</ul>
<h2 id="design-notes-12"><a class="header" href="#design-notes-12">Design Notes</a></h2>
<ul>
<li>Implemented a dedicated health feature view that reads from <code>AppStore</code> and renders basic/full snapshots plus the raw metrics text.</li>
<li>Added label shortcuts in the add-torrent panel using router links to avoid side effects in components.</li>
</ul>
<h2 id="decision-10"><a class="header" href="#decision-10">Decision</a></h2>
<ul>
<li>Keep health rendering in a feature view module with no API calls; data remains sourced from app-level effects.</li>
<li>Use existing chip/button styling patterns for navigation shortcuts.</li>
</ul>
<h2 id="consequences-10"><a class="header" href="#consequences-10">Consequences</a></h2>
<ul>
<li>Operators can inspect health status without leaving the UI.</li>
<li>Add-torrent flow now exposes direct navigation to categories and tags.</li>
</ul>
<h2 id="test-coverage-summary-12"><a class="header" href="#test-coverage-summary-12">Test Coverage Summary</a></h2>
<ul>
<li>UI-only additions (no new Rust tests added).</li>
</ul>
<h2 id="observability-updates-12"><a class="header" href="#observability-updates-12">Observability Updates</a></h2>
<ul>
<li>None (UI-only changes, no new telemetry).</li>
</ul>
<h2 id="risk--rollback-3"><a class="header" href="#risk--rollback-3">Risk &amp; Rollback</a></h2>
<ul>
<li>Risk: health fields may appear empty when snapshots are unavailable; view handles None gracefully.</li>
<li>Rollback: revert the health feature module and restore the placeholder route.</li>
</ul>
<h2 id="dependency-rationale-12"><a class="header" href="#dependency-rationale-12">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced.</li>
</ul>
<h2 id="follow-up-6"><a class="header" href="#follow-up-6">Follow-up</a></h2>
<ul>
<li>Add metrics copy controls and align health styling with Nexus patterns.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="042---ui-metrics-copy-button-task-record"><a class="header" href="#042---ui-metrics-copy-button-task-record">042 - UI Metrics Copy Button (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-12-24</li>
</ul>
<h2 id="motivation-13"><a class="header" href="#motivation-13">Motivation</a></h2>
<ul>
<li>Provide a fast way to copy <code>/metrics</code> output from the Health page.</li>
<li>Close the optional metrics viewer requirement in the dashboard checklist.</li>
</ul>
<h2 id="design-notes-13"><a class="header" href="#design-notes-13">Design Notes</a></h2>
<ul>
<li>Keep clipboard access in <code>app</code> to respect the “window-only in app” rule.</li>
<li>Use a HealthPage callback to avoid side effects in the feature view.</li>
<li>Emit success/error toasts to confirm copy status.</li>
</ul>
<h2 id="decision-11"><a class="header" href="#decision-11">Decision</a></h2>
<ul>
<li>Use the Clipboard API (<code>navigator.clipboard.writeText</code>) for copying.</li>
<li>Guard the copy button when metrics payload is empty.</li>
</ul>
<h2 id="consequences-11"><a class="header" href="#consequences-11">Consequences</a></h2>
<ul>
<li>Operators can copy metrics text without leaving the UI.</li>
<li>Clipboard permissions may block copy; errors are surfaced via toasts.</li>
</ul>
<h2 id="test-coverage-summary-13"><a class="header" href="#test-coverage-summary-13">Test Coverage Summary</a></h2>
<ul>
<li>UI-only change; no new Rust tests added.</li>
</ul>
<h2 id="observability-updates-13"><a class="header" href="#observability-updates-13">Observability Updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-4"><a class="header" href="#risk--rollback-4">Risk &amp; Rollback</a></h2>
<ul>
<li>Risk: clipboard API unavailable in some browsers.</li>
<li>Rollback: remove the copy button and clipboard helper.</li>
</ul>
<h2 id="dependency-rationale-13"><a class="header" href="#dependency-rationale-13">Dependency Rationale</a></h2>
<ul>
<li>Enable the existing <code>web-sys</code> Clipboard feature to access <code>navigator.clipboard</code>.</li>
<li>Alternative considered: legacy <code>execCommand("copy")</code>, avoided due to deprecation.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="043---ui-settings-bypass-local-auth-toggle-task-record"><a class="header" href="#043---ui-settings-bypass-local-auth-toggle-task-record">043 - UI Settings Bypass Local Auth Toggle (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-12-24</li>
</ul>
<h2 id="motivation-14"><a class="header" href="#motivation-14">Motivation</a></h2>
<ul>
<li>Provide a settings control for preferring API keys in the auth prompt.</li>
<li>Close the remaining setup/auth flow requirement in the dashboard checklist.</li>
</ul>
<h2 id="design-notes-14"><a class="header" href="#design-notes-14">Design Notes</a></h2>
<ul>
<li>Store the bypass toggle in LocalStorage but read/write it only from <code>app</code>.</li>
<li>Keep the settings view stateless and driven by AppStore props.</li>
<li>Use the toggle to influence the default auth prompt tab without forcing logout.</li>
</ul>
<h2 id="decision-12"><a class="header" href="#decision-12">Decision</a></h2>
<ul>
<li>Add a settings feature view for the bypass local toggle.</li>
<li>Persist the toggle separately from the last-used auth mode.</li>
</ul>
<h2 id="consequences-12"><a class="header" href="#consequences-12">Consequences</a></h2>
<ul>
<li>Auth prompt defaults to API key when bypass is enabled.</li>
<li>Existing auth state remains unchanged unless the user re-authenticates.</li>
</ul>
<h2 id="test-coverage-summary-14"><a class="header" href="#test-coverage-summary-14">Test Coverage Summary</a></h2>
<ul>
<li>UI-only change; no new Rust tests added.</li>
</ul>
<h2 id="observability-updates-14"><a class="header" href="#observability-updates-14">Observability Updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-5"><a class="header" href="#risk--rollback-5">Risk &amp; Rollback</a></h2>
<ul>
<li>Risk: users may still remain logged in with local auth while bypass is enabled.</li>
<li>Rollback: remove the settings view and toggle wiring.</li>
</ul>
<h2 id="dependency-rationale-14"><a class="header" href="#dependency-rationale-14">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="044---ui-apiclient-torrent-optionsselection-endpoints-task-record"><a class="header" href="#044---ui-apiclient-torrent-optionsselection-endpoints-task-record">044 - UI ApiClient Torrent Options/Selection Endpoints (Task Record)</a></h1>
<ul>
<li>Status: In Progress</li>
<li>Date: 2025-12-24</li>
</ul>
<h2 id="motivation-15"><a class="header" href="#motivation-15">Motivation</a></h2>
<ul>
<li>Add the remaining torrent options/selection endpoints to the ApiClient.</li>
<li>Keep transport wiring centralized in the API service layer.</li>
</ul>
<h2 id="design-notes-15"><a class="header" href="#design-notes-15">Design Notes</a></h2>
<ul>
<li>Use existing API model types (<code>TorrentOptionsRequest</code>, <code>TorrentSelectionRequest</code>).</li>
<li>Keep methods in <code>services::api::ApiClient</code> and reuse existing auth/application patterns.</li>
</ul>
<h2 id="decision-13"><a class="header" href="#decision-13">Decision</a></h2>
<ul>
<li>Add ApiClient helpers for options updates and file selection updates.</li>
<li>Maintain consistent error wrapping and headers via the shared helpers.</li>
</ul>
<h2 id="consequences-13"><a class="header" href="#consequences-13">Consequences</a></h2>
<ul>
<li>UI features can call these endpoints without duplicating transport logic.</li>
<li>File selection toggles now persist via the selection endpoint.</li>
</ul>
<h2 id="test-coverage-summary-15"><a class="header" href="#test-coverage-summary-15">Test Coverage Summary</a></h2>
<ul>
<li>API client additions only; no new Rust tests added.</li>
</ul>
<h2 id="observability-updates-15"><a class="header" href="#observability-updates-15">Observability Updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-6"><a class="header" href="#risk--rollback-6">Risk &amp; Rollback</a></h2>
<ul>
<li>Risk: API failures require reloading detail data to reconcile file selection state.</li>
<li>Rollback: remove the selection update path and ApiClient methods.</li>
</ul>
<h2 id="dependency-rationale-15"><a class="header" href="#dependency-rationale-15">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-icon-system-and-icon-buttons"><a class="header" href="#ui-icon-system-and-icon-buttons">UI Icon System and Icon Buttons</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Motivation: eliminate inline SVGs and standardize icon usage per the dashboard checklist.</li>
<li>Constraints: reuse Nexus/DaisyUI styling, avoid new dependencies, keep accessibility consistent.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Summary: add a shared icon module under <code>components/atoms/icons</code> and a reusable <code>IconButton</code> component for icon-only actions.</li>
<li>Design notes: provide <code>IconProps</code> (size, class, optional title) and <code>IconVariant</code> for outline/solid arrows; reuse existing <code>.icon-btn</code> styles for consistent hover/focus behavior.</li>
<li>Alternatives considered: keep inline SVGs or introduce an external icon crate; rejected to avoid duplication and dependencies.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: centralized icon rendering, consistent sizing, and cleaner shell/dashboard markup.</li>
<li>Risks/trade-offs: visual regressions if CSS assumptions about SVG sizing shift.</li>
<li>Observability updates: none.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: keep new icons in the shared module; replace any future inline SVGs with components.</li>
<li>Test coverage summary: UI component wiring only; no new tests added (llvm-cov still warns about mismatched data).</li>
<li>Dependency rationale: no new dependencies introduced.</li>
<li>Risk &amp; rollback plan: revert icon module changes and restore inline SVGs if styling regresses.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-torrent-filters-pagination-and-url-sync"><a class="header" href="#ui-torrent-filters-pagination-and-url-sync">UI Torrent Filters, Pagination, and URL Sync</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Motivation: expose torrent filters in the URL and support paged list loading without breaking the normalized store.</li>
<li>Constraints: reuse existing API query semantics, avoid new dependencies, and keep URL updates inside app-level routing.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Summary: parse/filter query params from the router location, update the URL when filters change, and add an explicit Load more flow that appends rows.</li>
<li>Design notes: use <code>build_torrent_filter_query</code> for URL-only filters, keep refresh fetches cursor-free, and append rows only when a cursor is provided for pagination.</li>
<li>Alternatives considered: store cursor in the URL or auto-load more on scroll; rejected to keep query stable and avoid hidden fetches.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: shareable filter URLs, explicit paging, and predictable list refresh behavior.</li>
<li>Risks/trade-offs: query sync relies on history replace semantics; overlapping API pages could still cause duplicate rows.</li>
<li>Observability updates: none.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: wire filter inputs, add Load more, and append list reducer support.</li>
<li>Test coverage summary: added unit tests for query round-tripping and append-row behavior.</li>
<li>Dependency rationale: no new dependencies introduced.</li>
<li>Risk &amp; rollback plan: revert filter URL sync and pagination append logic if list state becomes inconsistent.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-torrent-list-updated-timestamp-column"><a class="header" href="#ui-torrent-list-updated-timestamp-column">UI Torrent List Updated Timestamp Column</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Motivation: surface the last updated timestamp alongside the existing list columns.</li>
<li>Constraints: avoid new dependencies and keep row slices stable for list rendering performance.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Summary: store a formatted updated timestamp string in the torrent row base slice and render it as an optional column.</li>
<li>Alternatives considered: compute formatting in the component layer or add a relative time utility; rejected to keep row rendering pure and avoid new helpers.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: list rows now include an explicit updated timestamp column with overflow fallback.</li>
<li>Risks/trade-offs: updated timestamps refresh only when list data is refreshed, not on every SSE event.</li>
<li>Observability updates: none.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: keep formatting consistent in the summary conversion.</li>
<li>Test coverage summary: added assertions for updated timestamps in row conversion tests.</li>
<li>Dependency rationale: no new dependencies introduced.</li>
<li>Risk &amp; rollback plan: remove updated column mapping if list layout regresses.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="adr-048-ui-torrent-row-actions-bulk-controls-and-rateremove-dialogs"><a class="header" href="#adr-048-ui-torrent-row-actions-bulk-controls-and-rateremove-dialogs">ADR 048: UI torrent row actions, bulk controls, and rate/remove dialogs</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>Motivation: complete torrent list row actions and bulk controls with confirm/rate UX and concurrency safety.</li>
<li>Constraints: no new dependencies, no unwrap/expect in non-test code, yewdux-managed shared state, and clean <code>just ci</code>.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add UI action variants (reannounce, sequential on/off, rate) and map them to API actions.</li>
<li>Introduce row action menus plus remove/rate dialogs with input validation and delete-data toggle.</li>
<li>Implement a bulk-action runner with a concurrency cap, failure aggregation, and drawer-close logic when multi-select remains.</li>
<li>Alternatives considered: per-item toasts with sequential execution (rejected for spam and slow UX).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive: consistent row/bulk actions, safer removals, bounded bulk concurrency, and clear summary feedback.</li>
<li>Trade-offs: additional UI state for dialogs and bulk runner bookkeeping.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Ensure translations are backfilled for new strings beyond English as needed.</li>
<li>Revisit concurrency cap if the API or UI performance requirements change.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li>Added unit tests for rate input parsing in <code>crates/revaer-ui/src/core/logic/mod.rs</code>.</li>
<li>Existing action success message tests extended to cover new variants.</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>None (UI-only changes; no new metrics/tracing added).</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Risk: dialog/menu UX regressions on small screens or edge-case bulk failures.</li>
<li>Rollback: revert this ADR’s changeset and restore prior row-action buttons and sequential bulk loop.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new dependencies added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-detail-drawer-overviewfilesoptions"><a class="header" href="#ui-detail-drawer-overviewfilesoptions">UI detail drawer overview/files/options</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
</ul>
<h2 id="context-9"><a class="header" href="#context-9">Context</a></h2>
<ul>
<li>The torrent detail drawer still exposed legacy peers/trackers/log panes instead of the required overview/files/options layout.</li>
<li>The UI was maintaining a custom DetailData conversion layer instead of using shared API models.</li>
<li>The checklist requires edits only for fields supported by PATCH /v1/torrents/{id}/options and real file selection updates.</li>
</ul>
<h2 id="decision-14"><a class="header" href="#decision-14">Decision</a></h2>
<ul>
<li>Render the detail drawer with Overview, Files, and Options tabs and include the same action set as the list rows.</li>
<li>Store TorrentDetail directly in the detail cache to avoid duplicate UI-only models and conversions.</li>
<li>Apply file selection changes via /select (include/exclude/priority/skip_fluff) and options changes via /options with optimistic updates.</li>
<li>Keep non-editable settings read-only to avoid fake controls.</li>
</ul>
<h2 id="consequences-14"><a class="header" href="#consequences-14">Consequences</a></h2>
<ul>
<li>Removes duplicated detail mapping logic and keeps UI aligned with shared models.</li>
<li>Detail UI now depends on settings payloads for options and skip-fluff rendering.</li>
<li>Failed updates require a refresh to reconcile optimistic state.</li>
</ul>
<h2 id="motivation-16"><a class="header" href="#motivation-16">Motivation</a></h2>
<ul>
<li>Align the UI with the Torrent UX checklist while preserving the thin-client model.</li>
</ul>
<h2 id="design-notes-16"><a class="header" href="#design-notes-16">Design notes</a></h2>
<ul>
<li>Detail cache remains in yewdux details_by_id; list rows stay lightweight.</li>
<li>Components emit callbacks only; API calls remain in app-level handlers.</li>
</ul>
<h2 id="test-coverage-summary-16"><a class="header" href="#test-coverage-summary-16">Test coverage summary</a></h2>
<ul>
<li>Added unit tests for detail selection, priority, skip-fluff, and options updates in torrents state.</li>
<li>Added a format_bytes unit test for the new size formatter.</li>
</ul>
<h2 id="observability-updates-16"><a class="header" href="#observability-updates-16">Observability updates</a></h2>
<ul>
<li>None (UI-only changes).</li>
</ul>
<h2 id="risk--rollback-plan-9"><a class="header" href="#risk--rollback-plan-9">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: optimistic updates may temporarily show stale settings if the API rejects changes.</li>
<li>Mitigation: refresh detail on failure.</li>
<li>Rollback: restore the previous detail component and DetailData mapping.</li>
</ul>
<h2 id="dependency-rationale-16"><a class="header" href="#dependency-rationale-16">Dependency rationale</a></h2>
<ul>
<li>Added workspace chrono to revaer-ui runtime deps to build demo detail timestamps.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-torrent-fab--create-modals"><a class="header" href="#ui-torrent-fab--create-modals">UI torrent FAB + create modals</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-24</li>
<li>Context:
<ul>
<li>The torrent UX checklist requires FAB-driven add/create modals and initial rate limits.</li>
<li>API calls must stay in the app layer with shared DTOs, and UI state lives in yewdux.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Implement a floating action button that opens Add and Create torrent modals.</li>
<li>Wire POST <code>/v1/torrents/create</code> through the ApiClient and surface results + copy actions.</li>
<li>Move UI preferences (mode/density/locale) into the shared store for consistent access.</li>
<li>Alternatives considered:
<ul>
<li>Keep the add panel inline in the list view (rejected; no FAB flow).</li>
<li>Let modal components call the API directly (rejected; breaks layering rules).</li>
</ul>
</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Adds modal UX for torrent add/authoring and a FAB entry point.</li>
<li>Introduces minimal new store state for create results/errors and busy flags.</li>
<li>Additional translations and CSS required for modal + FAB presentation.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Validate Add/Create modals visually against Nexus styling.</li>
<li>Run full <code>just ci</code> and confirm zero warnings.</li>
</ul>
</li>
</ul>
<h2 id="motivation-17"><a class="header" href="#motivation-17">Motivation</a></h2>
<ul>
<li>Finish the remaining torrent UX checklist items for FAB actions and authoring flows.</li>
<li>Keep state management consistent with the yewdux store rule.</li>
</ul>
<h2 id="design-notes-17"><a class="header" href="#design-notes-17">Design notes</a></h2>
<ul>
<li>Modal components remain pure UI: they emit typed requests and copy intents via callbacks.</li>
<li>Create results are stored in the torrents slice to avoid cross-component ad hoc state.</li>
</ul>
<h2 id="test-coverage-summary-17"><a class="header" href="#test-coverage-summary-17">Test coverage summary</a></h2>
<ul>
<li>Unit tests updated for add payload validation (rate parsing).</li>
<li>No new integration tests for UI-only changes.</li>
</ul>
<h2 id="observability-updates-17"><a class="header" href="#observability-updates-17">Observability updates</a></h2>
<ul>
<li>None (UI-only change).</li>
</ul>
<h2 id="risk--rollback-plan-10"><a class="header" href="#risk--rollback-plan-10">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: modal flows may need styling adjustments across breakpoints.</li>
<li>Rollback: revert UI modal/FAB changes and the create endpoint wiring.</li>
</ul>
<h2 id="dependency-rationale-17"><a class="header" href="#dependency-rationale-17">Dependency rationale</a></h2>
<ul>
<li>No new dependencies introduced; reused existing shared DTOs and UI helpers.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-shared-api-models-and-ux-primitives"><a class="header" href="#ui-shared-api-models-and-ux-primitives">UI shared API models and UX primitives</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-25</li>
<li>Context:
<ul>
<li>The UI and CLI duplicated health/setup/dashboard DTOs, increasing drift risk against the API.</li>
<li>The torrent toolbar and labels views lacked debounced search, multi-select, and reusable empty/bulk primitives.</li>
<li>The UI checklist requires shared API models and a component primitive set with prop-driven configuration.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Move health, setup-start, and dashboard DTOs into <code>revaer-api-models</code> and consume them from the API, UI, and CLI.</li>
<li>Add shared UI primitives (SearchInput with debounce, MultiSelect, EmptyState, BulkActionBar) and extend existing inputs/buttons for prop coverage.</li>
<li>Refactor torrent filters and label empty state to use the new primitives while retaining text-input fallback for tags when options are unavailable.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Reduces schema drift and keeps response shapes centralized in one crate.</li>
<li>Adds new UI primitives that standardize filter toolbars and empty states.</li>
<li>The setup-start endpoint now serializes expiration as RFC3339 strings to match shared DTOs.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Audit remaining UI components for prop completeness and update the checklist item when finished.</li>
<li>Re-run the full <code>just ci</code> pipeline before final handoff.</li>
</ul>
</li>
</ul>
<h2 id="task-record"><a class="header" href="#task-record">Task record</a></h2>
<ul>
<li>Motivation: Eliminate duplicate API DTOs and complete missing UI primitives required by the Torrent UX checklist.</li>
<li>Design notes: Shared DTOs live in <code>revaer-api-models</code>; new primitives live under <code>components</code> and are consumed by torrents/labels views to avoid dead code.</li>
<li>Test coverage summary: Not run in this update (follow-up required per AGENT.md).</li>
<li>Observability updates: None.</li>
<li>Risk &amp; rollback plan: Revert to previous DTO structs in API/CLI/UI and restore raw input elements if regressions surface.</li>
<li>Dependency rationale: No new dependencies added.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-dashboard-migration-to-nexus-vendor-layout"><a class="header" href="#ui-dashboard-migration-to-nexus-vendor-layout">UI dashboard migration to Nexus vendor layout</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-25</li>
<li>Context:
<ul>
<li>Align the dashboard and shell UI with the vendored Nexus HTML to remove drift.</li>
<li>Remove the blocking SSE overlay and replace it with a non-blocking connectivity surface.</li>
<li>Preserve routing and layout classes so Nexus CSS can remain authoritative.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Replace the old dashboard and shell markup with Nexus vendor partials and dashboard structure.</li>
<li>Introduce SSE connectivity state in the store with a drawer-footer indicator and modal.</li>
<li>Remove legacy dashboard CSS overrides and ensure vendor app.css is the primary styling source.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive: Nexus parity, simpler shell structure, non-blocking connectivity UX.</li>
<li>Risks: UI copy/labels diverge from vendor defaults; mode toggle now relies on existing stored preference.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Verify visual parity against Nexus dashboard sections.</li>
<li>Monitor SSE reconnection details surfaced in the modal.</li>
</ul>
</li>
</ul>
<h2 id="motivation-18"><a class="header" href="#motivation-18">Motivation</a></h2>
<ul>
<li>Ensure the UI matches the vendored Nexus dashboard and shell while eliminating legacy layout glue.</li>
<li>Replace blocking SSE overlays with a navigation-safe connectivity indicator.</li>
</ul>
<h2 id="design-notes-18"><a class="header" href="#design-notes-18">Design notes</a></h2>
<ul>
<li>App shell and dashboard markup map directly to <code>ui_vendor/nexus-html@3.1.0</code> partials and the ecommerce dashboard page.</li>
<li>Dashboard sections are split into Nexus-faithful organisms while preserving class names and nesting.</li>
<li>SSE status is stored in <code>system.sse_status</code>; indicator consumes a summary slice, modal consumes full details.</li>
</ul>
<h2 id="test-coverage-summary-18"><a class="header" href="#test-coverage-summary-18">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> (fmt, lint, udeps, audit, deny, ui-build, test, cov)</li>
</ul>
<h2 id="observability-updates-18"><a class="header" href="#observability-updates-18">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-plan-11"><a class="header" href="#risk--rollback-plan-11">Risk &amp; rollback plan</a></h2>
<ul>
<li>If Nexus markup causes regressions, revert to the previous dashboard/shell and reintroduce the prior CSS and route wiring.</li>
<li>If SSE diagnostics cause UI noise, hide the indicator by feature flag and keep reconnect logic intact.</li>
</ul>
<h2 id="dependency-rationale-18"><a class="header" href="#dependency-rationale-18">Dependency rationale</a></h2>
<ul>
<li>Added <code>web-sys</code> feature <code>HtmlDialogElement</code> to open the Nexus search modal via <code>show_modal</code> without new crates.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-hardline-nexus-dashboard-rebuild-and-settings-wiring"><a class="header" href="#ui-hardline-nexus-dashboard-rebuild-and-settings-wiring">UI: Hardline Nexus Dashboard Rebuild and Settings Wiring</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-26</li>
<li>Context:
<ul>
<li>The Home dashboard must match the vendored Nexus HTML structure and DaisyUI component patterns.</li>
<li>Navigation and shell need to be simplified to Home/Torrents/Settings with a non-blocking SSE indicator.</li>
<li>Settings must remain reachable even when auth is missing and show a config snapshot.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Rebuild dashboard sections to mirror Nexus markup (stats cards, storage status, recent events, tracker health, queue summary).</li>
<li>Align AppShell sidebar/topbar with Nexus partial structure and move the SSE indicator to the sidebar footer.</li>
<li>Wire Settings to fetch <code>/v1/config</code> and provide test-connection actions while keeping auth overlays off the Settings route.</li>
<li>Disable wasm-opt in the Trunk pipeline (<code>data-wasm-opt="0"</code>) to avoid build failures on missing staged wasm outputs.</li>
<li>Use relative static asset paths for Nexus CSS and dashboard image URLs to keep styles/images loading when served from non-root paths.</li>
<li>Alternatives considered: importing <code>revaer_config::ConfigSnapshot</code> into the UI; rejected to avoid new cross-crate dependencies in wasm.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive: consistent Nexus/DaisyUI layout, simplified nav, and settings access even during auth errors.</li>
<li>Trade-offs: UI-only fetches rely on runtime connectivity; config display is untyped JSON in the UI; wasm bundles are no longer optimized by wasm-opt.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Verify visual parity in the browser and keep the Nexus HTML deltas minimal.</li>
<li>Add typed config rendering if a UI-safe shared type becomes available.</li>
</ul>
</li>
</ul>
<h2 id="task-record-1"><a class="header" href="#task-record-1">Task Record</a></h2>
<ul>
<li>Motivation: enforce Nexus + DaisyUI parity for the dashboard while keeping Settings reachable and diagnostics visible.</li>
<li>Design notes: mapped each dashboard section to specific Nexus blocks; SSE indicator uses sidebar footer with a non-blocking dialog; config snapshot parsed as <code>serde_json::Value</code> to avoid new dependencies; disabled wasm-opt in <code>crates/revaer-ui/index.html</code> to keep <code>trunk build --release</code> reliable on this environment until tooling changes; aligned Nexus image URLs to <code>/static/nexus/...</code> for correct asset loading on all routes; aligned the sidebar footer indicator to the Nexus pinned-footer structure, restored the missing Global Sales card slot, and made the auth prompt non-blocking while stabilizing drawer hook usage; re-aligned the torrents filter header to the Nexus orders layout, updated the search input to use DaisyUI <code>input-sm</code> sizing, removed the custom placeholder override to let DaisyUI placeholder styles apply, and removed the legacy torrent list view.</li>
<li>Test coverage summary: <code>just ci</code> runs but <code>just cov</code> fails at ~77.6% overall line coverage (below the ≥80% gate); no new unit tests added in this update.</li>
<li>Observability updates: none (UI-only changes).</li>
<li>Risk &amp; rollback plan: revert <code>crates/revaer-ui</code> dashboard/shell/settings edits and <code>static/style.css</code> if UI regressions appear.</li>
<li>Dependency rationale: no new dependencies added; reused existing <code>serde_json</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-dashboard-nexus-parity-tweaks"><a class="header" href="#ui-dashboard-nexus-parity-tweaks">UI Dashboard Nexus Parity Tweaks</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-27</li>
<li>Context:
<ul>
<li>Dashboard cards drifted from the vendored Nexus markup and referenced missing i18n keys.</li>
<li>Connectivity modal included fields outside the required SSE status spec.</li>
<li>Constraints: keep Nexus layout structure, use DaisyUI semantic tokens, avoid new dependencies.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Rework the storage usage and tracker health cards to match Nexus layout structure and available translation keys.</li>
<li>Align queue summary/global summary labels to existing nav/dashboard strings.</li>
<li>Trim the SSE connectivity modal to the required fields and labels.</li>
<li>Replace dashboard recent events table markup with a DaisyUI list layout.</li>
<li>Limit SSE indicator label expansion to the sidebar expanded state only.</li>
<li>Alternatives considered: adding new translation keys across all locales (rejected for scope and translation burden).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: fewer missing strings, closer Nexus parity, clearer SSE status display.</li>
<li>Risks or trade-offs: storage usage detail reduced to summary metrics; some labels remain static in English where Nexus requires them.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Manually verify Nexus dashboard parity and table hover styling in the UI.</li>
</ul>
</li>
</ul>
<h2 id="motivation-19"><a class="header" href="#motivation-19">Motivation</a></h2>
<ul>
<li>Restore Nexus layout parity for dashboard sections and eliminate missing dashboard translation keys.</li>
</ul>
<h2 id="design-notes-19"><a class="header" href="#design-notes-19">Design Notes</a></h2>
<ul>
<li>Storage usage mirrors the Nexus revenue card layout with the chart slot preserved.</li>
<li>Tracker health metrics follow the Nexus acquisition grid with two columns and error count in the header.</li>
<li>Queue summary and global summary labels use existing nav/dashboard translations.</li>
<li>SSE connectivity modal aligns with the required status fields only.</li>
<li>Recent events use a DaisyUI list layout that preserves the Nexus header structure.</li>
<li>Row-hover styling applies to list rows for parity with table hover behavior.</li>
</ul>
<h2 id="test-coverage-summary-19"><a class="header" href="#test-coverage-summary-19">Test Coverage Summary</a></h2>
<ul>
<li>No new tests added; UI-only changes.</li>
</ul>
<h2 id="observability-updates-19"><a class="header" href="#observability-updates-19">Observability Updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="risk--rollback-plan-12"><a class="header" href="#risk--rollback-plan-12">Risk &amp; Rollback Plan</a></h2>
<ul>
<li>Low risk; revert the UI component edits if layout regressions appear.</li>
</ul>
<h2 id="dependency-rationale-19"><a class="header" href="#dependency-rationale-19">Dependency Rationale</a></h2>
<ul>
<li>No new dependencies introduced.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="factory-reset-and-bootstrap-api-key"><a class="header" href="#factory-reset-and-bootstrap-api-key">Factory Reset and Bootstrap API Key</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-27</li>
<li>Context:
<ul>
<li>Need a safe factory reset workflow that keeps navigation available while enforcing confirmation.</li>
<li>Setup completion must return a bootstrap API key with a 14-day client-side expiry.</li>
<li>Raw reset errors must surface to the UI for operator visibility.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add <code>revaer_config.factory_reset()</code> stored procedure and <code>/admin/factory-reset</code> API endpoint guarded by API key auth.</li>
<li>Ensure setup completion provisions or reuses a bootstrap API key and returns it with an expiry timestamp.</li>
<li>Persist the bootstrap API key with expiry in local storage and require manual dismissal for error toasts.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Factory reset clears configuration/runtime data and returns the system to setup mode.</li>
<li>API key expiry is enforced on the client; the server remains stateless about expiry.</li>
<li>Reset failures are delivered verbatim to clients for display.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Update OpenAPI export, UI dropdown + modal wiring, and storage helpers.</li>
<li>Verify CI and runtime migrations.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="factory-reset-bootstrap-auth-fallback"><a class="header" href="#factory-reset-bootstrap-auth-fallback">Factory reset bootstrap auth fallback</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-28</li>
<li>Context:
<ul>
<li>Factory reset requires API key auth, but existing installs can be in <code>active</code> mode with zero API keys (pre-bootstrap).</li>
<li>Without a key, the UI cannot authenticate and the system has no recovery path.</li>
<li>The reset path must still use stored procedures and surface raw errors when the reset fails.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add a <code>has_api_keys</code> capability to the config facade so the API can detect empty key inventories.</li>
<li>Introduce a factory-reset-specific auth gate that accepts valid API keys, or allows the reset when no API keys exist (logging a warning).</li>
<li>Keep confirmation phrase validation unchanged.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Provides a recovery path for deployments missing API keys.</li>
<li>When no API keys exist, factory reset can be triggered without auth; this is acceptable because the system is already unauthenticated in that state.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Consider tightening the fallback to loopback-only requests if new auth modes are added.</li>
<li>Ensure UI messaging continues to surface authorization errors via toasts.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-settings-tabs-and-editor-controls"><a class="header" href="#ui-settings-tabs-and-editor-controls">UI settings tabs and editor controls</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-28</li>
<li>Context:
<ul>
<li>The settings screen exposed raw configuration values without meaningful grouping or editing controls.</li>
<li>Torrent operators need quick access to download, seeding, network, and storage controls with clear defaults.</li>
<li>Settings patches must flow through the existing API and honor immutable fields.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Rebuild the settings UI as tabbed panels aligned with torrent workflows (connection, downloads, seeding, network, storage, system).</li>
<li>Drive all editable controls from the config snapshot and submit targeted <code>/v1/config</code> changesets per group.</li>
<li>Treat immutable fields and effective engine snapshots as read-only with copy-to-clipboard affordances.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Settings are now grouped for faster navigation and support direct edits with consistent controls.</li>
<li>The UI performs more client-side validation for numeric and JSON fields before patching.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Evaluate dedicated server-side directory browsing if operators need richer path discovery.</li>
<li>Add localization for settings field labels where needed.</li>
</ul>
</li>
</ul>
<h2 id="motivation-20"><a class="header" href="#motivation-20">Motivation</a></h2>
<ul>
<li>Make settings usable for torrent operators by grouping them into purpose-built tabs.</li>
<li>Replace raw config tables with toggles, selects, numeric inputs, and path pickers.</li>
<li>Ensure read-only values are still accessible via copy actions.</li>
</ul>
<h2 id="design-notes-20"><a class="header" href="#design-notes-20">Design notes</a></h2>
<ul>
<li>Draft values are derived from the latest config snapshot and compared to build minimal changesets.</li>
<li>Immutable keys from <code>app_profile.immutable_keys</code> and derived engine fields are rendered read-only.</li>
<li>Directory selection uses a modal picker with suggested paths from the snapshot.</li>
</ul>
<h2 id="test-coverage-summary-20"><a class="header" href="#test-coverage-summary-20">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code></li>
</ul>
<h2 id="observability-updates-20"><a class="header" href="#observability-updates-20">Observability updates</a></h2>
<ul>
<li>UI toasts surface config patch failures and copy failures; no new metrics.</li>
</ul>
<h2 id="risk--rollback-plan-13"><a class="header" href="#risk--rollback-plan-13">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: incorrect grouping or input parsing could lead to failed patches.</li>
<li>Rollback: revert to the previous settings view and re-fetch configuration.</li>
</ul>
<h2 id="dependency-rationale-20"><a class="header" href="#dependency-rationale-20">Dependency rationale</a></h2>
<ul>
<li>No new dependencies.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ui-settings-controls-logs-stream-and-filesystem-browser"><a class="header" href="#ui-settings-controls-logs-stream-and-filesystem-browser">UI Settings Controls, Logs Stream, and Filesystem Browser</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-28</li>
<li>Context:
<ul>
<li>Motivation: replace JSON settings editing with structured controls, add an on-demand logs view, and provide a server-backed filesystem browser for path selection.</li>
<li>Constraints: keep stored-procedure access, avoid new dependencies, and only stream logs while the Logs route is active.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Added an SSE logs stream backed by a log broadcast writer and a Logs UI route that connects only while mounted.</li>
<li>Added a filesystem browse endpoint and path picker UI for directory selection, with server-side path validation for label policy download dirs.</li>
<li>Reworked settings into tabbed sections with a single draft/save bar and structured field editors.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive: consistent UI controls, safer path selection, and live logs available without background streaming.</li>
<li>Risks: invalid paths now fail validation; recovery requires clearing the offending field or updating the path.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Tests: no new dependencies; validation logic exercised via existing config pathways (add focused tests if coverage drops).</li>
<li>Observability: log stream events emit via SSE; status surfaced in UI badge.</li>
<li>Risk &amp; rollback: revert the logs route/endpoint and path validation if regressions appear; keep previous settings UI behind a feature branch.</li>
<li>Dependency rationale: no new dependencies added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="059--migration-rebaseline-and-json-backfill-guardrails"><a class="header" href="#059--migration-rebaseline-and-json-backfill-guardrails">059 – Migration Rebaseline And JSON Backfill Guardrails</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-28</li>
<li>Context:
<ul>
<li>Migration sprawl made upgrades brittle and conflicted with the single-file mandate.</li>
<li>JSON columns are banned for settings; backfills must not wipe normalized data on upgrade.</li>
<li>The baseline migration must be idempotent for both new databases and upgrades.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Collapse migration history into <code>crates/revaer-data/migrations/0007_rebaseline.sql</code> and remove prior migration files.</li>
<li>Add upgrade-safe guardrails in the JSON backfill to avoid overwriting normalized data when legacy columns are empty or newly introduced.</li>
<li>Mark the configuration migrator to ignore missing files so existing databases can apply the new baseline cleanly.</li>
<li>Update documentation and dev seed SQL to match the normalized schema.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive: one deterministic baseline, no JSON columns in the final schema, safer upgrades.</li>
<li>Trade-offs: the baseline SQL is larger and includes legacy steps to support upgrades.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Run the full <code>just ci</code> gate and validate factory reset behavior against a real database.</li>
<li>Monitor future schema changes to ensure they append to the consolidated baseline.</li>
</ul>
</li>
<li>Motivation:
<ul>
<li>Ensure migration idempotency and JSON-free settings storage without breaking existing installations.</li>
</ul>
</li>
<li>Design notes:
<ul>
<li>Keep legacy JSON parsing helpers only long enough to migrate data; drop them in the same baseline.</li>
<li>Add trigger drops to make DDL re-entrant when applying the baseline on upgraded databases.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li><code>just check</code> (workspace, all targets, all features).</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>No telemetry changes required.</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Risk: legacy upgrade paths could still expose migration gaps; rollback by restoring the previous migration set from version control.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new dependencies introduced.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="auth-expiry--error-context-fields"><a class="header" href="#auth-expiry--error-context-fields">Auth Expiry + Error Context Fields</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-28</li>
<li>Context:
<ul>
<li>Factory reset failures must surface raw error details to clients without embedding context in error messages.</li>
<li>Setup completion must issue an API key that expires after 14 days, and expiration must be enforced server-side.</li>
<li>JSONB-based helpers are disallowed; legacy helpers must be removed while preserving upgrade paths.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add an optional <code>expires_at</code> timestamp to <code>auth_api_keys</code> and extend API key upsert helpers to persist it.</li>
<li>Extend RFC9457 <code>ProblemDetails</code> with structured <code>context</code> fields so raw error details can be returned separately from constant error messages.</li>
<li>Purge JSONB-based helper functions during migration to keep final database surfaces JSON-free.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: API key expiry is enforced consistently; error responses can include raw details without violating message rules; migrations end with JSONB-free functions.</li>
<li>Risks or trade-offs: Existing API clients must tolerate the new <code>context</code> field; migrations rely on drop logic to clear legacy helper functions.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: update API key auth reads to respect expiry; add error context plumbing in API/UI clients; keep openapi export in sync.</li>
<li>Review checkpoints: verify migrations run cleanly, JSONB functions are absent, and factory reset errors surface in toasts.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="api-i18n-error-localization-and-openapi-assets"><a class="header" href="#api-i18n-error-localization-and-openapi-assets">API i18n error localization and OpenAPI assets</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-29</li>
<li>Context:
<ul>
<li>API error responses needed localization via <code>Accept-Language</code> without introducing new dependencies.</li>
<li><code>openapi.rs</code> could not retain hard-coded asset paths while still embedding the spec.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add a lightweight API i18n module that selects a locale from <code>Accept-Language</code>, loads an embedded bundle, and localizes error titles/details/invalid params with fallback to the original string.</li>
<li>Centralize embedded OpenAPI assets in a dedicated module so <code>openapi.rs</code> is path-free.</li>
<li>Alternatives considered: key-based localization in all error constructors (larger refactor); relying on client-only localization (does not meet API requirement).</li>
</ul>
</li>
<li>Design notes:
<ul>
<li>Locale parsing accepts the first supported tag and falls back to <code>en</code>.</li>
<li>Translation load failures are logged once and degrade to identity translations.</li>
<li>OpenAPI asset constants are crate-private to avoid leaking filesystem structure.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li>Added unit coverage for locale parsing, translation availability, and fallback behavior in the i18n module.</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>Translation load failures emit a structured error log with the locale.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Error responses now pass through a localization hook; untranslated strings remain unchanged.</li>
<li>OpenAPI asset paths are centralized for easier maintenance.</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Risk: missing translation keys fall back to the original message. Roll back by removing i18n middleware and restoring direct error serialization.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new dependencies; reused existing <code>serde_json</code> and standard library types.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Expand message coverage in <code>crates/revaer-api/i18n/en.json</code> as new error strings are added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="event-bus-publish-guardrails--api-i18n-cleanup"><a class="header" href="#event-bus-publish-guardrails--api-i18n-cleanup">Event Bus Publish Guardrails + API i18n Cleanup</a></h1>
<ul>
<li>
<p>Status: Accepted</p>
</li>
<li>
<p>Date: 2025-12-28</p>
</li>
<li>
<p>Context:</p>
<ul>
<li>Event publishing failures were silently ignored, violating the no-error-suppression rule.</li>
<li>Several API error strings were missing i18n keys, breaking the localized error contract.</li>
<li>A few runtime logs still interpolated context into messages and needed structured fields.</li>
</ul>
</li>
<li>
<p>Decision:</p>
<ul>
<li>Introduce <code>EventBusError</code> and make <code>EventBus::publish</code> return <code>Result</code> so failures are handled explicitly.</li>
<li>Add publish helpers in runtime services (API state, fsops, libtorrent worker, app bootstrap) that log publish failures with structured fields.</li>
<li>Expand the API i18n bundle to include new error keys used by settings and auth flows.</li>
<li>Move <code>anyhow</code> to dev-dependencies for <code>revaer-api</code> and remove the remaining debug assert/log interpolation in production paths.</li>
</ul>
</li>
<li>
<p>Consequences:</p>
<ul>
<li>Positive outcomes: event publishing is no longer silently ignored; API error messages are consistently localizable; log output stays structured.</li>
<li>Risks or trade-offs: event publish errors are now surfaced via warnings, which may be noisy if the bus is misconfigured.</li>
</ul>
</li>
<li>
<p>Follow-up:</p>
<ul>
<li>Implementation tasks: ensure downstream callers handle <code>EventBusError</code> where needed; keep i18n bundles in sync with new error keys.</li>
<li>Review checkpoints: confirm <code>just ci</code> passes and that SSE/event flows still deliver updates without regressions.</li>
</ul>
</li>
<li>
<p>Motivation:</p>
<ul>
<li>Align runtime error handling with AGENT.md guardrails and remove hidden failure paths.</li>
</ul>
</li>
<li>
<p>Design notes:</p>
<ul>
<li>Event bus publish errors expose <code>event_id</code> + <code>event_kind</code> for structured logging without embedding context in messages.</li>
<li>API error strings added to <code>en.json</code> match the exact keys emitted by handlers.</li>
</ul>
</li>
<li>
<p>Test coverage summary:</p>
<ul>
<li>Not run in this change set; run <code>just ci</code> before release.</li>
</ul>
</li>
<li>
<p>Observability updates:</p>
<ul>
<li>Added structured warning logs when event publishing fails.</li>
</ul>
</li>
<li>
<p>Risk &amp; rollback plan:</p>
<ul>
<li>Low risk; revert to prior publish semantics if event logging proves too noisy.</li>
</ul>
</li>
<li>
<p>Dependency rationale:</p>
<ul>
<li>No new dependencies added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ci-compliance-cleanup-for-test-error-handling"><a class="header" href="#ci-compliance-cleanup-for-test-error-handling">CI compliance cleanup for test error handling</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-30</li>
<li>Context:
<ul>
<li>Motivation: restore <code>just ci</code> compliance and remove explicit panic/unwrap patterns in tests to align with AGENT error-handling rules.</li>
<li>Constraints: keep coverage ≥ 80% and avoid new dependencies while satisfying clippy::pedantic.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Replace explicit <code>panic!</code>/<code>unwrap</code> usages in tests with Result-returning flows and <code>let...else</code> patterns.</li>
<li>Exercise must-use values in tests to avoid lint violations.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: lint clean, tests remain deterministic, and coverage stays above the gate.</li>
<li>Risks or trade-offs: slightly more verbose test code; added Result plumbing in tests.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: keep new tests using <code>Result</code> and <code>let...else</code> patterns when adding coverage.</li>
<li>Review checkpoints: re-run <code>just ci</code> after any test refactors.</li>
</ul>
</li>
</ul>
<h2 id="design-notes-21"><a class="header" href="#design-notes-21">Design notes</a></h2>
<ul>
<li>Tests now surface unexpected success paths as explicit error returns instead of panics.</li>
<li><code>Sse</code> test responses are exercised via <code>into_response</code> to satisfy must-use lints.</li>
</ul>
<h2 id="test-coverage-summary-21"><a class="header" href="#test-coverage-summary-21">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code> completed with line coverage at 80.04%.</li>
</ul>
<h2 id="observability-updates-21"><a class="header" href="#observability-updates-21">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="dependency-rationale-21"><a class="header" href="#dependency-rationale-21">Dependency rationale</a></h2>
<ul>
<li>No new dependencies added.</li>
</ul>
<h2 id="risk--rollback-plan-14"><a class="header" href="#risk--rollback-plan-14">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: minimal; changes are confined to tests.</li>
<li>Rollback: revert this ADR and the test-only edits, then re-run <code>just ci</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="factory-reset-hardening-and-allow-path-validation"><a class="header" href="#factory-reset-hardening-and-allow-path-validation">Factory reset hardening and allow-path validation</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-30</li>
<li>Context:
<ul>
<li>Motivation: surface actionable factory reset failures, prevent long-running resets from hanging, and tighten allow-path validation for directory entries.</li>
<li>Constraints: preserve API i18n behavior, keep error context structured, and avoid new dependencies or inline SQL outside migrations.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Derive the deepest error source string for factory reset failures and return it in structured context.</li>
<li>Allow factory resets to proceed without API keys when no keys exist, even if a stale API key header is present.</li>
<li>Add a lock timeout in the factory reset stored procedure to avoid indefinite blocking.</li>
<li>Validate each allow-path entry as a non-empty directory before persisting updates.</li>
<li>Add unit tests covering error extraction and the stale API key path.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: factory reset failures surface raw causes; invalid allow-path entries are rejected; resets fail fast on lock contention.</li>
<li>Risks or trade-offs: stricter validation can reject empty allow-path entries that previously slipped through; lock timeouts may require retrying during heavy database activity.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: confirm UI toasts surface context fields for factory reset failures and lock timeouts.</li>
<li>Review checkpoints: run <code>just ci</code> and <code>just build-release</code> before handoff.</li>
</ul>
</li>
</ul>
<h2 id="design-notes-22"><a class="header" href="#design-notes-22">Design notes</a></h2>
<ul>
<li>Walk the <code>Error::source</code> chain to surface the innermost message without mutating the API detail string.</li>
</ul>
<h2 id="test-coverage-summary-22"><a class="header" href="#test-coverage-summary-22">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code>: line coverage 80.06%.</li>
<li><code>just build-release</code>: succeeded.</li>
</ul>
<h2 id="observability-updates-22"><a class="header" href="#observability-updates-22">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="dependency-rationale-22"><a class="header" href="#dependency-rationale-22">Dependency rationale</a></h2>
<ul>
<li>No new dependencies added.</li>
</ul>
<h2 id="risk--rollback-plan-15"><a class="header" href="#risk--rollback-plan-15">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: allow-path validation rejects empty entries; factory reset error context exposes raw backend errors; lock timeout may surface new transient failures during heavy DB activity.</li>
<li>Rollback: revert the allow-path validation, auth fallback, and lock-timeout adjustments, remove the related tests, then re-run <code>just ci</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="api-key-refresh-and-no-auth-setup-mode"><a class="header" href="#api-key-refresh-and-no-auth-setup-mode">API key refresh and no-auth setup mode</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-30</li>
<li>Context:
<ul>
<li>Motivation: keep API keys valid without manual re-auth, and allow local setup flows to opt into anonymous access.</li>
<li>Constraints: no new dependencies, stored-procedure-only config writes, and API errors localized through i18n.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add <code>app_profile.auth_mode</code> with <code>api_key</code>/<code>none</code> and allow anonymous auth when <code>none</code> is configured.</li>
<li>Introduce <code>/v1/auth/refresh</code> to extend API key expiry without rotation, and schedule refresh in the UI before expiry.</li>
<li>Persist anonymous auth state for no-auth setups and reuse the well-known snapshot for setup changeset construction.</li>
<li>Store API key expirations in local storage and refresh with a 24-hour safety skew.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: no-auth local deployments work without API keys; API keys remain valid without user action.</li>
<li>Risks or trade-offs: no-auth mode reduces access control if enabled unintentionally; refresh scheduling depends on client time.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: keep OpenAPI spec and UI translations in sync with new auth/refresh UX.</li>
<li>Review checkpoints: run <code>just ci</code> and <code>just build-release</code> before handoff.</li>
</ul>
</li>
</ul>
<h2 id="design-notes-23"><a class="header" href="#design-notes-23">Design notes</a></h2>
<ul>
<li>Auth mode is stored in <code>app_profile</code> and enforced in API auth middleware.</li>
<li>Token refresh extends expiry only; no rotation or secret re-issuance.</li>
</ul>
<h2 id="test-coverage-summary-23"><a class="header" href="#test-coverage-summary-23">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code>: line coverage 80.03%.</li>
<li><code>just build-release</code>: succeeded.</li>
</ul>
<h2 id="observability-updates-23"><a class="header" href="#observability-updates-23">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="dependency-rationale-23"><a class="header" href="#dependency-rationale-23">Dependency rationale</a></h2>
<ul>
<li>No new dependencies added.</li>
</ul>
<h2 id="risk--rollback-plan-16"><a class="header" href="#risk--rollback-plan-16">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: anonymous access enabled on non-local deployments; refresh timing sensitive to client clock drift.</li>
<li>Rollback: remove <code>auth_mode</code>, revert auth middleware and refresh endpoint, and delete UI refresh scheduling plus setup auth mode selection.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="factory-reset-ux-fallback-and-sse-setup-gating"><a class="header" href="#factory-reset-ux-fallback-and-sse-setup-gating">Factory reset UX fallback and SSE setup gating</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-30</li>
<li>Context:
<ul>
<li>Motivation: SSE returns 409 when the server is in setup mode, leaving the UI stuck after factory reset or manual setup transitions.</li>
<li>Constraints: keep the UI non-blocking, avoid API key reuse after reset, and keep state transitions client-driven without new dependencies.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Gate SSE connection on <code>AppModeState</code> and surface a disconnected status when the server is in setup mode.</li>
<li>Treat SSE 409 responses as a setup signal: clear auth state and move the app into setup mode in the store.</li>
<li>Ensure factory reset success forces <code>AppModeState::Setup</code> even if the reload fails.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: factory reset lands users on the setup flow; SSE no longer loops on 409 responses.</li>
<li>Risks or trade-offs: clears stored auth on setup transitions, requiring re-auth after reset.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: monitor setup flows for any unexpected auth clears and adjust messaging if needed.</li>
<li>Review checkpoints: run <code>just ci</code> and <code>just build-release</code> before handoff.</li>
</ul>
</li>
</ul>
<h2 id="design-notes-24"><a class="header" href="#design-notes-24">Design notes</a></h2>
<ul>
<li>SSE is disabled in setup mode to prevent repeated 409 retries and to keep the UI responsive.</li>
<li>Setup transitions clear auth storage to avoid stale API keys after reset.</li>
</ul>
<h2 id="test-coverage-summary-24"><a class="header" href="#test-coverage-summary-24">Test coverage summary</a></h2>
<ul>
<li><code>just ci</code>: failed (<code>cargo llvm-cov</code> line coverage 77.59% &lt; 80%).</li>
</ul>
<h2 id="observability-updates-24"><a class="header" href="#observability-updates-24">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="dependency-rationale-24"><a class="header" href="#dependency-rationale-24">Dependency rationale</a></h2>
<ul>
<li>No new dependencies added.</li>
</ul>
<h2 id="risk--rollback-plan-17"><a class="header" href="#risk--rollback-plan-17">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: users expecting to keep API keys across resets will have to re-authenticate.</li>
<li>Rollback: remove SSE setup gating and 409 handling, revert factory reset UI state updates, and restore previous auth persistence behavior.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="logs-ansi-rendering-and-bounded-buffer"><a class="header" href="#logs-ansi-rendering-and-bounded-buffer">Logs ANSI rendering and bounded buffer</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-30</li>
<li>Context:
<ul>
<li>Motivation: logs view must preserve ANSI color/style codes, Unicode characters, and remain responsive over long sessions.</li>
<li>Constraints: keep memory usage bounded, avoid new dependencies, keep layout aligned with UI rules, and avoid build conflicts with <code>trunk serve</code>.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Parse ANSI SGR sequences into styled spans for rendering with theme-aware colors.</li>
<li>Keep a bounded in-memory log buffer with a fixed max size.</li>
<li>Use streaming text decode to preserve multibyte characters across chunks.</li>
<li>Add new log lines to the top of the view and restrict scrolling to the terminal area.</li>
<li>Use a dedicated <code>dist-serve</code> directory for <code>trunk serve</code> to avoid staging conflicts with <code>ui-build</code>.</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: log output retains color/style and Unicode, memory growth is capped, log background is black.</li>
<li>Risks or trade-offs: ANSI color mapping approximates terminal colors via theme tokens and CSS variables.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Implementation tasks: monitor logs stream for any unhandled ANSI sequences and extend parsing as needed.</li>
<li>Review checkpoints: run <code>just ci</code> before handoff.</li>
</ul>
</li>
</ul>
<h2 id="test-coverage-summary-25"><a class="header" href="#test-coverage-summary-25">Test coverage summary</a></h2>
<ul>
<li><code>just ui-build</code>: failed (wasm-bindgen could not write to staging directory while <code>trunk serve</code> was running).</li>
</ul>
<h2 id="observability-updates-25"><a class="header" href="#observability-updates-25">Observability updates</a></h2>
<ul>
<li>None.</li>
</ul>
<h2 id="dependency-rationale-25"><a class="header" href="#dependency-rationale-25">Dependency rationale</a></h2>
<ul>
<li>No new dependencies added.</li>
</ul>
<h2 id="risk--rollback-plan-18"><a class="header" href="#risk--rollback-plan-18">Risk &amp; rollback plan</a></h2>
<ul>
<li>Risk: unusual ANSI sequences may render as plain text.</li>
<li>Rollback: remove ANSI parsing and revert to raw log line rendering.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="agent-compliance-clippy-cargo-lints"><a class="header" href="#agent-compliance-clippy-cargo-lints">Agent Compliance: Clippy Cargo Lints</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2025-12-31</li>
<li>Context:
<ul>
<li>AGENT.md mandates clippy::cargo in the crate-level deny list for every lib/main.</li>
<li>Several crate roots were missing clippy::cargo, which is a documented compliance violation.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Add clippy::cargo to every crate-level lint deny list alongside clippy::all/pedantic/nursery.</li>
<li>Keep existing unsafe-code policies intact (FFI-only allowances remain scoped).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Positive outcomes: consistent lint coverage across crates; future clippy::cargo issues surface early.</li>
<li>Risks or trade-offs: additional lint findings may require follow-up fixes in future changes.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Run just ci to confirm the lint gate passes across the workspace.</li>
<li>Monitor future changes for clippy::cargo warnings introduced by new code.</li>
</ul>
</li>
<li>Motivation:
<ul>
<li>Align all crates with AGENT.md lint requirements and eliminate policy drift.</li>
</ul>
</li>
<li>Design notes:
<ul>
<li>Automated, minimal insertion of clippy::cargo after clippy::pedantic in existing deny lists.</li>
</ul>
</li>
<li>Test coverage summary:
<ul>
<li>just ci (full pipeline) is required before hand-off; run after edits.</li>
</ul>
</li>
<li>Observability updates:
<ul>
<li>None.</li>
</ul>
</li>
<li>Risk &amp; rollback plan:
<ul>
<li>Roll back the lint list changes if they conflict with a required exception, then document a targeted ADR.</li>
</ul>
</li>
<li>Dependency rationale:
<ul>
<li>No new dependencies added.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="docs-pin-mdbook-mermaid-for-just-docs"><a class="header" href="#docs-pin-mdbook-mermaid-for-just-docs">Docs: Pin mdbook-mermaid for just docs</a></h1>
<ul>
<li>
<p>Status: Accepted</p>
</li>
<li>
<p>Date: 2025-12-31</p>
</li>
<li>
<p>Context:</p>
<ul>
<li>Motivation: <code>just docs</code> failed because mdbook-mermaid 0.16.2 cannot parse under mdbook 0.5.2, even though docs are valid.</li>
<li>Constraints: Docs build must run via <code>just</code>, no manual tooling, avoid repo changes outside the justfile.</li>
<li>Test coverage summary: <code>just docs</code> run after change; no unit tests applicable.</li>
<li>Observability updates: None.</li>
<li>Dependency rationale: No new crates; pin existing mdbook-mermaid tool to 0.17.0 to match mdbook 0.5.x behavior.</li>
</ul>
</li>
<li>
<p>Decision:</p>
<ul>
<li>Require mdbook-mermaid 0.17.0 in <code>just docs-install</code> and reinstall if mismatched.</li>
<li>Make <code>just docs</code> invoke <code>just docs-install</code> before build and index.</li>
<li>Alternatives considered: rely on user-managed tool versions; pin mdbook to 0.5.0; remove mermaid preprocessor.</li>
</ul>
</li>
<li>
<p>Consequences:</p>
<ul>
<li>Positive outcomes: <code>just docs</code> consistently installs a compatible mermaid preprocessor and builds successfully.</li>
<li>Risks or trade-offs: Running <code>just docs</code> may reinstall mdbook-mermaid when versions differ; version pin may lag future mdbook releases.</li>
<li>Risk &amp; rollback plan: If issues arise, revert the <code>justfile</code> change or update the pinned version and rerun <code>just docs</code>.</li>
</ul>
</li>
<li>
<p>Follow-up:</p>
<ul>
<li>Implementation tasks: Update <code>justfile</code> and verify <code>just docs</code>.</li>
<li>Review checkpoints: Revisit the pin when mdbook or mdbook-mermaid releases require it.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="dashboard-ui-checklist-completion-and-authsse-hardening"><a class="header" href="#dashboard-ui-checklist-completion-and-authsse-hardening">Dashboard UI checklist completion and auth/SSE hardening</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2026-01-01</li>
</ul>
<h2 id="motivation-21"><a class="header" href="#motivation-21">Motivation</a></h2>
<ul>
<li>Complete remaining dashboard UI checklist items without adding new dependencies.</li>
<li>Tighten auth and SSE handling to avoid stale tokens and replay conflicts.</li>
</ul>
<h2 id="context-10"><a class="header" href="#context-10">Context</a></h2>
<ul>
<li>UI relies on SSE for live torrent updates and must survive Last-Event-ID conflicts.</li>
<li>Auth tokens require a 14-day TTL enforced by both server and client.</li>
<li>UI should allow anonymous mode when server auth_mode is none.</li>
</ul>
<h2 id="decision-15"><a class="header" href="#decision-15">Decision</a></h2>
<ul>
<li>Move torrent sort state into URL-backed filters and apply client-side ordering.</li>
<li>Reset SSE Last-Event-ID on 409 conflict and reconnect with backoff.</li>
<li>Refresh API keys on save to capture expiry; invalidate keys on logout via config patch.</li>
<li>Mirror CORS origin on the API router to cover SSE and REST.</li>
</ul>
<p>Alternatives considered:</p>
<ul>
<li>Add a dedicated logout endpoint: rejected to avoid OpenAPI changes.</li>
<li>Store API keys without expiry: rejected to enforce 14-day TTL.</li>
</ul>
<h2 id="design-notes-25"><a class="header" href="#design-notes-25">Design Notes</a></h2>
<ul>
<li>Sorting is represented as <code>sort=key:dir</code> in the query string.</li>
<li>Metadata updates trigger a targeted list refresh to keep tags/trackers current.</li>
<li>Anonymous auth is enabled from <code>.well-known</code> app_profile when configured.</li>
</ul>
<h2 id="consequences-15"><a class="header" href="#consequences-15">Consequences</a></h2>
<ul>
<li>Login now performs a refresh call to capture expiry; failures surface as toasts.</li>
<li>Some SSE metadata events trigger list refreshes, increasing fetch volume.</li>
</ul>
<h2 id="test-coverage-summary-26"><a class="header" href="#test-coverage-summary-26">Test Coverage Summary</a></h2>
<ul>
<li><code>DATABASE_URL=postgres://revaer:revaer@172.17.0.1:5432/revaer REVAER_TEST_DATABASE_URL=postgres://revaer:revaer@172.17.0.1:5432/revaer just ci</code>
(fmt, lint, udeps, audit, deny, ui-build, test, test-features-min, cov).</li>
</ul>
<h2 id="observability-updates-26"><a class="header" href="#observability-updates-26">Observability Updates</a></h2>
<ul>
<li>No new metrics or tracing changes.</li>
</ul>
<h2 id="risk--rollback-plan-19"><a class="header" href="#risk--rollback-plan-19">Risk &amp; Rollback Plan</a></h2>
<ul>
<li>Risk: logout fails if config patch is rejected; UI now reports an error toast.</li>
<li>Rollback: revert UI auth/SSE changes and re-run <code>just ci</code>.</li>
</ul>
<h2 id="dependency-rationale-26"><a class="header" href="#dependency-rationale-26">Dependency Rationale</a></h2>
<ul>
<li>Updated <code>sqlx</code> to 0.9.0-alpha.1 and aligned vendored <code>hashlink</code> to hashbrown 0.16 to
satisfy <code>clippy::multiple_crate_versions</code> without introducing git dependencies.</li>
</ul>
<h2 id="follow-up-7"><a class="header" href="#follow-up-7">Follow-up</a></h2>
<ul>
<li>Confirm auth refresh behavior against expired keys during QA.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="071-libtorrent-native-fallback-for-default-ci"><a class="header" href="#071-libtorrent-native-fallback-for-default-ci">071: Libtorrent Native Fallback for Default CI</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Date: 2026-01-02</li>
<li>Context:
<ul>
<li><code>just ci</code> runs <code>cargo udeps</code> across the workspace and fails on hosts without libtorrent headers or pkg-config data.</li>
<li>Native libtorrent integration tests are explicitly gated by <code>REVAER_NATIVE_IT</code>, so default runs should remain deterministic without requiring native system deps.</li>
</ul>
</li>
<li>Decision:
<ul>
<li>Gate native FFI compilation behind a build-time cfg (<code>libtorrent_native</code>) that is emitted only when libtorrent is discovered by <code>build.rs</code>.</li>
<li>When <code>REVAER_NATIVE_IT</code> is set, missing libtorrent is treated as an error; otherwise the build falls back to the stub backend with a warning.</li>
<li>Alternatives considered: require libtorrent for all CI/dev runs, or remove <code>--all-features</code> from the quality gates (rejected to keep feature coverage intact).</li>
</ul>
</li>
<li>Consequences:
<ul>
<li>Default <code>just ci</code> succeeds on machines without libtorrent while still honoring native coverage when explicitly requested.</li>
<li>Feature-enabled builds no longer guarantee native bindings unless libtorrent is present; native builds must opt in via <code>REVAER_NATIVE_IT</code>.</li>
<li><code>cargo-udeps</code> ignores the <code>cxx</code> dependency for this crate because usage is gated by the native cfg.</li>
</ul>
</li>
<li>Follow-up:
<ul>
<li>Ensure native CI matrix jobs set <code>REVAER_NATIVE_IT=1</code> and install or bundle libtorrent.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid-eefea253.min.js"></script>
        <script src="mermaid-init-ccf746f1.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
