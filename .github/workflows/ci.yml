name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency: docs-${{ github.ref }}

env:
  CARGO_TERM_COLOR: always

jobs:
  # Quick formatting check that can run in parallel
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: taiki-e/install-action@just

      - name: Format Check
        run: just fmt

  # Main CI pipeline
  ci:
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview
      - uses: dtolnay/rust-toolchain@nightly
      - uses: taiki-e/install-action@just

      - name: Install native libtorrent dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libtorrent-rasterbar-dev pkg-config

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      # Run the complete CI pipeline using justfile
      - run: just ci

  # Release build (only on main branch or tags)
  build-release:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@just

      - name: Install native libtorrent dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libtorrent-rasterbar-dev pkg-config

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-
            ${{ runner.os }}-cargo-

      - name: Build Release
        run: just build-release

      - name: OpenAPI Spec
        run: just api-export

      - name: Generate SHA256 checksum
        run: sha256sum target/release/revaer-app > target/release/revaer-app.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: revaer-release-${{ github.sha }}
          path: |
            target/release/revaer-app
            target/release/revaer-app.sha256
            docs/api/openapi.json

  # Docker build and scan (only on main branch or tags)
  docker:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: taiki-e/install-action@just

      - name: Set image version tag
        run: |
          version=$(if [[ '${{ github.ref }}' == refs/tags/* ]]; then echo '${{ github.ref_name }}'; else echo dev.$(date -u +%y%m%d).${GITHUB_SHA::7}; fi)
          version_lower=$(echo "$version" | tr '[:upper:]' '[:lower:]')
          repo_lower=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
          echo "VERSION=$version_lower" >> "$GITHUB_ENV"
          echo "IMAGE_GHCR_TAG_VERSION=$repo_lower:$version_lower" >> "$GITHUB_ENV"
          echo "IMAGE_GHCR_TAG_LATEST=$repo_lower:latest" >> "$GITHUB_ENV"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ env.IMAGE_GHCR_TAG_VERSION }}
            ghcr.io/${{ env.IMAGE_GHCR_TAG_LATEST }}
